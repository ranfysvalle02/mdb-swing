{# Signal Hunter Stock Card Component - Optimized for Usability #}
<div class="glass-panel rounded-lg p-4 border transition-all duration-200 hover:scale-[1.01] hover:shadow-lg {% if stock.is_candidate %}border-green-500/60 bg-green-500/10 shadow-green-500/10{% else %}border-gray-700/50{% endif %}">
    {# Header Row: Symbol and Status #}
    <div class="flex items-center justify-between gap-3 mb-3 pb-3 border-b {% if stock.is_candidate %}border-green-500/20{% else %}border-gray-700/30{% endif %}">
        <div class="flex items-center gap-2.5">
            <span class="text-2xl font-mono font-bold text-white tracking-tight">{{ stock.symbol|e }}</span>
            {% if stock.is_candidate %}
            <span class="px-2.5 py-1 bg-green-500/25 text-green-300 text-xs font-bold rounded-md border border-green-500/60 flex items-center gap-1.5 shadow-sm shadow-green-500/20">
                <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                <span>CANDIDATE</span>
            </span>
            {% if stock.bounce_strength %}
            <span class="px-2.5 py-1 {% if stock.bounce_strength == 'Very Strong' %}bg-purple-500/25 text-purple-300 border-purple-500/60 shadow-purple-500/20{% elif stock.bounce_strength == 'Strong' %}bg-blue-500/25 text-blue-300 border-blue-500/60 shadow-blue-500/20{% else %}bg-yellow-500/25 text-yellow-300 border-yellow-500/60 shadow-yellow-500/20{% endif %} text-xs font-bold rounded-md border flex items-center gap-1.5 shadow-sm">
                <i data-lucide="zap" class="w-3.5 h-3.5"></i>
                <span>{{ stock.bounce_strength }}</span>
            </span>
            {% endif %}
            {% else %}
            <span class="px-2.5 py-1 bg-gray-500/15 text-gray-400 text-xs font-semibold rounded-md border border-gray-500/40 flex items-center gap-1.5">
                <i data-lucide="x-circle" class="w-3.5 h-3.5"></i>
                <span>Not Candidate</span>
            </span>
            {% endif %}
        </div>
        
        {# Quick Actions - Horizontal Layout #}
        <div class="flex items-center gap-2 flex-shrink-0">
            {% if stock.symbol in watchlist_symbols|default([]) %}
            {# Already in watchlist - Show remove button #}
            <button
                hx-post="/api/watch-list"
                hx-vals='{{ {"action": "remove", "symbol": stock.symbol} | tojson }}'
                hx-target="#watch-list"
                hx-swap="innerHTML"
                hx-confirm="Remove {{ stock.symbol|e }} from watchlist?"
                hx-on::after-request="
                    if(event.detail.successful) {
                        htmx.trigger('body', 'showToast', {
                            detail: {message: '{{ stock.symbol|e }} removed from watchlist', type: 'success'}
                        });
                        // Trigger refresh of signal hunter to update button
                        htmx.trigger('body', 'watchlistUpdated');
                    }
                "
                class="px-3 py-1.5 bg-red-500/20 hover:bg-red-500/30 text-red-300 text-xs font-semibold rounded-md border border-red-500/50 transition-all duration-200 flex items-center gap-1.5 hover:shadow-md hover:shadow-red-500/20">
                <i data-lucide="x" class="w-3.5 h-3.5"></i>
                <span>Remove</span>
            </button>
            {% else %}
            {# Not in watchlist - Show add button #}
            <button
                hx-post="/api/watch-list"
                hx-vals='{{ {"action": "add", "symbol": stock.symbol} | tojson }}'
                hx-target="#watch-list"
                hx-swap="innerHTML"
                hx-on::after-request="
                    if(event.detail.successful) {
                        htmx.trigger('body', 'showToast', {
                            detail: {message: '{{ stock.symbol|e }} added to watchlist', type: 'success'}
                        });
                        // Trigger refresh of signal hunter to update button
                        htmx.trigger('body', 'watchlistUpdated');
                    } else {
                        htmx.trigger('body', 'showToast', {
                            detail: {message: 'Failed to add {{ stock.symbol|e }}', type: 'error'}
                        });
                    }
                "
                class="px-3 py-1.5 bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 text-xs font-semibold rounded-md border border-purple-500/50 transition-all duration-200 flex items-center gap-1.5 hover:shadow-md hover:shadow-purple-500/20">
                <i data-lucide="plus" class="w-3.5 h-3.5"></i>
                <span>Watch</span>
            </button>
            {% endif %}
        </div>
    </div>
    
    {# Metrics Grid - Better Organized #}
    {% if stock.stats or stock.rsi is not none or stock.price %}
    <div class="grid grid-cols-3 gap-3 mb-3">
        {% if stock.price or (stock.stats and stock.stats.price) %}
        <div class="bg-gray-800/30 rounded-md p-2.5 border border-gray-700/30">
            <div class="text-[10px] text-gray-400 font-semibold uppercase tracking-wider mb-1">Price</div>
            <div class="text-lg font-mono font-bold text-white">${{ "%.2f"|format(stock.price or (stock.stats.price if stock.stats else 0)) }}</div>
        </div>
        {% endif %}
        
        {% if stock.rsi is not none %}
        <div class="bg-gray-800/30 rounded-md p-2.5 border {% if stock.rsi < 30 %}border-green-500/40 bg-green-500/5{% elif stock.rsi > 70 %}border-red-500/40 bg-red-500/5{% else %}border-gray-700/30{% endif %}">
            <div class="text-[10px] text-gray-400 font-semibold uppercase tracking-wider mb-1">RSI</div>
            <div class="text-lg font-mono font-bold {% if stock.rsi < 30 %}text-green-400{% elif stock.rsi > 70 %}text-red-400{% else %}text-white{% endif %}">{{ "%.1f"|format(stock.rsi) }}</div>
        </div>
        {% endif %}
        
        {% if stock.stats.trend or stock.trend %}
        <div class="bg-gray-800/30 rounded-md p-2.5 border {% if (stock.stats.trend or stock.trend) == 'UP' %}border-green-500/40 bg-green-500/5{% else %}border-red-500/40 bg-red-500/5{% endif %}">
            <div class="text-[10px] text-gray-400 font-semibold uppercase tracking-wider mb-1">Trend</div>
            <div class="text-lg font-mono font-bold flex items-center gap-1 {% if (stock.stats.trend or stock.trend) == 'UP' %}text-green-400{% else %}text-red-400{% endif %}">
                {% if (stock.stats.trend or stock.trend) == 'UP' %}
                <i data-lucide="trending-up" class="w-4 h-4"></i>
                <span>UP</span>
                {% else %}
                <i data-lucide="trending-down" class="w-4 h-4"></i>
                <span>DOWN</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    {# Additional Metrics Row #}
    {% if stock.sma_200 or stock.price_vs_sma_200_pct %}
    <div class="flex flex-wrap items-center gap-2 mb-3 text-xs">
        {% if stock.sma_200 %}
        <div class="px-2 py-1 bg-gray-800/40 rounded border border-gray-700/30">
            <span class="text-gray-400">SMA-200:</span>
            <span class="text-white font-mono font-semibold ml-1">${{ "%.2f"|format(stock.sma_200) }}</span>
        </div>
        {% endif %}
        {% if stock.price_vs_sma_200_pct is not none %}
        <div class="px-2 py-1 bg-gray-800/40 rounded border border-gray-700/30">
            <span class="text-gray-400">vs SMA:</span>
            <span class="text-white font-mono font-semibold ml-1 {% if stock.price_vs_sma_200_pct > 0 %}text-green-400{% else %}text-red-400{% endif %}">
                {{ '+' if stock.price_vs_sma_200_pct > 0 else '' }}{{ "%.2f"|format(stock.price_vs_sma_200_pct) }}%
            </span>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    {# Rejection Reasons - Improved Readability #}
    {% if not stock.is_candidate and stock.rejection_reasons %}
    <div class="mt-3 p-3 rounded-lg bg-red-500/10 border border-red-500/40">
        <div class="text-xs text-red-300 font-bold mb-2 flex items-center gap-1.5">
            <i data-lucide="alert-circle" class="w-3.5 h-3.5"></i>
            <span>Why Not a Candidate:</span>
        </div>
        <ul class="text-xs text-red-200/90 space-y-1.5">
            {% for reason in stock.rejection_reasons[:4] %}
            <li class="flex items-start gap-2">
                <span class="text-red-400 mt-0.5 flex-shrink-0">â€¢</span>
                <span class="leading-relaxed">{{ reason|e }}</span>
            </li>
            {% endfor %}
            {% if stock.rejection_reasons|length > 4 %}
            <li class="text-red-300/70 italic text-[11px] pt-1">
                + {{ stock.rejection_reasons|length - 4 }} more reason{{ 's' if (stock.rejection_reasons|length - 4) != 1 else '' }}
            </li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
    
    {# Error State #}
    {% if stock.error %}
    <div class="mt-3 p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/40">
        <div class="text-xs text-yellow-300 flex items-center gap-2 font-semibold">
            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
            <span>{{ stock.error|e }}</span>
        </div>
    </div>
    {% endif %}
    
    {# Action Buttons - Below metrics #}
    <div class="mt-3 pt-3 border-t {% if stock.is_candidate %}border-green-500/20{% else %}border-gray-700/30{% endif %} space-y-2">
        {# Analyze Button #}
        <button
            hx-post="/api/analyze"
            hx-vals='{{ {"ticker": stock.symbol} | tojson }}'
            hx-target="#modal-container"
            hx-swap="beforeend"
            class="w-full py-2.5 rounded-lg text-xs font-semibold text-white hover:bg-blue-600/30 transition-all bg-blue-500/30 flex items-center justify-center gap-2 border border-blue-500/50">
            <i data-lucide="eye" class="w-3.5 h-3.5"></i>
            <span>Analyze</span>
        </button>
        
    </div>
</div>
