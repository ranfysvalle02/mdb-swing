{# Custom Filter Builder Component #}
<div id="custom-filter-builder" class="space-y-4" x-data="customFilterBuilder()" x-init="init()">
    {# Header #}
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-semibold text-gray-300 flex items-center gap-2">
            <i data-lucide="sliders-horizontal" class="w-4 h-4 text-purple-400"></i>
            <span>Build Your Filter</span>
        </h3>
        <button
            @click="addFilter()"
            class="px-3 py-1.5 bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 text-xs font-semibold rounded-md border border-purple-500/50 transition-all flex items-center gap-1.5">
            <i data-lucide="plus" class="w-3.5 h-3.5"></i>
            <span>Add Filter</span>
        </button>
    </div>
    
    {# Filters List #}
    <div class="space-y-3" id="filters-list">
        <template x-for="(filter, index) in filters" :key="index">
            <div class="glass rounded-lg p-3 border border-gray-700/50 bg-gray-800/30">
                <div class="flex items-start gap-3">
                    {# Filter Name Select #}
                    <div class="flex-1">
                        <label class="block text-xs text-gray-400 mb-1.5">Filter Type</label>
                        <select
                            x-model="filter.name"
                            @change="onFilterChange(index)"
                            class="w-full px-3 py-2 bg-gray-900/50 border border-gray-700/50 rounded-md text-sm text-white focus:outline-none focus:border-purple-500/50 focus:ring-1 focus:ring-purple-500/50">
                            <option value="">Select filter...</option>
                            <template x-for="(options, filterName) in availableFilters" :key="filterName">
                                <option :value="filterName" x-text="filterName"></option>
                            </template>
                        </select>
                    </div>
                    
                    {# Filter Value Select #}
                    <div class="flex-1" x-show="filter.name && availableFilters[filter.name]">
                        <label class="block text-xs text-gray-400 mb-1.5">Value</label>
                        <select
                            x-model="filter.value"
                            @change="updateFiltersInput()"
                            class="w-full px-3 py-2 bg-gray-900/50 border border-gray-700/50 rounded-md text-sm text-white focus:outline-none focus:border-purple-500/50 focus:ring-1 focus:ring-purple-500/50">
                            <option value="">Select value...</option>
                            <template x-for="option in (availableFilters[filter.name] || [])" :key="option">
                                <option :value="option" x-text="option"></option>
                            </template>
                        </select>
                    </div>
                    
                    {# Remove Button #}
                    <div class="pt-6">
                        <button
                            @click="removeFilter(index)"
                            class="p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-md transition-all"
                            title="Remove filter">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </template>
        
        {# Empty State #}
        <div x-show="filters.length === 0" class="text-center py-8 border-2 border-dashed border-gray-700/50 rounded-lg">
            <i data-lucide="filter" class="w-8 h-8 text-gray-600 mx-auto mb-2"></i>
            <p class="text-sm text-gray-400 mb-1">No filters added yet</p>
            <p class="text-xs text-gray-500">Click "Add Filter" to start building your custom filter</p>
        </div>
    </div>
    
    {# Active Filters Preview #}
    <div x-show="filters.length > 0" class="mt-4 p-3 bg-purple-500/10 border border-purple-500/30 rounded-lg">
        <div class="flex items-center gap-2 mb-2">
            <i data-lucide="eye" class="w-4 h-4 text-purple-400"></i>
            <span class="text-xs font-semibold text-purple-300">Active Filters Preview</span>
        </div>
        <div class="space-y-1.5 max-h-32 overflow-y-auto">
            <template x-for="(filter, index) in filters" :key="index">
                <div x-show="filter.name && filter.value" class="flex items-center justify-between text-xs">
                    <span class="text-gray-400" x-text="filter.name"></span>
                    <span class="text-purple-300 font-medium" x-text="filter.value"></span>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
function customFilterBuilder() {
    return {
        filters: [],
        availableFilters: {},
        
        async init() {
            // Load available filter options
            try {
                console.log('[CUSTOM_FILTER_BUILDER] Loading filter options...');
                const response = await fetch('/api/finviz-filters?type=overview');
                const data = await response.json();
                if (data.success && data.filters) {
                    this.availableFilters = data.filters;
                    console.log('[CUSTOM_FILTER_BUILDER] Loaded', Object.keys(data.filters).length, 'filter types');
                } else {
                    console.warn('[CUSTOM_FILTER_BUILDER] Failed to load filters:', data);
                }
            } catch (error) {
                console.error('[CUSTOM_FILTER_BUILDER] Failed to load filter options:', error);
            }
            
            // Initialize lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Add one empty filter by default
            if (this.filters.length === 0) {
                this.addFilter();
            }
        },
        
        addFilter() {
            this.filters.push({ name: '', value: '' });
            // Re-initialize icons after DOM update
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        },
        
        removeFilter(index) {
            this.filters.splice(index, 1);
            this.updateFiltersInput();
        },
        
        onFilterChange(index) {
            // Clear value when filter name changes
            this.filters[index].value = '';
            this.updateFiltersInput();
        },
        
        updateFiltersInput() {
            // Build filters dict
            const filtersDict = {};
            this.filters.forEach(filter => {
                if (filter.name && filter.value) {
                    filtersDict[filter.name] = filter.value;
                }
            });
            
            // Update hidden input
            const jsonInput = document.getElementById('filters-json-input');
            if (jsonInput) {
                jsonInput.value = JSON.stringify(filtersDict);
            }
            
            // Update preset input to CUSTOM
            const presetInput = document.getElementById('preset-name-input');
            if (presetInput) {
                presetInput.value = 'CUSTOM';
            }
            
            // Update active filters display
            this.updateActiveFiltersDisplay(filtersDict);
            
            // Log for debugging
            console.debug('[CUSTOM_FILTER_BUILDER] Updated filters:', filtersDict);
        },
        
        updateActiveFiltersDisplay(filtersDict) {
            const displayDiv = document.getElementById('active-filters-display');
            const filtersContainer = displayDiv ? displayDiv.querySelector('.bg-gray-800\\/30') : null;
            
            if (filtersContainer) {
                if (Object.keys(filtersDict).length === 0) {
                    filtersContainer.innerHTML = '<div class="text-xs text-gray-500 text-center py-2">No active filters</div>';
                } else {
                    filtersContainer.innerHTML = Object.entries(filtersDict).map(([key, value]) => {
                        return '<div class="flex items-center justify-between text-xs">' +
                            '<span class="text-gray-400">' + key + ':</span>' +
                            '<span class="text-purple-300 font-medium">' + value + '</span>' +
                            '</div>';
                    }).join('');
                }
            }
        },
        
        getFiltersDict() {
            const filtersDict = {};
            this.filters.forEach(filter => {
                if (filter.name && filter.value) {
                    filtersDict[filter.name] = filter.value;
                }
            });
            return filtersDict;
        }
    }
}

// Watch for filter changes - Alpine.js will handle reactivity
// The @change handlers in the template will call updateFiltersInput()
</script>
