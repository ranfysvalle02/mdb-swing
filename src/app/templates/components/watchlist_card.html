{% if error is defined and error %}
{# ERROR CARD - Show error state #}
<div class="ticker-card watchlist-card watchlist-card-error watchlist-interactive-element glass-panel rounded-lg p-3 border border-red-500/30 bg-red-500/5 group transition-all relative cursor-default min-w-[20rem] min-h-[11.25rem]" 
     data-symbol="{{ symbol|e }}"
     data-meets-criteria="false"
     data-error="true"
     role="listitem"
     aria-label="Ticker {{ symbol|e }} - error loading data">
    <div class="flex items-center justify-between gap-2 mb-2">
        <span class="text-lg font-mono font-bold text-white">{{ symbol|e }}</span>
        <div class="flex items-center gap-2">
            <button 
                hx-get="/api/watch-list"
                hx-target="#watch-list"
                hx-swap="innerHTML"
                hx-indicator="#watchlist-loading-overlay"
                class="retry-symbol-btn flex items-center gap-1 px-2 py-1 rounded-md bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-300 text-xs font-medium border border-cyan-500/30 transition-all"
                title="Retry loading {{ symbol|e }}"
                aria-label="Retry loading {{ symbol|e }}">
                <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                <span>Retry</span>
            </button>
            <button 
                hx-post="/api/watch-list"
                hx-vals='{{ {"action": "remove", "symbol": symbol} | tojson | e }}'
                hx-confirm="Remove {{ symbol|e }} from watch list?"
                hx-target="#watch-list"
                hx-swap="innerHTML"
                hx-indicator="#watchlist-loading-overlay"
                class="remove-ticker-btn flex items-center justify-center w-8 h-8 rounded-lg bg-red-500/80 hover:bg-red-500 text-white border border-red-400/50 shadow-md hover:shadow-lg transition-all focus:ring-2 focus:ring-red-500/50 focus:outline-none group/remove"
                title="Remove {{ symbol|e }} from watch list"
                aria-label="Remove {{ symbol|e }} from watch list">
                <i data-lucide="x" class="w-4 h-4 group-hover/remove:scale-110 transition-transform" aria-hidden="true"></i>
            </button>
        </div>
    </div>
    <div class="flex items-center gap-2 px-2 py-2 rounded-md bg-red-500/10 border border-red-500/30">
        <i data-lucide="alert-circle" class="w-4 h-4 text-red-400 flex-shrink-0"></i>
        <div class="flex-1 min-w-0">
            <div class="text-xs font-semibold text-red-300 mb-0.5">Error loading data</div>
            <div class="text-xs text-red-400/80 line-clamp-2">{{ error|e }}</div>
        </div>
    </div>
</div>
{% elif price is not none or rsi is not none %}
{# CANDIDATE CARD - Meets Criteria #}
{% if meets_criteria %}
<div class="ticker-card watchlist-card watchlist-card-candidate watchlist-interactive-element glass-panel rounded-xl p-2 border-2 border-green-500/60 bg-gradient-to-br from-green-500/25 via-green-500/15 to-green-500/10 shadow-lg shadow-green-500/40 group transition-all relative min-w-[20rem] min-h-[11.25rem] flex flex-col" 
     data-symbol="{{ symbol|e }}"
     data-meets-criteria="true"
     data-price="{{ price if price else '' }}"
     data-rsi="{{ rsi if rsi is not none else '' }}"
     data-trend="{{ trend if trend else '' }}"
     role="listitem"
     aria-label="{{ symbol|e }} candidate - Ready to buy">
    
    <!-- Header: Symbol, Price, Actions -->
    <div class="mb-1">
        <div class="flex items-start justify-between gap-2 mb-0.5">
            <div class="flex items-baseline gap-2 flex-1 min-w-0">
                <span class="text-4xl font-mono font-bold text-green-200 leading-none">{{ symbol|e }}</span>
                {% if price %}
                <span class="text-3xl font-bold text-white leading-none">${{ "%.2f"|format(price) }}</span>
                {% endif %}
            </div>
            
            <!-- Header Actions: Remove Button -->
            <div class="flex items-center gap-1.5 flex-shrink-0">
                <!-- Remove Button -->
                <button 
                    hx-post="/api/watch-list"
                    hx-vals='{{ {"action": "remove", "symbol": symbol} | tojson }}'
                    hx-confirm="Remove {{ symbol|e }} from watch list?"
                    hx-target="#watch-list"
                    hx-swap="innerHTML"
                    hx-indicator="#watchlist-loading-overlay"
                    hx-on:click="event.stopPropagation()"
                    class="remove-ticker-btn watchlist-interactive-element flex items-center justify-center w-8 h-8 rounded-lg bg-red-500/80 hover:bg-red-500 text-white border border-red-400/50 shadow-md hover:shadow-lg transition-all focus:ring-2 focus:ring-red-500/50 focus:outline-none group/remove"
                    title="Remove {{ symbol|e }} from watch list"
                    aria-label="Remove {{ symbol|e }} from watch list">
                    <i data-lucide="x" class="w-4 h-4 group-hover/remove:scale-110 transition-transform" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics Grid (2x2) -->
    <div class="grid grid-cols-2 gap-1 mb-1">
        {% if rsi is not none %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-green-500/20 border border-green-400/30">
            <i data-lucide="activity" class="w-4 h-4 text-green-400"></i>
            <div>
                <div class="text-xs text-green-300/70 uppercase font-semibold">RSI</div>
                <div class="text-sm text-green-200 font-bold">{{ rsi|int }}</div>
            </div>
        </div>
        {% endif %}
        
        {% if trend %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-green-500/20 border border-green-400/30">
            <i data-lucide="{{ trend_icon }}" class="w-4 h-4 {{ trend_color }}"></i>
            <div>
                <div class="text-xs text-green-300/70 uppercase font-semibold">Trend</div>
                <div class="text-sm {{ trend_color }} font-bold">{{ trend }}</div>
            </div>
        </div>
        {% endif %}
        
        {% if atr %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-green-500/20 border border-green-400/30">
            <i data-lucide="trending-up" class="w-4 h-4 text-green-400"></i>
            <div>
                <div class="text-xs text-green-300/70 uppercase font-semibold">ATR</div>
                <div class="text-sm text-green-200 font-bold">${{ "%.2f"|format(atr) }}</div>
            </div>
        </div>
        {% endif %}
        
        {% if volume %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-green-500/20 border border-green-400/30">
            <i data-lucide="bar-chart-3" class="w-4 h-4 text-green-400"></i>
            <div>
                <div class="text-xs text-green-300/70 uppercase font-semibold">Volume</div>
                <div class="text-sm text-green-200 font-bold">
                    {% if volume >= 1_000_000 %}
                        {{ "%.1f"|format(volume / 1_000_000) }}M
                    {% elif volume >= 1_000 %}
                        {{ "%.1f"|format(volume / 1_000) }}K
                    {% else %}
                        {{ "%.0f"|format(volume) }}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Additional Stats Grid -->
    <div class="grid grid-cols-2 gap-1 mb-1">
        {% if pe_ratio %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-green-500/20 border border-green-400/30">
            <i data-lucide="dollar-sign" class="w-3.5 h-3.5 text-green-400"></i>
            <div class="flex-1 min-w-0">
                <div class="text-xs text-green-300/70 uppercase font-semibold">P/E</div>
                <div class="text-sm text-green-200 font-bold">{{ "%.1f"|format(pe_ratio) }}</div>
            </div>
        </div>
        {% endif %}
        
        {% if market_cap %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-green-500/20 border border-green-400/30">
            <i data-lucide="building-2" class="w-3.5 h-3.5 text-green-400"></i>
            <div class="flex-1 min-w-0">
                <div class="text-xs text-green-300/70 uppercase font-semibold">Market Cap</div>
                <div class="text-sm text-green-200 font-bold">
                    {% if market_cap >= 1_000_000_000 %}
                        ${{ "%.1f"|format(market_cap / 1_000_000_000) }}B
                    {% elif market_cap >= 1_000_000 %}
                        ${{ "%.0f"|format(market_cap / 1_000_000) }}M
                    {% else %}
                        ${{ "%.0f"|format(market_cap / 1_000) }}K
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if earnings_in_days is not none %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md {% if earnings_in_days < 7 %}bg-yellow-500/20 border-yellow-400/30{% else %}bg-green-500/20 border-green-400/30{% endif %}">
            <i data-lucide="calendar" class="w-3.5 h-3.5 {% if earnings_in_days < 7 %}text-yellow-400{% else %}text-green-400{% endif %}"></i>
            <div class="flex-1 min-w-0">
                <div class="text-xs {% if earnings_in_days < 7 %}text-yellow-300/70{% else %}text-green-300/70{% endif %} uppercase font-semibold">Earnings</div>
                <div class="text-sm {% if earnings_in_days < 7 %}text-yellow-200{% else %}text-green-200{% endif %} font-bold">
                    {% if earnings_in_days == 0 %}Today{% elif earnings_in_days == 1 %}Tomorrow{% else %}{{ earnings_in_days }}d{% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- SMA-200 Comparison Section -->
    {% if sma_200 and price %}
    <div class="mt-1.5 pt-1.5 border-t border-green-400/20">
        <div class="rounded-lg p-2.5 border h-16 flex items-center {% if price_vs_sma_pct is not none and price_vs_sma_pct <= sma_proximity_pct|default(3.0) and price >= sma_200 %}border-green-500/30 bg-green-500/10{% elif price >= sma_200 %}border-blue-500/30 bg-blue-500/10{% else %}border-gray-700/50 bg-gray-800/30{% endif %}">
            <div class="flex items-center gap-2 flex-shrink-0">
                <i data-lucide="trending-up" class="text-blue-400 w-3.5 h-3.5 flex-shrink-0"></i>
                <span class="text-xs text-gray-400 font-semibold whitespace-nowrap">SMA-200</span>
            </div>
            <div class="flex-1 min-w-0 ml-3 flex flex-col items-end justify-center gap-0.5 text-right">
                <div class="text-sm font-bold text-white leading-tight whitespace-nowrap">${{ "%.2f"|format(sma_200) }}</div>
                {% if price_vs_sma_pct is not none %}
                <div class="text-xs leading-tight {% if price_vs_sma_pct <= sma_proximity_pct|default(3.0) and price >= sma_200 %}text-green-400 font-semibold{% elif price >= sma_200 %}text-blue-400{% else %}text-red-400{% endif %}">
                    <div class="whitespace-normal break-words max-w-full">
                        Price is {{ price_vs_sma_pct|round(1) }}% above SMA-200
                        {% if price >= sma_200 %}
                            {% if price_vs_sma_pct <= sma_proximity_pct|default(3.0) %}
                                <span class="block text-green-300 mt-0.5">✓ Within {{ sma_proximity_pct|default(3.0) }}% proximity</span>
                            {% else %}
                                <span class="block text-yellow-400 mt-0.5">⚠ Exceeds {{ sma_proximity_pct|default(3.0) }}% limit</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- News Feed Section - Professional Financial News Preview -->
    {% if headlines is defined and headlines and headlines|length > 0 %}
    <div class="mt-1.5 pt-1.5 {% if sma_200 and price %}border-t border-green-400/20{% else %}border-t border-green-400/20{% endif %}">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-1.5">
                <i data-lucide="newspaper" class="w-3.5 h-3.5 text-green-300/70"></i>
                <span class="text-xs text-green-300/80 uppercase font-bold tracking-wide">Market News</span>
                <span class="text-[10px] text-green-300/50 font-normal">({{ headlines|length }})</span>
            </div>
            <span class="text-[10px] text-green-300/40 italic">AI Analysis Preview</span>
        </div>
        <!-- Professional news feed container with better spacing -->
        <div class="max-h-[8.75rem] overflow-y-auto overflow-x-hidden space-y-1.5 pr-1 custom-scrollbar">
            {% for headline in headlines %}
            {% set title_text = headline.get('title', headline.get('text', '')) %}
            {% set summary_text = headline.get('summary', headline.get('text', '')) %}
            {% set display_text = summary_text if summary_text else title_text %}
            {% set headline_url = headline.get('url') %}
            
            {% if headline_url %}
            <a href="{{ headline_url|e }}" target="_blank" rel="noopener noreferrer" 
               class="group/news-item block relative px-2.5 py-2 rounded-lg bg-green-500/8 border border-green-400/15 hover:bg-green-500/15 hover:border-green-400/30 transition-all duration-200 cursor-pointer overflow-hidden"
               onclick="event.stopPropagation()"
               title="{{ title_text|e if title_text else display_text|e }}">
                <!-- News item content -->
                <div class="flex items-start gap-2">
                    <!-- News indicator dot -->
                    <div class="flex-shrink-0 w-1.5 h-1.5 rounded-full bg-green-400/60 mt-1.5 group-hover/news-item:bg-green-400 transition-colors"></div>
                    
                    <!-- Text content -->
                    <div class="flex-1 min-w-0 space-y-0.5">
                        {% if title_text and summary_text and title_text != summary_text %}
                        <!-- Show title as bold headline, summary as description -->
                        <div class="text-[11px] font-semibold text-green-200/90 leading-tight line-clamp-1 group-hover/news-item:text-green-100 transition-colors">
                            {{ title_text|e }}
                        </div>
                        <div class="text-[10px] text-green-300/70 leading-relaxed line-clamp-2 group-hover/news-item:text-green-300/90 transition-colors">
                            {{ summary_text|e }}
                        </div>
                        {% else %}
                        <!-- Single line display when no separate title/summary -->
                        <div class="text-[11px] text-green-200/85 leading-relaxed line-clamp-2 group-hover/news-item:text-green-100 transition-colors">
                            {{ display_text|e }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- External link icon -->
                    <i data-lucide="external-link" class="w-3 h-3 text-green-400/40 group-hover/news-item:text-green-300 flex-shrink-0 mt-0.5 opacity-0 group-hover/news-item:opacity-100 transition-all duration-200"></i>
                </div>
                
                <!-- Hover effect overlay -->
                <div class="absolute inset-0 bg-gradient-to-r from-green-500/0 via-green-500/0 to-green-500/5 opacity-0 group-hover/news-item:opacity-100 transition-opacity pointer-events-none"></div>
            </a>
            {% elif display_text %}
            <!-- News item without URL -->
            <div class="px-2.5 py-2 rounded-lg bg-green-500/8 border border-green-400/15">
                <div class="flex items-start gap-2">
                    <div class="flex-shrink-0 w-1.5 h-1.5 rounded-full bg-green-400/40 mt-1.5"></div>
                    <div class="flex-1 min-w-0">
                        {% if title_text and summary_text and title_text != summary_text %}
                        <div class="text-[11px] font-semibold text-green-200/80 leading-tight line-clamp-1">
                            {{ title_text|e }}
                        </div>
                        <div class="text-[10px] text-green-300/60 leading-relaxed line-clamp-2">
                            {{ summary_text|e }}
                        </div>
                        {% else %}
                        <div class="text-[11px] text-green-200/75 leading-relaxed line-clamp-2">
                            {{ display_text|e }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Action Buttons - Always at bottom -->
    <div class="mt-auto pt-2 pb-2 space-y-1.5 {% if sma_200 and price %}border-t border-green-400/30{% elif headlines is defined and headlines %}border-t border-green-400/30{% else %}border-t border-green-400/30{% endif %}">
        <!-- VIEW ALL STATS Button -->
        <button 
            hx-post="/api/all-stats"
            hx-vals='{{ {"ticker": symbol} | tojson }}'
            hx-target="#modal-container"
            hx-swap="innerHTML"
            hx-disabled-elt="this"
            hx-indicator="#view-stats-indicator-{{ symbol|lower }}"
            hx-on::htmx:after-swap="if(typeof lucide !== 'undefined') lucide.createIcons()"
            onclick="event.stopPropagation()"
            class="w-full py-2 rounded-lg text-xs font-semibold text-white hover:bg-blue-600/30 transition-all duration-300 bg-blue-500/30 flex items-center justify-center gap-2 border border-blue-500/50 hover:border-blue-400 hover:scale-[1.02] hover:shadow-lg hover:shadow-blue-500/30 active:scale-[0.98] group disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:hover:shadow-lg disabled:hover:bg-blue-500/30">
            <span id="view-stats-indicator-{{ symbol|lower }}" class="htmx-indicator">
                <i data-lucide="loader-2" class="w-3.5 h-3.5 lucide-spin"></i>
            </span>
            <i data-lucide="bar-chart-3" class="w-3.5 h-3.5 htmx-indicator-hidden group-hover:scale-110 transition-transform duration-300"></i>
            <span class="htmx-indicator-hidden">VIEW ALL STATS</span>
            <span class="htmx-indicator">Loading Stats...</span>
        </button>
        
        <!-- Analyze with AI Button -->
        <button 
            hx-post="/api/analyze"
            hx-vals='{{ {"ticker": symbol} | tojson }}'
            hx-target="#modal-container"
            hx-swap="innerHTML"
            hx-headers='{"HX-Target": "modal-container"}'
            hx-timeout="65000"
            hx-disabled-elt="this"
            hx-indicator="#analyze-ai-indicator-{{ symbol|lower }}"
            hx-on::htmx:after-swap="if(typeof lucide !== 'undefined') lucide.createIcons()"
            hx-on::htmx:response-error="this.innerHTML='<div class=\'p-4 text-red-400\'><i data-lucide=\'alert-circle\' class=\'w-5 h-5 inline-block\'></i> Error: Failed to analyze. Please try again.</div>'; if(typeof lucide !== 'undefined') lucide.createIcons()"
            hx-on::htmx:before-request="event.stopPropagation()"
            onclick="event.stopPropagation(); return false;"
            class="w-full py-2.5 rounded-lg text-xs font-bold text-white hover:bg-purple-600/30 transition-all bg-purple-500/30 flex items-center justify-center gap-2 border border-purple-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="analyze-ai-indicator-{{ symbol|lower }}" class="htmx-indicator">
                <i data-lucide="loader-2" class="w-3.5 h-3.5 lucide-spin"></i>
            </span>
            <i data-lucide="sparkles" class="w-3.5 h-3.5 htmx-indicator-hidden"></i>
            <span class="htmx-indicator-hidden">Analyze with AI</span>
            <span class="htmx-indicator">Analyzing...</span>
        </button>
        
        <!-- Buy Button - Opens Modal via HTMX -->
        <div x-on:click.stop>
            <button 
                hx-post="/api/buy-confirmation"
                hx-vals='{{ {"symbol": symbol} | tojson }}'
                hx-target="#modal-container"
                hx-swap="beforeend"
                class="w-full py-2.5 rounded-lg text-xs font-bold text-white hover:bg-green-600/40 transition-all duration-300 bg-green-500/40 flex items-center justify-center gap-2 border-2 border-green-400/60 hover:border-green-300 hover:scale-[1.02] hover:shadow-lg hover:shadow-green-500/40 active:scale-[0.98]">
                <i data-lucide="shopping-cart" class="w-3.5 h-3.5"></i>
                <span>BUY</span>
            </button>
        </div>
    </div>
</div>

{# NON-CANDIDATE CARD - Doesn't Meet Criteria #}
{% else %}
<div class="ticker-card watchlist-card watchlist-card-non-candidate watchlist-interactive-element glass-panel rounded-xl p-2 border border-gray-600/40 bg-gradient-to-br from-gray-800/30 to-gray-900/30 group transition-all relative min-w-[20rem] min-h-[11.25rem] flex flex-col" 
     data-symbol="{{ symbol|e }}"
     data-meets-criteria="false"
     data-price="{{ price if price else '' }}"
     data-rsi="{{ rsi if rsi is not none else '' }}"
     data-trend="{{ trend if trend else '' }}"
     data-rejection-reason="{{ (rejection_reason|e if rejection_reason else '') if not meets_criteria else '' }}"
     role="listitem"
     aria-label="View details for {{ symbol|e }}">
    
    <!-- Header: Symbol, Price, Actions -->
    <div class="mb-1">
        <div class="flex items-start justify-between gap-2 mb-0.5">
            <div class="flex items-baseline gap-2 flex-1 min-w-0">
                <span class="text-4xl font-mono font-bold text-gray-300 leading-none">{{ symbol|e }}</span>
                {% if price %}
                <span class="text-3xl font-bold text-white leading-none">${{ "%.2f"|format(price) }}</span>
                {% endif %}
            </div>
            
            <!-- Remove Button -->
            <button 
                hx-post="/api/watch-list"
                hx-vals='{{ {"action": "remove", "symbol": symbol} | tojson }}'
                hx-confirm="Remove {{ symbol|e }} from watch list?"
                hx-target="#watch-list"
                hx-swap="innerHTML"
                hx-indicator="#watchlist-loading-overlay"
                hx-on:click="event.stopPropagation()"
                class="remove-ticker-btn flex items-center justify-center w-8 h-8 rounded-lg bg-red-500/80 hover:bg-red-500 text-white border border-red-400/50 shadow-md hover:shadow-lg transition-all focus:ring-2 focus:ring-red-500/50 focus:outline-none group/remove flex-shrink-0"
                title="Remove {{ symbol|e }} from watch list"
                aria-label="Remove {{ symbol|e }} from watch list">
                <i data-lucide="x" class="w-4 h-4 group-hover/remove:scale-110 transition-transform" aria-hidden="true"></i>
            </button>
        </div>
    </div>
    
    <!-- Key Metrics Grid (2x2) -->
    <div class="grid grid-cols-2 gap-1 mb-1">
        {% if rsi is not none %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md {% if rsi < rsi_threshold|default(35) %}bg-yellow-500/20 border-yellow-400/30{% else %}bg-gray-800/40 border-gray-700/50{% endif %}">
            <i data-lucide="activity" class="w-4 h-4 {% if rsi < rsi_threshold|default(35) %}text-yellow-400{% else %}text-gray-400{% endif %}"></i>
            <div>
                <div class="text-xs {% if rsi < rsi_threshold|default(35) %}text-yellow-300/70{% else %}text-gray-500{% endif %} uppercase font-semibold">RSI</div>
                <div class="text-sm {% if rsi < rsi_threshold|default(35) %}text-yellow-200{% else %}text-gray-300{% endif %} font-bold">{{ rsi|int }}</div>
            </div>
        </div>
        {% endif %}
        
        {% if trend %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-gray-800/40 border border-gray-700/50">
            <i data-lucide="{{ trend_icon }}" class="w-4 h-4 {{ trend_color }}"></i>
            <div>
                <div class="text-xs text-gray-500 uppercase font-semibold">Trend</div>
                <div class="text-sm {{ trend_color }} font-bold">{{ trend }}</div>
            </div>
        </div>
        {% endif %}
        
        {% if atr %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-gray-800/40 border border-gray-700/50">
            <i data-lucide="trending-up" class="w-4 h-4 text-gray-400"></i>
            <div>
                <div class="text-xs text-gray-500 uppercase font-semibold">ATR</div>
                <div class="text-sm text-gray-300 font-bold">${{ "%.2f"|format(atr) }}</div>
            </div>
        </div>
        {% endif %}
        
        {% if volume %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-gray-800/40 border border-gray-700/50">
            <i data-lucide="bar-chart-3" class="w-4 h-4 text-gray-400"></i>
            <div>
                <div class="text-xs text-gray-500 uppercase font-semibold">Volume</div>
                <div class="text-sm text-gray-300 font-bold">
                    {% if volume >= 1_000_000 %}
                        {{ "%.1f"|format(volume / 1_000_000) }}M
                    {% elif volume >= 1_000 %}
                        {{ "%.1f"|format(volume / 1_000) }}K
                    {% else %}
                        {{ "%.0f"|format(volume) }}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Additional Stats Grid -->
    <div class="grid grid-cols-2 gap-1 mb-1">
        {% if pe_ratio %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-gray-800/40 border border-gray-700/50">
            <i data-lucide="dollar-sign" class="w-3.5 h-3.5 text-gray-400"></i>
            <div class="flex-1 min-w-0">
                <div class="text-xs text-gray-500 uppercase font-semibold">P/E</div>
                <div class="text-sm text-gray-300 font-bold">{{ "%.1f"|format(pe_ratio) }}</div>
            </div>
        </div>
        {% endif %}
        
        {% if market_cap %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-gray-800/40 border border-gray-700/50">
            <i data-lucide="building-2" class="w-3.5 h-3.5 text-gray-400"></i>
            <div class="flex-1 min-w-0">
                <div class="text-xs text-gray-500 uppercase font-semibold">Market Cap</div>
                <div class="text-sm text-gray-300 font-bold">
                    {% if market_cap >= 1_000_000_000 %}
                        ${{ "%.1f"|format(market_cap / 1_000_000_000) }}B
                    {% elif market_cap >= 1_000_000 %}
                        ${{ "%.0f"|format(market_cap / 1_000_000) }}M
                    {% else %}
                        ${{ "%.0f"|format(market_cap / 1_000) }}K
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if earnings_in_days is not none %}
        <div class="flex items-center gap-1.5 px-2 py-1 rounded-md {% if earnings_in_days < 7 %}bg-yellow-500/20 border-yellow-400/30{% else %}bg-gray-800/40 border-gray-700/50{% endif %}">
            <i data-lucide="calendar" class="w-3.5 h-3.5 {% if earnings_in_days < 7 %}text-yellow-400{% else %}text-gray-400{% endif %}"></i>
            <div class="flex-1 min-w-0">
                <div class="text-xs {% if earnings_in_days < 7 %}text-yellow-300/70{% else %}text-gray-500{% endif %} uppercase font-semibold">Earnings</div>
                <div class="text-sm {% if earnings_in_days < 7 %}text-yellow-200{% else %}text-gray-300{% endif %} font-bold">
                    {% if earnings_in_days == 0 %}Today{% elif earnings_in_days == 1 %}Tomorrow{% else %}{{ earnings_in_days }}d{% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- SMA-200 Comparison Section -->
    {% if sma_200 and price %}
    <div class="mt-1.5 pt-1.5 border-t border-gray-700/30">
        <div class="rounded-lg p-2.5 border h-16 flex items-center {% if price_vs_sma_pct is not none and price_vs_sma_pct <= sma_proximity_pct|default(3.0) and price >= sma_200 %}border-green-500/30 bg-green-500/10{% elif price >= sma_200 %}border-blue-500/30 bg-blue-500/10{% else %}border-gray-700/50 bg-gray-800/30{% endif %}">
            <div class="flex items-center gap-2 flex-shrink-0">
                <i data-lucide="trending-up" class="text-blue-400 w-3.5 h-3.5 flex-shrink-0"></i>
                <span class="text-xs text-gray-400 font-semibold whitespace-nowrap">SMA-200</span>
            </div>
            <div class="flex-1 min-w-0 ml-3 flex flex-col items-end justify-center gap-0.5 text-right">
                <div class="text-sm font-bold text-white leading-tight whitespace-nowrap">${{ "%.2f"|format(sma_200) }}</div>
                {% if price_vs_sma_pct is not none %}
                <div class="text-xs leading-tight {% if price_vs_sma_pct <= sma_proximity_pct|default(3.0) and price >= sma_200 %}text-green-400 font-semibold{% elif price >= sma_200 %}text-blue-400{% else %}text-red-400{% endif %}">
                    <div class="whitespace-normal break-words max-w-full">
                        Price is {{ price_vs_sma_pct|round(1) }}% above SMA-200
                        {% if price >= sma_200 %}
                            {% if price_vs_sma_pct <= sma_proximity_pct|default(3.0) %}
                                <span class="block text-green-300 mt-0.5">✓ Within {{ sma_proximity_pct|default(3.0) }}% proximity</span>
                            {% else %}
                                <span class="block text-yellow-400 mt-0.5">⚠ Exceeds {{ sma_proximity_pct|default(3.0) }}% limit</span>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- News Feed Section - Professional Financial News Preview -->
    {% if headlines is defined and headlines and headlines|length > 0 %}
    <div class="mt-1.5 pt-1.5 {% if sma_200 and price %}border-t border-gray-700/30{% else %}border-t border-gray-700/30{% endif %}">
        <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-1.5">
                <i data-lucide="newspaper" class="w-3.5 h-3.5 text-gray-400/70"></i>
                <span class="text-xs text-gray-400/80 uppercase font-bold tracking-wide">Market News</span>
                <span class="text-[10px] text-gray-400/50 font-normal">({{ headlines|length }})</span>
            </div>
            <span class="text-[10px] text-gray-400/40 italic">AI Analysis Preview</span>
        </div>
        <!-- Professional news feed container with better spacing -->
        <div class="max-h-[8.75rem] overflow-y-auto overflow-x-hidden space-y-1.5 pr-1 custom-scrollbar">
            {% for headline in headlines %}
            {% set title_text = headline.get('title', headline.get('text', '')) %}
            {% set summary_text = headline.get('summary', headline.get('text', '')) %}
            {% set display_text = summary_text if summary_text else title_text %}
            {% set headline_url = headline.get('url') %}
            
            {% if headline_url %}
            <a href="{{ headline_url|e }}" target="_blank" rel="noopener noreferrer" 
               class="group/news-item block relative px-2.5 py-2 rounded-lg bg-gray-800/30 border border-gray-700/40 hover:bg-gray-800/50 hover:border-gray-600/50 transition-all duration-200 cursor-pointer overflow-hidden"
               onclick="event.stopPropagation()"
               title="{{ title_text|e if title_text else display_text|e }}">
                <!-- News item content -->
                <div class="flex items-start gap-2">
                    <!-- News indicator dot -->
                    <div class="flex-shrink-0 w-1.5 h-1.5 rounded-full bg-gray-500/60 mt-1.5 group-hover/news-item:bg-gray-400 transition-colors"></div>
                    
                    <!-- Text content -->
                    <div class="flex-1 min-w-0 space-y-0.5">
                        {% if title_text and summary_text and title_text != summary_text %}
                        <!-- Show title as bold headline, summary as description -->
                        <div class="text-[11px] font-semibold text-gray-200/85 leading-tight line-clamp-1 group-hover/news-item:text-gray-100 transition-colors">
                            {{ title_text|e }}
                        </div>
                        <div class="text-[10px] text-gray-400/70 leading-relaxed line-clamp-2 group-hover/news-item:text-gray-300/90 transition-colors">
                            {{ summary_text|e }}
                        </div>
                        {% else %}
                        <!-- Single line display when no separate title/summary -->
                        <div class="text-[11px] text-gray-300/80 leading-relaxed line-clamp-2 group-hover/news-item:text-gray-200 transition-colors">
                            {{ display_text|e }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- External link icon -->
                    <i data-lucide="external-link" class="w-3 h-3 text-gray-500/40 group-hover/news-item:text-gray-400 flex-shrink-0 mt-0.5 opacity-0 group-hover/news-item:opacity-100 transition-all duration-200"></i>
                </div>
                
                <!-- Hover effect overlay -->
                <div class="absolute inset-0 bg-gradient-to-r from-gray-800/0 via-gray-800/0 to-gray-700/10 opacity-0 group-hover/news-item:opacity-100 transition-opacity pointer-events-none"></div>
            </a>
            {% elif display_text %}
            <!-- News item without URL -->
            <div class="px-2.5 py-2 rounded-lg bg-gray-800/30 border border-gray-700/40">
                <div class="flex items-start gap-2">
                    <div class="flex-shrink-0 w-1.5 h-1.5 rounded-full bg-gray-500/40 mt-1.5"></div>
                    <div class="flex-1 min-w-0">
                        {% if title_text and summary_text and title_text != summary_text %}
                        <div class="text-[11px] font-semibold text-gray-200/75 leading-tight line-clamp-1">
                            {{ title_text|e }}
                        </div>
                        <div class="text-[10px] text-gray-400/60 leading-relaxed line-clamp-2">
                            {{ summary_text|e }}
                        </div>
                        {% else %}
                        <div class="text-[11px] text-gray-300/70 leading-relaxed line-clamp-2">
                            {{ display_text|e }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Why Not a Candidate Section -->
    {% if not meets_criteria and rejection_reason %}
    <div class="mt-1.5 pt-1.5 {% if sma_200 and price %}border-t border-gray-700/30{% elif headlines is defined and headlines %}border-t border-gray-700/30{% endif %}">
        <div class="rounded-lg p-2.5 h-16 flex items-center bg-yellow-500/10 border border-yellow-500/30">
            <i data-lucide="alert-circle" class="text-yellow-400 w-4 h-4 flex-shrink-0"></i>
            <div class="flex-1 min-w-0 ml-2 flex flex-col justify-center gap-0.5">
                <h4 class="text-xs font-semibold text-yellow-400 leading-tight">Why Not a Candidate</h4>
                <p class="text-xs text-gray-200 leading-tight line-clamp-2 break-words">{{ rejection_reason|e }}</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Action Buttons - Always at bottom -->
    <div class="mt-auto pt-2 pb-2 space-y-1.5 {% if sma_200 and price %}border-t border-gray-700/30{% elif not meets_criteria and rejection_reason %}border-t border-gray-700/30{% elif headlines is defined and headlines %}border-t border-gray-700/30{% else %}border-t border-gray-700/30{% endif %}">
        <!-- VIEW ALL STATS Button -->
        <button 
            hx-post="/api/all-stats"
            hx-vals='{{ {"ticker": symbol} | tojson }}'
            hx-target="#modal-container"
            hx-swap="innerHTML"
            hx-disabled-elt="this"
            hx-indicator="#view-stats-indicator-{{ symbol|lower }}"
            hx-on::htmx:after-swap="if(typeof lucide !== 'undefined') lucide.createIcons()"
            onclick="event.stopPropagation()"
            class="w-full py-2 rounded-lg text-xs font-semibold text-white hover:bg-blue-600/30 transition-all duration-300 bg-blue-500/30 flex items-center justify-center gap-2 border border-blue-500/50 hover:border-blue-400 hover:scale-[1.02] hover:shadow-lg hover:shadow-blue-500/30 active:scale-[0.98] group disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 disabled:hover:shadow-lg disabled:hover:bg-blue-500/30">
            <span id="view-stats-indicator-{{ symbol|lower }}" class="htmx-indicator">
                <i data-lucide="loader-2" class="w-3.5 h-3.5 lucide-spin"></i>
            </span>
            <i data-lucide="bar-chart-3" class="w-3.5 h-3.5 htmx-indicator-hidden group-hover:scale-110 transition-transform duration-300"></i>
            <span class="htmx-indicator-hidden">VIEW ALL STATS</span>
            <span class="htmx-indicator">Loading Stats...</span>
        </button>
        
        <!-- Analyze with AI Button -->
        <button 
            hx-post="/api/analyze"
            hx-vals='{{ {"ticker": symbol} | tojson }}'
            hx-target="#modal-container"
            hx-swap="innerHTML"
            hx-headers='{"HX-Target": "modal-container"}'
            hx-timeout="65000"
            hx-disabled-elt="this"
            hx-indicator="#analyze-ai-indicator-{{ symbol|lower }}"
            hx-on::htmx:after-swap="if(typeof lucide !== 'undefined') lucide.createIcons()"
            hx-on::htmx:response-error="this.innerHTML='<div class=\'p-4 text-red-400\'><i data-lucide=\'alert-circle\' class=\'w-5 h-5 inline-block\'></i> Error: Failed to analyze. Please try again.</div>'; if(typeof lucide !== 'undefined') lucide.createIcons()"
            hx-on::htmx:before-request="event.stopPropagation()"
            onclick="event.stopPropagation(); return false;"
            class="w-full py-2.5 rounded-lg text-xs font-bold text-white hover:bg-purple-600/30 transition-all bg-purple-500/30 flex items-center justify-center gap-2 border border-purple-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="analyze-ai-indicator-{{ symbol|lower }}" class="htmx-indicator">
                <i data-lucide="loader-2" class="w-3.5 h-3.5 lucide-spin"></i>
            </span>
            <i data-lucide="sparkles" class="w-3.5 h-3.5 htmx-indicator-hidden"></i>
            <span class="htmx-indicator-hidden">Analyze with AI</span>
            <span class="htmx-indicator">Analyzing...</span>
        </button>
        
        <!-- Buy Button - Opens Modal via HTMX -->
        <div x-on:click.stop>
            <button 
                hx-post="/api/buy-confirmation"
                hx-vals='{{ {"symbol": symbol} | tojson }}'
                hx-target="#modal-container"
                hx-swap="beforeend"
                class="w-full py-2.5 rounded-lg text-xs font-bold text-white hover:bg-green-600/40 transition-all duration-300 bg-green-500/40 flex items-center justify-center gap-2 border-2 border-green-400/60 hover:border-green-300 hover:scale-[1.02] hover:shadow-lg hover:shadow-green-500/40 active:scale-[0.98]">
                <i data-lucide="shopping-cart" class="w-3.5 h-3.5"></i>
                <span>BUY</span>
            </button>
        </div>
    </div>
</div>
{% endif %}

{# LOADING/NO DATA CARD #}
{% else %}
<div class="ticker-card watchlist-card watchlist-card-loading watchlist-interactive-element glass-panel rounded-lg p-3 border border-blue-500/30 group transition-all relative cursor-default min-w-[20rem] min-h-[11.25rem] animate-pulse" 
     data-symbol="{{ symbol|e }}"
     data-meets-criteria="false"
     data-loading="true"
     role="listitem"
     aria-label="Ticker {{ symbol|e }} - loading data">
    <!-- Loading Skeleton -->
    <div class="mb-1">
        <div class="flex items-start justify-between gap-2 mb-0.5">
            <div class="flex items-baseline gap-2 flex-1 min-w-0">
                <div class="h-10 w-24 bg-gray-700/50 rounded animate-pulse"></div>
                <div class="h-8 w-20 bg-gray-700/50 rounded animate-pulse"></div>
            </div>
            <div class="w-8 h-8 bg-gray-700/50 rounded animate-pulse"></div>
        </div>
    </div>
    
    <!-- Skeleton Metrics Grid -->
    <div class="grid grid-cols-2 gap-1 mb-1">
        <div class="h-12 bg-gray-700/30 rounded animate-pulse"></div>
        <div class="h-12 bg-gray-700/30 rounded animate-pulse"></div>
        <div class="h-12 bg-gray-700/30 rounded animate-pulse"></div>
        <div class="h-12 bg-gray-700/30 rounded animate-pulse"></div>
    </div>
    
    <!-- Loading Indicator -->
    <div class="flex items-center justify-center gap-2 py-2">
        <div class="w-4 h-4 border-2 border-cyan-500/30 border-t-cyan-400 rounded-full animate-spin"></div>
        <span class="text-xs text-gray-400">Loading {{ symbol|e }}...</span>
    </div>
    
    <!-- Remove Button (still functional during loading) -->
    <button 
        hx-post="/api/watch-list"
        hx-vals='{{ {"action": "remove", "symbol": symbol} | tojson | e }}'
        hx-confirm="Remove {{ symbol|e }} from watch list?"
        hx-target="#watch-list"
        hx-swap="innerHTML"
        hx-indicator="#watchlist-loading-overlay"
        class="absolute top-2 right-2 remove-ticker-btn flex items-center justify-center w-8 h-8 rounded-lg bg-red-500/80 hover:bg-red-500 text-white border border-red-400/50 shadow-md hover:shadow-lg transition-all focus:ring-2 focus:ring-red-500/50 focus:outline-none group/remove z-10"
        title="Remove {{ symbol|e }} from watch list"
        aria-label="Remove {{ symbol|e }} from watch list">
        <i data-lucide="x" class="w-4 h-4 group-hover/remove:scale-110 transition-transform" aria-hidden="true"></i>
    </button>
</div>
{% endif %}
