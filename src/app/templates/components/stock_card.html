<div class="glass-panel rounded-2xl p-6 card-hover border-l-4 w-full transition-all duration-300 hover:translate-y-[-10px] hover:shadow-xl hover:shadow-yellow-500/10 focus-within:ring-2 focus-within:ring-blue-500/50 {{ border_class }} cursor-pointer"
     data-symbol="{{ symbol|e }}"
     data-score="{{ ai_score or 0 }}"
     data-rsi="{{ rsi or 0 }}"
     data-profit-potential="{{ profit_potential or 0 }}"
     data-risk-reward="{{ risk_reward_ratio or 0 }}"
     data-signal="{{ overall_signal }}"
     data-meets-criteria="{{ meets_criteria|lower }}"
     hx-post="/api/analyze"
     hx-vals='{{ {"ticker": symbol} | tojson }}'
     hx-trigger="click[event.target.tagName !== 'BUTTON' && !event.target.closest('button, a')]"
     hx-target="#modal-container"
     hx-swap="beforeend"
     hx-indicator="#modal-container"
     data-analysis-title="{{ symbol|e }} Analysis"
     role="button"
     tabindex="0"
     aria-label="Stock card for {{ symbol|e }} - {{ overall_signal }} signal - Click to analyze">
    <div class="flex items-start justify-between mb-3">
        <div class="flex items-center gap-2.5 flex-1 min-w-0">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center flex-shrink-0 border border-blue-500/30">
                <span class="font-bold text-white text-sm">{{ symbol|e }}</span>
            </div>
            <div class="min-w-0 flex-1">
                <div class="flex items-start gap-2 mb-1">
                    <p class="text-base font-semibold text-white break-words leading-relaxed">{{ description|e }}</p>
                    {% if has_limited_data %}
                    <i data-lucide="alert-circle" class="text-yellow-400 text-sm flex-shrink-0 mt-0.5 w-4 h-4" title="Limited data available - some analysis may be incomplete"></i>
                    {% endif %}
                </div>
                {% if price %}
                <div class="flex items-center gap-1.5 mt-1">
                    <span class="text-sm text-gray-400">Price:</span>
                    <span class="text-sm font-bold text-white">${{ price|round(2) }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="flex items-center gap-2 flex-shrink-0 ml-2">
            {% if ai_score is not none %}
            <button @click="openMetricModal({{ 'ai-score'|tojson }}, {{ symbol|tojson }}, {{ ai_score|tojson }}, {{ score_label|tojson }})" 
                    class="badge {{ score_badge }} {{ score_bg }} {{ score_border }} border-2 {{ score_glow }} transition-all hover:scale-105 cursor-pointer focus:ring-2 focus:ring-blue-500/50"
                    aria-label="AI Score: {{ ai_score }}/10 - {{ score_label|e }}. Click to learn more">
                <span class="text-sm font-bold {{ score_color }}">{{ ai_score }}</span><span class="text-xs {{ score_color }} opacity-75">/10</span>
                {% if confidence_boost != 0 %}
                <span class="text-xs ml-1.5 font-semibold {% if confidence_boost > 0 %}text-green-400{% else %}text-red-400{% endif %}" aria-label="Confidence boost: {% if confidence_boost > 0 %}+{% endif %}{{ confidence_boost|round(1) }}">{% if confidence_boost > 0 %}+{% endif %}{{ confidence_boost|round(1) }}</span>
                {% endif %}
            </button>
            {% else %}
            <div class="badge badge-info" aria-label="AI score not available">
                <i data-lucide="flame" class="text-orange-400 text-xs w-3 h-3" aria-hidden="true"></i>
            </div>
            {% endif %}
            {% if cache_hit %}
            <div class="badge badge-info" title="Cached analysis (fresh)" aria-label="Cached analysis">
                <i data-lucide="database" class="text-xs w-3 h-3" aria-hidden="true"></i>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if price and rsi is not none and trend %}
    <div class="grid grid-cols-3 gap-3 mb-3 pt-3 border-t border-gray-700/50" role="list" aria-label="Technical metrics">
        <div class="text-center relative" role="listitem">
            <div class="flex items-center justify-center gap-1 mb-1">
                <div class="w-8 h-8 rounded-lg {{ rsi_bg }} flex items-center justify-center" aria-hidden="true">
                    <i data-lucide="{{ rsi_icon }}" class="{{ rsi_color }} text-xs w-4 h-4"></i>
                </div>
                <button @click="openMetricModal({{ 'rsi'|tojson }}, {{ symbol|tojson }}, {{ (rsi or 0)|tojson }}, {{ rsi_status|tojson }})" 
                        class="info-icon text-blue-400 hover:text-blue-300 text-xs ml-1 transition-all focus:ring-2 focus:ring-blue-500/50 rounded"
                        aria-label="Learn about RSI">
                    <i data-lucide="info" class="w-4 h-4" aria-hidden="true"></i>
                </button>
            </div>
            <div class="text-sm font-bold {{ rsi_color }} mb-1" aria-label="RSI: {% if rsi %}{{ rsi|round(1) }}{% else %}N/A{% endif %}">{% if rsi %}{{ rsi|round(1) }}{% else %}N/A{% endif %}</div>
            <div class="text-xs text-gray-500 uppercase tracking-wider">RSI</div>
            <div class="text-xs {{ rsi_color }} mt-0.5">{{ rsi_status }}</div>
        </div>
        <div class="text-center relative" role="listitem">
            <div class="flex items-center justify-center gap-1 mb-1">
                <div class="w-8 h-8 rounded-lg {{ trend_bg }} flex items-center justify-center" aria-hidden="true">
                    <i data-lucide="{{ trend_icon }}" class="{{ trend_color }} text-xs w-4 h-4"></i>
                </div>
                <button @click="openMetricModal({{ 'trend'|tojson }}, {{ symbol|tojson }}, {{ trend|tojson }}, {{ 'vs SMA-200'|tojson }})" 
                        class="info-icon text-blue-400 hover:text-blue-300 text-xs ml-1 transition-all focus:ring-2 focus:ring-blue-500/50 rounded"
                        aria-label="Learn about trend">
                    <i data-lucide="info" class="w-4 h-4" aria-hidden="true"></i>
                </button>
            </div>
            <div class="text-sm font-bold {{ trend_color }} mb-1" aria-label="Trend: {{ trend or 'N/A' }}">{{ trend or 'N/A' }}</div>
            <div class="text-xs text-gray-500 uppercase tracking-wider">Trend</div>
            <div class="text-xs text-gray-500 mt-0.5">vs SMA-200</div>
        </div>
        <div class="text-center relative" role="listitem">
            <div class="flex items-center justify-center gap-1 mb-1">
                <div class="w-8 h-8 rounded-lg {{ score_bg }} {{ score_border }} border-2 flex items-center justify-center {{ score_glow }} transition-all" aria-hidden="true">
                    <i data-lucide="{{ score_icon }}" class="{{ score_color }} text-xs w-4 h-4"></i>
                </div>
                <button @click="openMetricModal({{ 'ai-score'|tojson }}, {{ symbol|tojson }}, {{ (ai_score or 0)|tojson }}, {{ score_label|tojson }})" 
                        class="info-icon text-blue-400 hover:text-blue-300 text-xs ml-1 transition-all focus:ring-2 focus:ring-blue-500/50 rounded"
                        aria-label="Learn about AI score">
                    <i data-lucide="info" class="w-4 h-4" aria-hidden="true"></i>
                </button>
            </div>
            <div class="text-base font-bold {{ score_color }} mb-1 tracking-tight" aria-label="AI Score: {% if ai_score is not none %}{{ ai_score }}/10{% else %}N/A{% endif %}">{% if ai_score is not none %}{{ ai_score }}/10{% else %}N/A{% endif %}</div>
            <div class="text-xs text-gray-500 uppercase tracking-wider">AI Score</div>
            <div class="text-xs font-semibold {{ score_color }} mt-0.5">{{ score_label }}</div>
            {% if meets_criteria and ai_score and ai_score >= 7 %}
            <div class="text-[10px] text-green-400 mt-0.5 font-semibold" aria-label="Meets entry criteria">âœ“ Meets Criteria</div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    {% if ai_reason and ai_reason.strip() and ai_reason != description %}
    <div class="mt-3 pt-3 border-t border-white/8" role="region" aria-label="Actionable insight">
        <div class="glass-panel rounded-lg p-4 bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-500/30">
            <div class="flex items-start gap-3">
                <div class="flex-shrink-0 mt-0.5" aria-hidden="true">
                    <i data-lucide="target" class="text-purple-400 text-lg w-5 h-5"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-xs font-semibold text-purple-300 mb-1 uppercase tracking-wider">Actionable Insight</div>
                    <p class="text-sm text-gray-200 leading-relaxed break-words">{{ ai_reason|e }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if profit_potential is not none and risk_reward_ratio is not none %}
    <div class="mt-3 pt-3 border-t border-white/8" role="region" aria-label="Profit and risk metrics">
        <div class="grid grid-cols-2 gap-2 mb-2">
            <div class="glass-panel rounded-lg p-2.5 bg-green-500/10 border border-green-500/30 transition-all duration-300 hover:bg-green-500/20 hover:border-green-500/50 hover:scale-105 cursor-pointer group" role="group" aria-label="Profit potential">
                <div class="text-xs text-gray-300 mb-1 font-medium flex items-center gap-1">
                    <i data-lucide="trending-up" class="text-green-400 group-hover:animate-bounce w-4 h-4" aria-hidden="true"></i>
                    Profit Potential
                </div>
                <div class="text-lg font-bold text-green-400 profit-highlight number-transition" aria-label="Profit potential: +${{ profit_potential|round(2) }}">+${{ profit_potential|round(2) }}</div>
                <div class="text-xs text-green-400 mt-0.5 font-semibold" aria-label="Percentage gain: +{% if profit_potential_pct %}{{ profit_potential_pct|round(1) }}{% else %}0.0{% endif %}%">+{% if profit_potential_pct %}{{ profit_potential_pct|round(1) }}{% else %}0.0{% endif %}%</div>
            </div>
            <div class="glass-panel rounded-lg p-2.5 bg-blue-500/10 border border-blue-500/30 transition-all duration-300 hover:bg-blue-500/20 hover:border-blue-500/50 hover:scale-105" role="group" aria-label="Risk reward ratio">
                <div class="text-xs text-gray-300 mb-1 font-medium flex items-center gap-1">
                    <i data-lucide="scale" class="text-blue-400 w-4 h-4" aria-hidden="true"></i>
                    Risk/Reward
                </div>
                <div class="text-lg font-bold text-blue-400" aria-label="Risk reward ratio: {{ risk_reward_ratio }} to 1">{{ risk_reward_ratio }}:1</div>
                <div class="text-xs text-gray-400 mt-0.5">Risk: ${% if risk_amount %}{{ risk_amount|round(2) }}{% else %}0.00{% endif %}</div>
            </div>
        </div>
        {% if stop_loss and take_profit %}
        <div class="text-xs text-muted mt-2 pt-2 border-t border-white/8 space-y-1" role="list" aria-label="Exit levels">
            <div class="flex justify-between items-center" role="listitem">
                <span class="flex items-center gap-1">
                    <i data-lucide="shield" class="text-red-400 w-4 h-4" aria-hidden="true"></i>
                    Stop Loss:
                </span>
                <span class="text-red-400 font-semibold" aria-label="Stop loss price: ${{ stop_loss|round(2) }}">${{ stop_loss|round(2) }}</span>
            </div>
            <div class="flex justify-between items-center" role="listitem">
                <span class="flex items-center gap-1">
                    <i data-lucide="target" class="text-green-400 w-4 h-4" aria-hidden="true"></i>
                    Take Profit:
                </span>
                <span class="text-green-400 font-semibold" aria-label="Take profit price: ${{ take_profit|round(2) }}">${{ take_profit|round(2) }}</span>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    
    {% if atr and price %}
    <div class="mt-3 pt-3 border-t border-white/8" role="region" aria-label="Volatility information">
        <div class="glass-panel rounded-lg p-3 bg-blue-500/10 border border-blue-500/30">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i data-lucide="activity" class="text-blue-400 w-4 h-4" aria-hidden="true"></i>
                    <span class="text-xs font-semibold text-white">ATR (Volatility)</span>
                </div>
                <div class="text-right">
                    <div class="text-sm font-bold text-blue-400" aria-label="ATR: ${{ atr|round(2) }}">${{ atr|round(2) }}</div>
                    <div class="text-[10px] text-gray-400">{% if price > 0 %}{{ ((atr / price) * 100)|round(1) }}{% else %}0.0{% endif %}% of price</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if similar_signals and similar_signals|length > 0 %}
    <div class="mt-2 pt-2 border-t border-white/8" role="region" aria-label="Historical signal performance">
        <div class="text-xs text-gray-400 mb-1 font-medium">Similar Signals ({{ similar_count }})</div>
        <div class="space-y-0.5" role="list" aria-label="Similar historical signals">
            {% for sig in similar_signals[:5] %}
            <div class="text-[10px] {% if sig.result == 'profit' %}text-green-400{% elif sig.result == 'loss' %}text-red-400{% else %}text-gray-400{% endif %}" role="listitem">{{ sig.date or 'N/A' }}: {{ sig.result or 'N/A' }}</div>
            {% endfor %}
        </div>
        <div class="flex items-center mt-2 pt-2 border-t border-white/8">
            <span class="text-xs text-gray-400">Win Rate:</span>
            <span class="text-xs font-bold text-green-400 ml-1.5" aria-label="Win rate: {{ win_rate|round(1) }}%">{{ win_rate|round(1) }}%</span>
            {% if confidence_boost != 0 %}
            <span class="text-xs ml-1.5 font-semibold {% if confidence_boost > 0 %}text-green-400{% else %}text-red-400{% endif %}" aria-label="Confidence boost: {% if confidence_boost > 0 %}+{% endif %}{{ confidence_boost|round(1) }}">{% if confidence_boost > 0 %}+{% endif %}{{ confidence_boost|round(1) }}</span>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <div class="mt-3 pt-3 border-t border-white/8">
        <button 
            hx-post="/api/analyze"
            hx-vals='{{ {"ticker": symbol} | tojson }}'
            hx-target="#modal-container"
            hx-swap="beforeend"
            hx-indicator="#modal-container"
            hx-trigger="click consume"
            hx-on:click="event.stopPropagation()"
            class="w-full btn-glass py-2 rounded-lg text-sm font-bold text-white hover:bg-blue-600/30 transition-all bg-blue-500/30 flex items-center justify-center gap-2 border border-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Refresh analysis for {{ symbol|e }}">
            <span class="htmx-indicator">
                <i data-lucide="loader-2" class="text-xs w-4 h-4 lucide-spin"></i>
            </span>
            <i data-lucide="refresh-cw" class="text-xs w-4 h-4 htmx-indicator-hidden"></i>
            <span>Refresh Analysis</span>
        </button>
    </div>
</div>
