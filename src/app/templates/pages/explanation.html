<!-- Header: Why This Could Be a Low Buy -->
<div class="mb-6 pb-4 border-b border-gray-700/50" role="region" aria-label="Analysis explanation">
    <h2 class="text-2xl font-bold text-white mb-3 leading-tight">Why This Could Be a Low Buy</h2>
    <p class="text-base text-gray-300 leading-relaxed">Stock is oversold (RSI &lt; {{ config.rsi_threshold }}) with signals suggesting recovery. FLUX found this at a low price with bounce-back potential.</p>
</div>

<!-- Key Metrics Row -->
<div class="grid grid-cols-4 gap-4 mb-6" role="list" aria-label="Key metrics">
    <div class="glass rounded-lg p-4 bg-purple-500/10 border border-purple-500/20" role="listitem">
        <div class="text-xs text-gray-400 uppercase tracking-wider mb-2 font-semibold">AI Score</div>
        <div class="text-3xl font-bold {{ ai_score_color }} mb-1" aria-label="AI Score: {{ verdict_score }} out of 10">{{ verdict_score }}/10</div>
        <div class="text-sm text-gray-300 mt-1">{{ verdict_action|e }}</div>
    </div>
    <div class="glass rounded-lg p-4 bg-green-500/10 border border-green-500/20" role="listitem">
        <div class="text-xs text-gray-400 uppercase tracking-wider mb-2 font-semibold">RSI</div>
        <div class="text-3xl font-bold text-green-400 mb-1" aria-label="RSI: {{ rsi_value|round(1) }}">{{ rsi_value|round(1) }}</div>
        <div class="text-sm text-gray-300 mt-1">{{ rsi_status }}</div>
    </div>
    <div class="glass rounded-lg p-4 bg-blue-500/10 border border-blue-500/20" role="listitem">
        <div class="text-xs text-gray-400 uppercase tracking-wider mb-2 font-semibold">Trend</div>
        <div class="text-3xl font-bold {{ trend_color }} mb-1" aria-label="Trend: {{ trend_value }}">{{ trend_value }}</div>
        <div class="text-sm text-gray-300 mt-1">vs SMA-200</div>
    </div>
    <div class="glass rounded-lg p-4 bg-yellow-500/10 border border-yellow-500/20" role="listitem">
        <div class="text-xs text-gray-400 uppercase tracking-wider mb-2 font-semibold">Risk</div>
        <div class="text-2xl font-bold {{ risk_color }} mb-1" aria-label="Risk level: {{ verdict_risk }}">{{ verdict_risk }}</div>
        <div class="text-sm text-gray-300 mt-1">Bounce-back confidence</div>
    </div>
</div>

<!-- Two Column Layout -->
<div class="grid grid-cols-2 gap-6">
    <!-- Left Column: Calculations & Technical Details -->
    <div class="space-y-4">
        <!-- Calculations -->
        <div class="glass rounded-lg p-5 border-l-4 border-green-500/50" role="region" aria-label="Technical calculations">
            <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-calculator text-green-400" aria-hidden="true"></i>
                Calculations
            </h3>
            <div class="grid grid-cols-2 gap-3" role="list" aria-label="Technical indicators">
                <div class="glass rounded-lg p-3 bg-green-500/10" role="listitem">
                    <div class="text-xs text-gray-400 mb-1 font-medium">RSI</div>
                    <div class="text-xl font-bold text-green-400" aria-label="RSI: {{ rsi_value|round(2) }}">{{ rsi_value|round(2) }}</div>
                    <div class="text-xs text-gray-400 mt-1">14-day</div>
                </div>
                <div class="glass rounded-lg p-3 bg-blue-500/10" role="listitem">
                    <div class="text-xs text-gray-400 mb-1 font-medium">SMA-200</div>
                    <div class="text-xl font-bold text-blue-400" aria-label="SMA-200: ${{ sma_value|round(2) }}">${{ sma_value|round(2) }}</div>
                    <div class="text-xs text-gray-400 mt-1">200-day avg</div>
                </div>
                <div class="glass rounded-lg p-3 bg-purple-500/10" role="listitem">
                    <div class="text-xs text-gray-400 mb-1 font-medium">ATR</div>
                    <div class="text-xl font-bold text-purple-400" aria-label="ATR: ${{ atr_value|round(2) }}">${{ atr_value|round(2) }}</div>
                    <div class="text-xs text-gray-400 mt-1">Volatility</div>
                </div>
                <div class="glass rounded-lg p-3 bg-yellow-500/10" role="listitem">
                    <div class="text-xs text-gray-400 mb-1 font-medium">Price</div>
                    <div class="text-xl font-bold text-white" aria-label="Current price: ${{ price_value|round(2) }}">${{ price_value|round(2) }}</div>
                    <div class="text-xs text-gray-400 mt-1">Current</div>
                </div>
            </div>
            <!-- Collapsible Formula Details -->
            <details class="mt-4">
                <summary class="text-sm text-purple-400 cursor-pointer hover:text-purple-300 font-medium">Show Formulas</summary>
                <div class="mt-3 space-y-2 text-sm text-gray-300 leading-relaxed">
                    <div><strong class="text-white">RSI:</strong> RSI = 100 - (100 / (1 + RS)) where RS = Average Gain / Average Loss over 14 periods</div>
                    <div><strong class="text-white">SMA-200:</strong> SMA-200 = Sum of closing prices over last 200 days / 200</div>
                    <div><strong class="text-white">ATR:</strong> ATR = Average of True Range over 14 periods, where True Range = max(High-Low, |High-PrevClose|, |Low-PrevClose|)</div>
                    <div><strong class="text-white">Trend:</strong> Price (${{ price_value|round(2) }}) {% if trend_value == 'UP' %}&gt;{% else %}&lt;{% endif %} SMA-200 (${{ sma_value|round(2) }})</div>
                </div>
            </details>
        </div>
        
        <!-- Educational: What This Means in Plain English -->
        <div class="glass rounded-lg p-5 border-l-4 border-cyan-500/50">
            <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-graduation-cap text-cyan-400"></i>
                What This Means (Plain English)
            </h3>
            <div class="space-y-4">
                <!-- RSI Explanation -->
                <div class="glass rounded-lg p-4 bg-cyan-500/10">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl font-bold text-cyan-400">{{ rsi_value|round(0) }}</div>
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-white mb-1">RSI (Relative Strength Index)</div>
                            <p class="text-xs text-gray-300 leading-relaxed">
                                Think of RSI like a speedometer for stock price movement. 
                                {% if rsi_value < 35 %}
                                <strong class="text-green-400">This stock is oversold</strong> - it has been falling and may be due for a bounce back up, like a rubber ball hitting the ground. The lower the RSI, the more "on sale" the stock is.
                                {% elif rsi_value > 70 %}
                                <strong class="text-red-400">This stock is overbought</strong> - it has been rising and may need to cool down before going higher.
                                {% else %}
                                <strong class="text-yellow-400">This stock is in neutral territory</strong> - not too hot, not too cold.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Trend Explanation -->
                <div class="glass rounded-lg p-4 bg-blue-500/10">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl font-bold {{ trend_color }}">{{ trend_value }}</div>
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-white mb-1">Trend (SMA-200)</div>
                            <p class="text-xs text-gray-300 leading-relaxed">
                                {% if trend_value == 'UP' %}
                                <strong class="text-green-400">This stock is in an uptrend</strong> - the current price is above its 200-day average, which means the long-term direction is up. Think of it like a stock climbing a hill rather than falling off a cliff. The 200-day average acts like a support floor - if price is above it, the trend is healthy.
                                {% else %}
                                <strong class="text-red-400">This stock is in a downtrend</strong> - the current price is below its 200-day average, which means the long-term direction is down. We avoid buying stocks in downtrends.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- ATR Explanation -->
                <div class="glass rounded-lg p-4 bg-purple-500/10">
                    <div class="flex items-start gap-3">
                        <div class="text-lg font-bold text-purple-400">${{ atr_value|round(2) }}</div>
                        <div class="flex-1">
                            <div class="text-sm font-semibold text-white mb-1">ATR (Average True Range)</div>
                            <p class="text-xs text-gray-300 leading-relaxed">
                                ATR measures how much the stock price moves up and down on average - think of it as the stock's "wiggle room". 
                                <strong class="text-yellow-400">This stock moves ${{ atr_value|round(2) }} per day on average</strong> - 
                                {% if atr_value > price_value * 0.03 %}
                                higher volatility means bigger price swings (more risk, but also more potential reward).
                                {% else %}
                                moderate volatility means steady, predictable movements.
                                {% endif %}
                                We use ATR to set our stop loss (safety net) and take profit (target) levels.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Buy Low, Sell High Strategy -->
                <div class="glass rounded-lg p-4 bg-green-500/10 border-2 border-green-500/30">
                    <div class="text-sm font-semibold text-green-400 mb-2">ðŸŽ¯ Buy Low, Sell High Strategy</div>
                    <p class="text-xs text-gray-300 leading-relaxed mb-3">
                        This is a <strong class="text-white">swing trading</strong> opportunity - we're looking to buy when the stock is temporarily low (oversold) and sell when it bounces back up. Think of it like buying a product on sale and selling it when the price goes back to normal.
                    </p>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Buy at (current price):</span>
                            <span class="text-white font-semibold">${{ price_value|round(2) }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Stop Loss (safety exit):</span>
                            <span class="text-red-400 font-semibold">${{ stop_loss_price|round(2) }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Take Profit (sell high):</span>
                            <span class="text-green-400 font-semibold">${{ take_profit_price|round(2) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Inputs -->
        <div class="glass rounded-lg p-5 border-l-4 border-blue-500/50">
            <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-arrow-right text-blue-400"></i>
                Inputs
            </h3>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <div class="text-xs text-gray-400 mb-1 font-medium">Data Points</div>
                    <div class="text-lg font-semibold text-white">{{ bars_count }}</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400 mb-1 font-medium">News Count</div>
                    <div class="text-lg font-semibold text-white">{{ headlines|length }}</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400 mb-1 font-medium">RSI Threshold</div>
                    <div class="text-lg font-semibold text-white">&lt; {{ config.rsi_threshold }}</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400 mb-1 font-medium">Score Required</div>
                    <div class="text-lg font-semibold text-white">â‰¥ {{ config.ai_score_required }}</div>
                </div>
            </div>
        </div>
        
        {% if similar_signals_list %}
        <!-- Similar Signals -->
        <div class="glass rounded-lg p-5 border-l-4 border-blue-500/50">
            <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-history text-blue-400"></i>
                Similar Signals ({{ similar_signals_list|length }})
            </h3>
            <div class="space-y-2">
                {% for s in similar_signals_list[:3] %}
                <div class="glass rounded-lg p-3 bg-blue-500/10 flex items-center justify-between">
                    <span class="text-sm text-gray-200">{{ s.timestamp or 'N/A' }} â€¢ {{ s.analysis.verdict.score if s.analysis.verdict else 0 }}/10</span>
                    <span class="badge {% if s.outcome.profitable %}badge-success{% elif s.outcome.profitable == false %}badge-danger{% else %}badge-info{% endif %} text-sm px-3 py-1">
                        {% if s.outcome.profitable %}âœ“{% elif s.outcome.profitable == false %}âœ—{% else %}?{% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Right Column: Outputs, Insights & News -->
    <div class="space-y-3">
        <!-- Outputs & Reasoning -->
        <div class="glass rounded-lg p-5 border-l-4 border-yellow-500/50">
            <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-arrow-left text-yellow-400"></i>
                Outputs & Reasoning
            </h3>
            <div class="mb-4">
                <div class="text-xs text-gray-400 mb-2 font-medium">Adjusted Score</div>
                <div class="text-2xl font-bold {{ adjusted_score_color }}">
                    {{ adjusted_score|round(2) }}/10
                    {% if confidence_boost != 0 %}
                    <span class="text-sm {% if confidence_boost > 0 %}text-green-400{% else %}text-red-400{% endif %} ml-2">({% if confidence_boost > 0 %}+{% endif %}{{ confidence_boost|round(1) }})</span>
                    {% endif %}
                </div>
            </div>
            <div class="glass rounded-lg p-4 bg-gray-500/10 mb-4">
                <div class="text-xs text-gray-400 mb-2 font-medium">AI Reasoning</div>
                <div class="text-sm text-gray-200 leading-relaxed">{{ verdict_reason|e }}</div>
            </div>
            <div class="glass rounded-lg p-4 bg-blue-500/10 mb-4">
                <div class="text-xs text-gray-400 mb-2 font-medium">ðŸ’¡ What This Score Means</div>
                <div class="text-sm text-gray-200 leading-relaxed">
                    {% if verdict_score >= 8 %}
                    <strong class="text-green-400">Score {{ verdict_score }}/10 is Strong</strong> - The AI sees high probability for a bounce-back. This means the stock is oversold (low price) but has good fundamentals or catalysts that could push it back up.
                    {% elif verdict_score >= 7 %}
                    <strong class="text-lime-400">Score {{ verdict_score }}/10 is Good</strong> - The AI sees decent bounce-back potential. The stock is oversold and in an uptrend, making it a reasonable "buy low" opportunity.
                    {% elif verdict_score >= 5 %}
                    <strong class="text-yellow-400">Score {{ verdict_score }}/10 is Moderate</strong> - The AI sees some potential but with caution. The stock may bounce, but there are some concerns to watch.
                    {% else %}
                    <strong class="text-red-400">Score {{ verdict_score }}/10 is Weak</strong> - The AI sees low bounce-back probability. This may not be a good "buy low" opportunity right now.
                    {% endif %}
                </div>
            </div>
            <div class="flex items-center justify-between text-sm mb-4 pb-4 border-b border-gray-700/30">
                <span class="text-gray-300 font-medium">Meets Criteria:</span>
                <span class="badge {% if meets_criteria %}badge-success{% else %}badge-danger{% endif %} text-sm px-3 py-1">
                    {% if meets_criteria %}âœ“ Yes{% else %}âœ— No{% endif %}
                </span>
            </div>
            <!-- Exit Levels: Buy Low, Sell High -->
            <div class="glass rounded-lg p-4 bg-green-500/10 border-2 border-green-500/30">
                <div class="text-sm text-gray-300 mb-3 font-semibold">If we buy here (Low Buy):</div>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-300">Stop Loss (Risk Limit):</span>
                        <span class="text-lg text-red-400 font-bold">${{ stop_loss_price|round(2) }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-300">Take Profit (Sell High):</span>
                        <span class="text-lg text-green-400 font-bold">${{ take_profit_price|round(2) }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Insights -->
        <div class="glass rounded-lg p-5 border-l-4 border-purple-500/50">
            <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-lightbulb text-purple-400"></i>
                Insights
            </h3>
            <div class="glass rounded-lg p-4 bg-purple-500/10 mb-4">
                <div class="text-xs text-gray-400 mb-2 font-medium">ðŸ“Š Historical Context</div>
                <p class="text-sm text-gray-200 leading-relaxed mb-2">
                    {% if win_rate >= 60 %}
                    <strong class="text-green-400">Good News:</strong> 
                    {% elif win_rate >= 40 %}
                    <strong class="text-yellow-400">Mixed Results:</strong> 
                    {% else %}
                    <strong class="text-red-400">Caution:</strong> 
                    {% endif %}
                    Similar "buy low" setups like this one have a <strong class="text-white">{{ win_rate|round(1) }}% success rate</strong> based on {{ similar_signals_list|length }} past signals.
                </p>
                <p class="text-xs text-gray-400 leading-relaxed">
                    {% if win_rate > 0 %}
                    This means when stocks showed similar patterns in the past, they bounced back successfully {{ win_rate|round(0)|int }}% of the time. Past performance does not guarantee future results, but it gives us confidence.
                    {% else %}
                    Not enough historical data yet - this is a newer pattern.
                    {% endif %}
                </p>
            </div>
            <div class="space-y-3">
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-gray-300">Signal:</span>
                    <span class="text-sm font-semibold text-white">{% if techs.rsi < config.rsi_threshold %}Signal detected{% else %}No signal{% endif %}</span>
                </div>
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-gray-300">Historical:</span>
                    <span class="text-sm font-semibold text-white">{{ similar_signals_list|length }} signals{% if win_rate > 0 %} ({{ win_rate|round(0)|int }}% win){% endif %}</span>
                </div>
                <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-gray-300">AI Validation:</span>
                    <span class="text-sm font-semibold text-white">Score {{ verdict_score }}/10 indicates {{ verdict_action|e }}</span>
                </div>
            </div>
        </div>
        
        {% if news_objects_list %}
        <!-- News Articles -->
        <div class="glass rounded-lg p-5 border-l-4 border-green-500/50">
            <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-newspaper text-green-400"></i>
                Recent News ({{ news_objects_list|length }})
            </h3>
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for article in news_objects_list[:5] %}
                <div class="glass rounded-lg p-4 bg-green-500/10">
                    <a href="{{ article.url|e }}" target="_blank" class="text-sm font-semibold text-white hover:text-green-400 transition block mb-2 leading-snug">{{ article.headline|e }}</a>
                    <p class="text-xs text-gray-300 leading-relaxed line-clamp-3">{{ (article.summary or '')[:500]|e }}</p>
                    <p class="text-xs text-gray-400 mt-2">â€” {{ (article.author or 'Unknown')|e }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
