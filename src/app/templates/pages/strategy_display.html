<div id="strategy-display-content" 
     x-data="{
         rsi_threshold: {{ rsi_threshold }},
         rsi_min: {{ rsi_min }},
         sma_proximity_pct: {{ sma_proximity_pct }},
         ai_score_required: {{ ai_score_required }},
         original_rsi_threshold: {{ rsi_threshold }},
         original_rsi_min: {{ rsi_min }},
         original_sma_proximity_pct: {{ sma_proximity_pct }},
         original_ai_score_required: {{ ai_score_required }},
         get hasChanges() {
             return this.rsi_threshold !== this.original_rsi_threshold ||
                    this.rsi_min !== this.original_rsi_min ||
                    Math.abs(this.sma_proximity_pct - this.original_sma_proximity_pct) > 0.01 ||
                    this.ai_score_required !== this.original_ai_score_required;
         },
         adjust(param, delta) {
             const limits = {
                 rsi_threshold: { min: 20, max: 50 },
                 rsi_min: { min: 10, max: 30 },
                 sma_proximity_pct: { min: 0, max: 5 },
                 ai_score_required: { min: 0, max: 10 }
             };
             const limit = limits[param];
             if (!limit) return;
             let val = this[param] + delta;
             if (param === 'sma_proximity_pct') {
                 val = Math.round(val * 10) / 10;
             } else {
                 val = Math.round(val);
             }
             this[param] = Math.max(limit.min, Math.min(limit.max, val));
         }
     }"
     class="glass rounded-xl p-6 border {{ border_class }} relative transition-all duration-300" 
     role="region" 
     aria-label="Strategy configuration">
    
    <!-- HTMX Loading Indicator -->
    <div id="strategy-loading-indicator" class="htmx-indicator absolute inset-0 bg-gray-900/90 backdrop-blur-md rounded-xl z-20 flex items-center justify-center">
        <div class="text-center">
            <div class="inline-block animate-spin mb-3">
                <i data-lucide="loader-2" class="w-8 h-8 text-cyan-400"></i>
            </div>
            <div class="text-sm font-semibold text-white">Saving & Re-evaluating...</div>
        </div>
    </div>
    
    <!-- Content -->
    <div class="htmx-request:opacity-50 htmx-request:pointer-events-none transition-opacity duration-200">
        <!-- Save & Re-evaluate Button -->
        <div x-show="hasChanges" 
             x-cloak
             x-transition
             class="mb-6">
            <!-- HTMX Form for Saving Strategy -->
            <form 
                hx-post="/api/strategy"
                hx-target="#strategy-display"
                hx-swap="innerHTML"
                hx-indicator="#strategy-loading-indicator"
                class="inline-block w-full">
                <!-- Hidden inputs with current values -->
                <input type="hidden" name="rsi_threshold" :value="rsi_threshold">
                <input type="hidden" name="rsi_min" :value="rsi_min">
                <input type="hidden" name="sma_proximity_pct" :value="sma_proximity_pct">
                <input type="hidden" name="ai_score_required" :value="ai_score_required">
                
                <button 
                    type="submit"
                    class="w-full px-6 py-2.5 rounded-lg bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-semibold text-sm flex items-center justify-center gap-2 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-cyan-500/20 hover:shadow-cyan-500/30">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    <span>Save & Re-evaluate Watchlist</span>
                </button>
            </form>
        </div>
    
        <!-- Parameters Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5" role="list" aria-label="Strategy parameters">
            
            <!-- RSI Threshold -->
            <div class="glass rounded-lg p-5 transition-all duration-200 hover:border-cyan-500/30 group" role="listitem">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="text-sm text-gray-300 font-medium">RSI Threshold</div>
                        <div class="tooltip">
                            <button type="button" aria-label="Learn about RSI threshold" class="focus:ring-2 focus:ring-cyan-500/50 rounded opacity-60 hover:opacity-100 transition-opacity">
                                <i data-lucide="info" class="w-3.5 h-3.5 text-cyan-400 cursor-help"></i>
                            </button>
                            <div class="tooltip-text">
                                <strong>RSI Threshold</strong><br/>
                                Maximum RSI value for entry signals. Only stocks with RSI below this are considered "oversold" and eligible to buy.<br/><br/>
                                <strong>How it works:</strong> RSI &lt; <span x-text="rsi_threshold"></span> means we only buy when stock is oversold (below <span x-text="rsi_threshold"></span>).<br/><br/>
                                <strong>Effect:</strong> Lower = fewer signals (more conservative), Higher = more signals (more aggressive)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-baseline gap-2 mb-4">
                    <span class="text-gray-500 text-lg">&lt;</span>
                    <span class="text-3xl font-bold text-white transition-all duration-150" x-text="rsi_threshold"></span>
                </div>
                
                <div class="flex items-center gap-2">
                    <button 
                        type="button"
                        @click="adjust('rsi_threshold', -1)"
                        :disabled="rsi_threshold <= 20"
                        class="w-10 h-10 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-cyan-500/50 hover:bg-cyan-500/10 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="minus" class="w-4 h-4 text-cyan-400"></i>
                    </button>
                    <div class="flex-1 px-4 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-white text-center font-semibold">
                        <span x-text="rsi_threshold" class="text-lg"></span>
                    </div>
                    <button 
                        type="button"
                        @click="adjust('rsi_threshold', 1)"
                        :disabled="rsi_threshold >= 50"
                        class="w-10 h-10 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-cyan-500/50 hover:bg-cyan-500/10 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="plus" class="w-4 h-4 text-cyan-400"></i>
                    </button>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-500 mt-2">
                    <span>20</span>
                    <span>50</span>
                </div>
                <div class="text-gray-500 text-xs mt-2">On Sale (oversold)</div>
            </div>
            
            <!-- RSI Minimum -->
            <div class="glass rounded-lg p-5 transition-all duration-200 hover:border-cyan-500/30 group" role="listitem">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="text-sm text-gray-300 font-medium">RSI Minimum</div>
                        <div class="tooltip">
                            <button type="button" aria-label="Learn about RSI minimum" class="focus:ring-2 focus:ring-cyan-500/50 rounded opacity-60 hover:opacity-100 transition-opacity">
                                <i data-lucide="info" class="w-3.5 h-3.5 text-cyan-400 cursor-help"></i>
                            </button>
                            <div class="tooltip-text">
                                <strong>RSI Minimum</strong><br/>
                                Minimum RSI value to avoid extreme oversold conditions. Filters out stocks that are too beaten down, which may indicate fundamental issues.<br/><br/>
                                <strong>How it works:</strong> RSI &gt; <span x-text="rsi_min"></span> means we avoid stocks that are extremely oversold (below <span x-text="rsi_min"></span>).<br/><br/>
                                <strong>Effect:</strong> Prevents buying stocks that are too beaten down (may have real problems)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-baseline gap-2 mb-4">
                    <span class="text-gray-500 text-lg">&gt;</span>
                    <span class="text-3xl font-bold text-white transition-all duration-150" x-text="rsi_min"></span>
                </div>
                
                <div class="flex items-center gap-2">
                    <button 
                        type="button"
                        @click="adjust('rsi_min', -1)"
                        :disabled="rsi_min <= 10"
                        class="w-10 h-10 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-cyan-500/50 hover:bg-cyan-500/10 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="minus" class="w-4 h-4 text-cyan-400"></i>
                    </button>
                    <div class="flex-1 px-4 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-white text-center font-semibold">
                        <span x-text="rsi_min" class="text-lg"></span>
                    </div>
                    <button 
                        type="button"
                        @click="adjust('rsi_min', 1)"
                        :disabled="rsi_min >= 30"
                        class="w-10 h-10 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-cyan-500/50 hover:bg-cyan-500/10 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="plus" class="w-4 h-4 text-cyan-400"></i>
                    </button>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-500 mt-2">
                    <span>10</span>
                    <span>30</span>
                </div>
                <div class="text-gray-500 text-xs mt-2">Avoid extreme oversold</div>
            </div>
            
            <!-- SMA-200 Proximity -->
            <div class="glass rounded-lg p-5 transition-all duration-200 hover:border-cyan-500/30 group" role="listitem">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="text-sm text-gray-300 font-medium">SMA-200 Proximity</div>
                        <div class="tooltip">
                            <button type="button" aria-label="Learn about SMA-200 proximity" class="focus:ring-2 focus:ring-cyan-500/50 rounded opacity-60 hover:opacity-100 transition-opacity">
                                <i data-lucide="info" class="w-3.5 h-3.5 text-cyan-400 cursor-help"></i>
                            </button>
                            <div class="tooltip-text">
                                <strong>SMA-200 Proximity</strong><br/>
                                Maximum percentage above SMA-200 for entry. Stocks must be near support (0-5%). Lower = closer to support (more conservative), Higher = further from support (more opportunities)<br/><br/>
                                <strong>How it works:</strong> Price must be within <span x-text="sma_proximity_pct.toFixed(1)"></span>% above the 200-day moving average. This ensures we're buying near support levels, which increases bounce-back probability.<br/><br/>
                                <strong>Effect:</strong> Lower = closer to support (more conservative, fewer signals), Higher = further from support (more opportunities but less near support)
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-baseline gap-2 mb-4">
                    <span class="text-gray-500 text-lg">≤</span>
                    <span class="text-3xl font-bold text-white transition-all duration-150" x-text="sma_proximity_pct.toFixed(1)"></span>
                    <span class="text-lg text-gray-500">%</span>
                </div>
                
                <div class="flex items-center gap-2">
                    <button 
                        type="button"
                        @click="adjust('sma_proximity_pct', -0.1)"
                        :disabled="sma_proximity_pct <= 0"
                        class="w-10 h-10 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-cyan-500/50 hover:bg-cyan-500/10 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="minus" class="w-4 h-4 text-cyan-400"></i>
                    </button>
                    <div class="flex-1 px-4 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-white text-center font-semibold">
                        <span x-text="sma_proximity_pct.toFixed(1)" class="text-lg"></span>
                    </div>
                    <button 
                        type="button"
                        @click="adjust('sma_proximity_pct', 0.1)"
                        :disabled="sma_proximity_pct >= 5"
                        class="w-10 h-10 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-cyan-500/50 hover:bg-cyan-500/10 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="plus" class="w-4 h-4 text-cyan-400"></i>
                    </button>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-500 mt-2">
                    <span>0</span>
                    <span>5%</span>
                </div>
                <div class="text-gray-500 text-xs mt-2">Near support level</div>
            </div>
            
            <!-- AI Score Required -->
            <div class="glass rounded-lg p-5 transition-all duration-200 hover:border-cyan-500/30 group" role="listitem">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <div class="text-sm text-gray-300 font-medium">AI Score Required</div>
                        <div class="tooltip">
                            <button type="button" aria-label="Learn about AI score requirement" class="focus:ring-2 focus:ring-cyan-500/50 rounded opacity-60 hover:opacity-100 transition-opacity">
                                <i data-lucide="info" class="w-3.5 h-3.5 text-cyan-400 cursor-help"></i>
                            </button>
                            <div class="tooltip-text">
                                <strong>AI Score Required</strong><br/>
                                Minimum AI confidence score (0-10) required for entry. AI analyzes news, technicals, and patterns to score bounce-back probability.<br/><br/>
                                <strong>How it works:</strong> Score ≥ <span x-text="ai_score_required"></span> means we only buy when AI is confident about bounce potential.<br/><br/>
                                <strong>Effect:</strong> Higher = fewer but higher quality signals, Lower = more signals but lower confidence
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-baseline gap-2 mb-4">
                    <span class="text-gray-500 text-lg">≥</span>
                    <span class="text-3xl font-bold text-white transition-all duration-150" x-text="ai_score_required"></span>
                </div>
                
                <div class="flex items-center gap-2">
                    <button 
                        type="button"
                        @click="adjust('ai_score_required', -1)"
                        :disabled="ai_score_required <= 0"
                        class="w-10 h-10 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-cyan-500/50 hover:bg-cyan-500/10 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="minus" class="w-4 h-4 text-cyan-400"></i>
                    </button>
                    <div class="flex-1 px-4 py-2 rounded-lg bg-gray-800/50 border border-gray-700 text-white text-center font-semibold">
                        <span x-text="ai_score_required" class="text-lg"></span>
                    </div>
                    <button 
                        type="button"
                        @click="adjust('ai_score_required', 1)"
                        :disabled="ai_score_required >= 10"
                        class="w-10 h-10 rounded-lg bg-gray-800/50 border border-gray-700 hover:border-cyan-500/50 hover:bg-cyan-500/10 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="plus" class="w-4 h-4 text-cyan-400"></i>
                    </button>
                </div>
                <div class="flex items-center justify-between text-xs text-gray-500 mt-2">
                    <span>0</span>
                    <span>10</span>
                </div>
                <div class="text-gray-500 text-xs mt-2">Bounce-back confidence</div>
            </div>
        </div>
    </div>
</div>

<script>
    lucide.createIcons();
    
    // HTMX Gold Standard: Handle afterSwap to reinitialize Alpine.js
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target?.id === 'strategy-display') {
            const strategyContent = event.detail.target.querySelector('#strategy-display-content');
            Alpine.initTree(strategyContent || event.detail.target);
            setTimeout(() => lucide.createIcons(), 150);
        }
    });
    
    // HTMX Gold Standard: Listen for server-triggered event to show re-evaluate button and trigger it
    document.addEventListener('strategySaved', function() {
        const container = document.getElementById('reevaluate-watchlist-container');
        const reevaluateBtn = document.getElementById('reevaluate-watchlist-btn');
        
        // Show re-evaluate button
        if (container && container.__x) {
            container.__x.$data.show = true;
        }
        
        // Auto-trigger re-evaluation using HTMX
        setTimeout(() => {
            if (reevaluateBtn) {
                htmx.trigger(reevaluateBtn, 'click');
            }
        }, 300);
    });
</script>
