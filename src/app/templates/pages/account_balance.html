<!-- Flux Design System: Expert UX Account Balance Display -->
{# Set all variables with safe defaults #}
{% set equity_val = equity|default(0.0)|float %}
{% set pl_val = pl|default(0.0)|float %}
{% set pl_abs_val = pl_abs|default(0.0)|float %}
{% set buying_power_val = buying_power|default(0.0)|float %}
{% set pl_icon_val = pl_icon|default('fa-minus') %}
{% set connected_val = connected|default(False) %}
{% set pl_pct_val = ((pl_val / equity_val * 100) if equity_val > 0 else 0.0)|float %}
{% set buying_power_pct_val = ((buying_power_val / equity_val * 100) if equity_val > 0 else 0.0)|float %}

<div class="account-balance-container" 
     x-data="{
         showDetails: false,
         lastEquity: {{ equity_val }},
         equity: {{ equity_val }},
         pl: {{ pl_val }},
         buyingPower: {{ buying_power_val }},
         connected: {% if connected_val %}true{% else %}false{% endif %},
         get plPercent() {
             return this.lastEquity > 0 ? ((this.pl / this.lastEquity) * 100).toFixed(2) : '0.00';
         },
         get isPositive() {
             return this.pl >= 0;
         },
         get equityFormatted() {
             return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(this.equity);
         },
         get plFormatted() {
             return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Math.abs(this.pl));
         },
         get buyingPowerFormatted() {
             return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(this.buyingPower);
         }
     }"
     x-init="
         // Watch for equity changes and animate
         $watch('equity', (newVal, oldVal) => {
             if (oldVal && newVal !== oldVal) {
                 // Trigger update animation
                 const container = $el;
                 container.classList.add('balance-updated');
                 setTimeout(() => container.classList.remove('balance-updated'), 600);
             }
         });
     ">
    
    <!-- Compact View (Default) -->
    <div class="flex flex-col gap-2 cursor-pointer" @click="showDetails = !showDetails">
        <!-- Status & Equity Row -->
        <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-2">
                <!-- Connection Status Badge -->
                <div class="flex items-center gap-1.5">
                    {% if connected_val %}
                    <div class="relative">
                        <span class="alpaca-status-connected text-[10px]">●</span>
                        <span class="absolute inset-0 animate-ping opacity-75">
                            <span class="alpaca-status-connected text-[10px]">●</span>
                        </span>
                    </div>
                    {% else %}
                    <span class="alpaca-status-disconnected text-[10px]">●</span>
                    {% endif %}
                </div>
                
                <!-- Equity Display -->
                <div class="flex flex-col">
                    <div class="text-xs text-muted uppercase tracking-wider font-semibold leading-tight">Equity</div>
                    <div class="text-2xl font-bold gradient-text-primary font-heading tracking-tight leading-none" 
                         x-text="equityFormatted">
                        ${{ "%.2f"|format(equity_val) }}
                    </div>
                </div>
            </div>
            
            <!-- Quick P&L Indicator -->
            <div class="flex flex-col items-end">
                <div class="flex items-center gap-1.5 px-2 py-1 rounded-lg transition-all hover:scale-105"
                     :class="isPositive ? 'pl-badge-positive' : 'pl-badge-negative'">
                    <i class="fas {{ pl_icon_val }} text-[10px]" 
                       :class="isPositive ? 'text-green-400' : 'text-red-400'"></i>
                    <span class="font-bold font-mono text-xs" 
                          :class="isPositive ? 'text-green-400' : 'text-red-400'"
                          x-text="(isPositive ? '+' : '') + plFormatted">
                        {{ '+' if pl_val >= 0 else '' }}${{ "%.2f"|format(pl_abs_val) }}
                    </span>
                </div>
                <div class="text-[10px] font-semibold mt-0.5" 
                     :class="isPositive ? 'text-green-400' : 'text-red-400'"
                     x-text="(isPositive ? '+' : '') + plPercent + '%'">
                    {{ '+' if pl_val >= 0 else '' }}{{ "%.2f"|format(pl_pct_val) }}%
                </div>
            </div>
        </div>
        
        <!-- Buying Power Bar -->
        <div class="flex items-center gap-2">
            <div class="flex-1 h-1.5 rounded-full bg-white/5 overflow-hidden">
                {% set width_pct = buying_power_pct_val|min(100.0) %}
                <div class="h-full bg-gradient-to-r from-primary/60 to-primary rounded-full transition-all duration-500" 
                     style="width: {{ width_pct }}%"
                     x-bind:style="`width: ${Math.min((buyingPower / equity * 100), 100)}%`"></div>
            </div>
            <div class="flex items-center gap-1 buying-power-badge px-2 py-0.5 rounded">
                <i data-lucide="wallet" class="w-3 h-3 text-primary"></i>
                <span class="text-primary font-semibold font-mono text-[10px]" 
                      x-text="buyingPowerFormatted">
                    ${{ "%.2f"|format(buying_power_val) }}
                </span>
            </div>
        </div>
    </div>
    
    <!-- Expanded Details (On Click) -->
    <div x-show="showDetails" 
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 max-h-0"
         x-transition:enter-end="opacity-100 max-h-96"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 max-h-96"
         x-transition:leave-end="opacity-0 max-h-0"
         class="mt-3 pt-3 border-t border-white/10 overflow-hidden">
        <div class="grid grid-cols-2 gap-3 text-xs">
            <!-- Account Details -->
            <div class="glass rounded-lg p-2 border border-white/10">
                <div class="text-muted mb-1">Account Status</div>
                <div class="flex items-center gap-2">
                    {% if connected_val %}
                    <span class="alpaca-status-connected text-xs">Active</span>
                    {% else %}
                    <span class="alpaca-status-disconnected text-xs">Inactive</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Buying Power Percentage -->
            <div class="glass rounded-lg p-2 border border-white/10">
                <div class="text-muted mb-1">Buying Power</div>
                <div class="text-white font-bold" x-text="equity > 0 ? Math.round((buyingPower / equity) * 100) + '%' : '0%'">
                    {{ buying_power_pct_val|round(0)|int }}%
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-2 mt-3">
            <button 
                onclick="showAccountManager()"
                class="flex-1 btn-glass py-1.5 text-xs flex items-center justify-center gap-1.5">
                <i data-lucide="settings" class="w-3 h-3"></i>
                <span>Manage Accounts</span>
            </button>
            <button 
                hx-get="/api/balance"
                hx-target="#account-info"
                hx-swap="innerHTML"
                class="btn-glass py-1.5 px-3 text-xs flex items-center justify-center gap-1.5">
                <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                <span>Refresh</span>
            </button>
        </div>
    </div>
</div>
