<form 
    id="strategy-config-form"
    hx-post="/api/strategy"
    hx-target="#toast-container"
    hx-swap="beforeend"
    hx-indicator="#strategy-config-submit"
    hx-on::after-request="if(event.detail.successful) { 
        if(typeof window.closeHtmxModal === 'function') { 
            const modal = document.getElementById('strategy-config-modal'); 
            if(modal) window.closeHtmxModal(modal); 
        }
        if(typeof htmx !== 'undefined') { 
            htmx.trigger(document.body, 'refreshStrategy'); 
        }
    }">
    <!-- Goal Preset Selector -->
    <div class="mb-6">
        <label class="block text-sm font-semibold text-white mb-2">
            <i data-lucide="target" class="inline w-4 h-4 mr-1"></i>
            Trading Goal Preset
        </label>
        <select 
            id="strategy-goal-preset"
            name="goal_preset"
            class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500/50 transition-all"
            onchange="updateGoalFromPreset(this)">
            {% for preset_name, preset_value in preset_options %}
            <option value="{{ preset_value }}" {% if preset_value == current_preset %}selected{% endif %}>{{ preset_name }}</option>
            {% endfor %}
        </select>
        <input type="hidden" id="strategy-goal" name="goal" value="{{ goal|e }}">
        <p class="text-xs text-gray-400 mt-1.5">Select a preset trading goal. The preset will auto-configure parameters, or customize them manually below.</p>
    </div>
    
    <!-- Strategy Parameters -->
    <div class="space-y-4">
        <!-- RSI Threshold -->
        <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1.5 flex items-center gap-1.5">
                RSI Threshold
                <div class="tooltip">
                    <i data-lucide="info" class="w-3 h-3 text-blue-400 cursor-help"></i>
                    <div class="tooltip-text">
                        <strong>RSI Threshold</strong><br/>
                        Maximum RSI value for entry signals. Only stocks with RSI below this are considered "oversold" and eligible to buy.<br/><br/>
                        <strong>How it works:</strong> RSI &lt; {{ rsi_threshold }} means we only buy when stock is oversold (below {{ rsi_threshold }}).<br/><br/>
                        <strong>Effect:</strong> Lower = fewer signals (more conservative), Higher = more signals (more aggressive)
                    </div>
                </div>
            </label>
            <input 
                type="number" 
                id="rsi_threshold"
                name="rsi_threshold" 
                value="{{ rsi_threshold }}"
                min="20" 
                max="50" 
                step="1"
                class="w-full px-3 py-2 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500/50"
            />
            <p class="text-[10px] text-gray-500 mt-1">Maximum RSI for entry. Lower = more conservative (fewer signals), Higher = more aggressive (more signals)</p>
        </div>
        
        <!-- RSI Minimum -->
        <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1.5 flex items-center gap-1.5">
                RSI Minimum
                <div class="tooltip">
                    <i data-lucide="info" class="w-3 h-3 text-blue-400 cursor-help"></i>
                    <div class="tooltip-text">
                        <strong>RSI Minimum</strong><br/>
                        Minimum RSI value to avoid extreme oversold conditions. Filters out stocks that are too beaten down, which may indicate fundamental issues.<br/><br/>
                        <strong>How it works:</strong> RSI &gt; {{ rsi_min }} means we avoid stocks that are extremely oversold (below {{ rsi_min }}).<br/><br/>
                        <strong>Effect:</strong> Prevents buying stocks that are too beaten down (may have real problems)
                    </div>
                </div>
            </label>
            <input 
                type="number" 
                id="rsi_min"
                name="rsi_min" 
                value="{{ rsi_min }}"
                min="10" 
                max="30" 
                step="1"
                class="w-full px-3 py-2 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500/50"
            />
            <p class="text-[10px] text-gray-500 mt-1">Minimum RSI to avoid extreme oversold. Prevents buying stocks that are too beaten down</p>
        </div>
        
        <!-- SMA-200 Proximity -->
        <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1.5 flex items-center gap-1.5">
                SMA-200 Proximity (%)
                <div class="tooltip">
                    <i data-lucide="info" class="w-3 h-3 text-blue-400 cursor-help"></i>
                    <div class="tooltip-text">
                        <strong>SMA-200 Proximity</strong><br/>
                        Maximum percentage above SMA-200 for entry. Stocks must be near support (0-5%). Lower = closer to support (more conservative), Higher = further from support (more opportunities)<br/><br/>
                        <strong>How it works:</strong> Price must be within {{ sma_proximity_pct }}% above the 200-day moving average. This ensures we're buying near support levels, which increases bounce-back probability.<br/><br/>
                        <strong>Effect:</strong> Lower = closer to support (more conservative, fewer signals), Higher = further from support (more opportunities but less near support)
                    </div>
                </div>
            </label>
            <input 
                type="number" 
                id="sma_proximity_pct"
                name="sma_proximity_pct" 
                value="{{ sma_proximity_pct }}"
                min="0" 
                max="5" 
                step="0.5"
                class="w-full px-3 py-2 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500/50"
            />
            <p class="text-[10px] text-gray-500 mt-1">Maximum distance above 200-day average. 0% = touching SMA-200, 5% = 5% above. Lower = closer to support (more conservative)</p>
        </div>
        
        <!-- AI Score Required -->
        <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1.5 flex items-center gap-1.5">
                AI Score Required
                <div class="tooltip">
                    <i data-lucide="info" class="w-3 h-3 text-blue-400 cursor-help"></i>
                    <div class="tooltip-text">
                        <strong>AI Score Required</strong><br/>
                        Minimum AI confidence score (0-10) required for entry. AI analyzes news, technicals, and patterns to score bounce-back probability.<br/><br/>
                        <strong>How it works:</strong> Score ≥ {{ ai_score_required }} means we only buy when AI confidence is high enough.<br/><br/>
                        <strong>Effect:</strong> Higher = fewer but higher quality signals, Lower = more signals but lower confidence
                    </div>
                </div>
            </label>
            <input 
                type="number" 
                id="ai_score_required"
                name="ai_score_required" 
                value="{{ ai_score_required }}"
                min="0" 
                max="10" 
                step="1"
                class="w-full px-3 py-2 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500/50"
            />
            <p class="text-[10px] text-gray-500 mt-1">Minimum AI score (0-10). Higher = fewer but higher quality signals, Lower = more signals but lower confidence</p>
        </div>
        
        <!-- Risk Per Trade -->
        <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1.5 flex items-center gap-1.5">
                Risk Per Trade ($)
                <div class="tooltip">
                    <i data-lucide="info" class="w-3 h-3 text-blue-400 cursor-help"></i>
                    <div class="tooltip-text">
                        <strong>Risk Per Trade</strong><br/>
                        Dollar amount you're willing to risk if stop loss is hit. This determines position size based on volatility.<br/><br/>
                        <strong>How it works:</strong> Position size = risk_amount / (2 × ATR). The stop loss is set at 2×ATR below entry, so if it hits, you lose exactly this amount.<br/><br/>
                        <strong>Example:</strong> $50 risk with $2 ATR = 25 shares. If stop loss hits, you lose $50.<br/><br/>
                        <strong>Effect:</strong> Higher = larger positions, Lower = smaller positions
                    </div>
                </div>
            </label>
            <input 
                type="number" 
                id="risk_per_trade"
                name="risk_per_trade" 
                value="{{ risk_per_trade }}"
                min="25" 
                max="200" 
                step="5"
                class="w-full px-3 py-2 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500/50"
            />
            <p class="text-[10px] text-gray-500 mt-1">Dollar amount to risk if stop loss is hit. Position size = risk_amount / (2 × ATR). Higher = larger positions</p>
        </div>
        
        <!-- Max Capital -->
        <div>
            <label class="block text-xs font-semibold text-gray-300 mb-1.5 flex items-center gap-1.5">
                Max Capital ($)
                <div class="tooltip">
                    <i data-lucide="info" class="w-3 h-3 text-blue-400 cursor-help"></i>
                    <div class="tooltip-text">
                        <strong>Max Capital</strong><br/>
                        Maximum total capital to deploy across all positions. This caps position size to prevent over-allocation.<br/><br/>
                        <strong>How it works:</strong> Max shares = min(buying_power, max_capital) / price. This limits total exposure across all positions.<br/><br/>
                        <strong>Example:</strong> $5,000 max capital with $100 stock = max 50 shares per position.<br/><br/>
                        <strong>Effect:</strong> Limits total exposure, prevents over-allocation
                    </div>
                </div>
            </label>
            <input 
                type="number" 
                id="max_capital"
                name="max_capital" 
                value="{{ max_capital }}"
                min="1000" 
                max="50000" 
                step="500"
                class="w-full px-3 py-2 bg-gray-800/50 border border-gray-600/50 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500/50"
            />
            <p class="text-[10px] text-gray-500 mt-1">Maximum total capital to deploy across all positions. Caps position size: max_shares = min(buying_power, max_capital) / price</p>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="flex gap-3 pt-4 border-t border-gray-700/50">
        <button 
            id="strategy-config-submit"
            type="submit"
            class="flex-1 px-4 py-2.5 bg-purple-600/30 hover:bg-purple-600/50 text-white font-semibold rounded-lg border border-purple-500/50 transition-all flex items-center justify-center gap-2"
            hx-indicator="#strategy-config-submit">
            <i data-lucide="save" class="w-4 h-4"></i>
            <span>Save Configuration</span>
        </button>
        <button 
            type="button"
            x-data="{ closeModal() { if (typeof window.closeModal === 'function') window.closeModal('strategy-config'); } }"
            @click="closeModal()"
            class="px-4 py-2.5 bg-gray-700/30 hover:bg-gray-700/50 text-gray-200 font-semibold rounded-lg border border-gray-600/50 transition-all"
            aria-label="Cancel strategy configuration">
            Cancel
        </button>
    </div>
</form>

{% include "scripts/strategy_config_scripts.html" %}
