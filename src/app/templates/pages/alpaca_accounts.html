<!-- Alpaca Account Management UI -->
<div class="glass-panel rounded-xl p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-white font-heading">Alpaca Accounts</h2>
        <button 
            onclick="document.getElementById('add-account-modal').showModal()"
            class="btn-glow px-4 py-2 text-sm">
            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
            Add Account
        </button>
    </div>
    
    <!-- Accounts List -->
    <div class="space-y-3">
        {% if accounts %}
            {% for account in accounts %}
            <div class="glass rounded-lg p-4 border {{ 'border-primary/50 bg-primary/5' if account.account_id == active_account_id else 'border-white/10' }}"
                 data-account-id="{{ account.account_id }}">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-lg font-bold text-white">{{ account.nickname }}</h3>
                            {% if account.account_id == active_account_id %}
                            <span class="alpaca-status-connected text-xs">Active</span>
                            {% endif %}
                        </div>
                        <div class="text-sm text-muted space-y-1">
                            <div>Account ID: <span class="font-mono text-white">{{ account.account_id }}</span></div>
                            {% if account.account_number %}
                            <div>Account #: <span class="font-mono text-white">{{ account.account_number }}</span></div>
                            {% endif %}
                            <div>Base URL: <span class="font-mono text-white text-xs">{{ account.base_url }}</span></div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        {% if account.account_id != active_account_id %}
                        <button 
                            hx-post="/api/alpaca-accounts/set-active"
                            hx-vals='{"account_id": "{{ account.account_id }}"}'
                            hx-swap="none"
                            hx-trigger="click"
                            hx-on::after-request="htmx.trigger('body', 'accountUpdated'); htmx.trigger('body', 'balanceRefresh')"
                            class="btn-glass px-3 py-1.5 text-xs">
                            <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i>
                            Activate
                        </button>
                        {% endif %}
                        <button 
                            hx-post="/api/alpaca-accounts/test"
                            hx-vals='{"account_id": "{{ account.account_id }}"}'
                            hx-target="#test-result-{{ account.account_id }}"
                            hx-swap="innerHTML"
                            class="btn-glass px-3 py-1.5 text-xs">
                            <i data-lucide="wifi" class="w-3 h-3 mr-1"></i>
                            Test
                        </button>
                        <button 
                            onclick="deleteAccount('{{ account.account_id }}', '{{ account.nickname }}')"
                            class="btn-glass px-3 py-1.5 text-xs text-red-400 hover:bg-red-500/20">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
                <div id="test-result-{{ account.account_id }}" class="mt-2"></div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-8 text-muted">
                <i data-lucide="wallet" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                <p>No accounts configured</p>
                <p class="text-xs mt-2">Add your first Alpaca paper trading account to get started</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Account Modal -->
<dialog id="add-account-modal" class="htmx-modal">
    <div class="glass-panel rounded-xl p-6 max-w-md w-full">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-white font-heading">Add Alpaca Account</h3>
            <button onclick="this.closest('dialog').close()" class="text-muted hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <form 
            hx-post="/api/alpaca-accounts/create"
            hx-swap="none"
            hx-on::after-request="
                if (event.detail.successful) {
                    htmx.trigger('body', 'accountUpdated');
                    this.closest('dialog').close();
                    this.reset();
                }
            ">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-white mb-1">Account ID</label>
                    <input 
                        type="text" 
                        name="account_id" 
                        required
                        placeholder="PA3AFGM5YBAO"
                        class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white focus:border-primary focus:ring-2 focus:ring-primary/20">
                    <p class="text-xs text-muted mt-1">Found in Alpaca dashboard under Paper Account</p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-white mb-1">Nickname</label>
                    <input 
                        type="text" 
                        name="nickname" 
                        required
                        placeholder="My Paper Account"
                        class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white focus:border-primary focus:ring-2 focus:ring-primary/20">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-white mb-1">API Key</label>
                    <input 
                        type="text" 
                        name="api_key" 
                        required
                        placeholder="PKTF3RBJANWKGWWDY62FA2377W"
                        class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white focus:border-primary focus:ring-2 focus:ring-primary/20 font-mono text-sm">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-white mb-1">API Secret</label>
                    <input 
                        type="password" 
                        name="api_secret" 
                        required
                        placeholder="••••••••"
                        class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white focus:border-primary focus:ring-2 focus:ring-primary/20 font-mono text-sm">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-white mb-1">Base URL</label>
                    <input 
                        type="text" 
                        name="base_url" 
                        value="https://paper-api.alpaca.markets"
                        class="w-full px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white focus:border-primary focus:ring-2 focus:ring-primary/20 font-mono text-xs">
                </div>
                
                <div class="flex items-center gap-2">
                    <input 
                        type="checkbox" 
                        name="is_active" 
                        id="is_active"
                        value="true"
                        class="w-4 h-4 rounded border-white/20 bg-white/5 text-primary focus:ring-primary">
                    <label for="is_active" class="text-sm text-white">Set as active account</label>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button 
                        type="submit"
                        class="flex-1 btn-primary py-2">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                        Save Account
                    </button>
                    <button 
                        type="button"
                        onclick="this.closest('dialog').close()"
                        class="btn-glass px-4 py-2">
                        Cancel
                    </button>
                </div>
            </div>
        </form>
    </div>
</dialog>

<script>
function deleteAccount(accountId, nickname) {
    if (confirm(`Delete account "${nickname}"?\n\nThis will remove the account configuration but will not affect your Alpaca account.`)) {
        htmx.ajax('POST', '/api/alpaca-accounts/delete', {
            values: {account_id: accountId},
            swap: 'none',
            trigger: 'accountUpdated'
        });
    }
}

// Refresh accounts list when updated
document.body.addEventListener('accountUpdated', function() {
    htmx.trigger('#alpaca-accounts-container', 'load');
});

// Refresh balance when account changes
document.body.addEventListener('balanceRefresh', function() {
    htmx.trigger('#account-info', 'load');
    htmx.trigger('#account-info-mobile', 'load');
});
</script>
