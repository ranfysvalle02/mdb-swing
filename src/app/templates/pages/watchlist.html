<div class="glass-panel rounded-2xl p-4 border border-blue-500/20 relative overflow-hidden" 
     role="region" 
     aria-label="Watch list" 
     id="watch-list"
     x-data="{ 
         currentConfigHash: '{{ config_hash|default('unknown') }}',
         lastEvaluatedHash: localStorage.getItem('lastEvaluatedConfigHash') || null,
         needsReevaluation: false,
         init() {
             // Check if config hash changed
             if (this.lastEvaluatedHash && this.currentConfigHash !== this.lastEvaluatedHash) {
                 this.needsReevaluation = true;
             }
             // Store current hash for next comparison
             if (this.currentConfigHash && this.currentConfigHash !== 'unknown') {
                 localStorage.setItem('lastEvaluatedConfigHash', this.currentConfigHash);
             }
         }
     }"
     data-config-hash="{{ config_hash|default('unknown') }}">
    <!-- Loading Overlay -->
    <div id="watchlist-loading-overlay" 
         class="htmx-indicator absolute inset-0 bg-gray-900/95 backdrop-blur-md rounded-2xl z-30 flex flex-col items-center justify-center transition-all duration-300"
         style="opacity: 0; pointer-events: none;">
        <div class="text-center space-y-4">
            <!-- Animated Spinner -->
            <div class="relative">
                <div class="w-16 h-16 border-4 border-cyan-500/30 rounded-full"></div>
                <div class="w-16 h-16 border-4 border-transparent border-t-cyan-400 rounded-full animate-spin absolute top-0 left-0"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <i data-lucide="refresh-cw" class="w-6 h-6 text-cyan-400 animate-spin"></i>
                </div>
            </div>
            <!-- Loading Text -->
            <div class="space-y-1">
                <p class="text-lg font-bold text-white">Re-evaluating Watchlist</p>
                <p class="text-sm text-gray-400">Updating with new strategy parameters...</p>
            </div>
            <!-- Progress Bar -->
            <div class="w-64 h-1.5 bg-gray-800/50 rounded-full overflow-hidden">
                <div class="watchlist-progress-bar h-full bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-500 rounded-full animate-progress"></div>
            </div>
        </div>
    </div>
    
    <!-- Shimmer Effect During Loading -->
    <div id="watchlist-shimmer" 
         class="htmx-indicator absolute inset-0 opacity-0 pointer-events-none z-20"
         style="background: linear-gradient(90deg, transparent 0%, rgba(0, 240, 255, 0.1) 50%, transparent 100%); background-size: 200% 100%; animation: shimmer 2s infinite;">
    </div>
    
    <!-- Compact Header with Ready Count -->
    <div class="flex items-center justify-between mb-1 relative z-10">
        <div class="flex items-center gap-1.5">
            <i data-lucide="list" class="text-blue-400 w-3.5 h-3.5" aria-hidden="true"></i>
            <h3 class="text-xs text-gray-300 font-semibold">Watch List</h3>
            {% if ready_count > 0 %}
            <span class="text-[10px] text-green-400 font-semibold ml-1.5" aria-label="{{ ready_count }} {% if ready_count == 1 %}candidate{% else %}candidates{% endif %} ready">({{ ready_count }} {% if ready_count == 1 %}candidate{% else %}candidates{% endif %})</span>
            {% endif %}
        </div>
        <div class="flex items-center gap-2">
            <!-- Evaluation Metadata -->
            <div x-data="{ 
                lastEvaluated: {% if evaluation_timestamp %}'{{ evaluation_timestamp }}'{% else %}null{% endif %},
                symbolCount: {{ symbols|length }},
                readyCount: {{ ready_count }},
                timeAgo(lastEvaluated) {
                    if (!lastEvaluated) return 'Never';
                    const now = new Date();
                    const evaluated = new Date(lastEvaluated);
                    const diffMs = now - evaluated;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffSecs = Math.floor((diffMs % 60000) / 1000);
                    if (diffMins < 1) return diffSecs + 's ago';
                    if (diffMins < 60) return diffMins + 'm ago';
                    const diffHours = Math.floor(diffMins / 60);
                    if (diffHours < 24) return diffHours + 'h ago';
                    const diffDays = Math.floor(diffHours / 24);
                    return diffDays + 'd ago';
                }
            }" 
            class="text-[10px] text-gray-500">
                <span x-show="lastEvaluated" class="flex items-center gap-1">
                    <i data-lucide="clock" class="w-3 h-3"></i>
                    <span>Updated <span x-text="timeAgo(lastEvaluated)"></span></span>
                </span>
                <span x-show="!lastEvaluated" class="text-gray-600">Not evaluated</span>
            </div>
            <span class="text-[10px] text-gray-400" aria-label="{{ symbols|length }} {% if symbols|length == 1 %}ticker{% else %}tickers{% endif %} in watch list">{{ symbols|length }} {% if symbols|length == 1 %}ticker{% else %}tickers{% endif %}</span>
        </div>
    </div>
    
    <!-- Re-evaluate Button (shown when strategy changes - manual trigger only) -->
    <div id="reevaluate-watchlist-container" 
         x-data="{ show: false }"
         x-show="show"
         x-cloak
         x-transition:enter="transition ease-out duration-500"
         x-transition:enter-start="opacity-0 transform scale-95 translate-y-4"
         x-transition:enter-end="opacity-100 transform scale-100 translate-y-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95"
         class="mb-3 relative"
         style="display: none;">
        <!-- Alert Badge -->
        <div class="absolute -top-2 -right-2 z-30">
            <div class="reevaluate-badge animate-bounce">
                <span class="text-xs font-bold">!</span>
            </div>
        </div>
        
        <!-- Notification Banner -->
        <div class="reevaluate-notification mb-2 px-3 py-2 rounded-lg bg-cyan-500/10 border border-cyan-500/30 flex items-center gap-2 animate-pulse-slow">
            <i data-lucide="alert-circle" class="w-4 h-4 text-cyan-400 flex-shrink-0"></i>
            <div class="flex-1">
                <span id="changed-params-indicator" class="text-xs text-cyan-300 font-medium block">
                    Click below to re-evaluate watchlist with new settings.
                </span>
            </div>
        </div>
        
        <button 
            id="reevaluate-watchlist-btn"
            hx-get="/api/watch-list"
            hx-target="#watch-list"
            hx-swap="innerHTML"
            hx-indicator="#watchlist-loading-overlay"
            hx-disabled-elt="this, #add-ticker-form, .ticker-card, .remove-ticker-btn, #watchlist-scroll-left, #watchlist-scroll-right"
            @click="show = false"
            class="reevaluate-btn w-full px-5 py-4 rounded-lg font-bold text-base text-white flex items-center justify-center gap-3 transition-all duration-300 relative overflow-hidden group cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
            <span class="relative z-10 flex items-center gap-3">
                <i data-lucide="refresh-cw" class="w-5 h-5 htmx-indicator-hidden animate-spin-slow"></i>
                <span class="htmx-indicator-hidden">Re-evaluate Watchlist Now</span>
                <span class="htmx-indicator">Re-evaluating...</span>
            </span>
        </button>
    </div>
    
    {% if ready_count > 0 %}
    <div class="text-[11px] text-green-400 mb-1.5 flex items-center gap-2 px-3 py-2 rounded-lg bg-green-500/10 border border-green-500/30" role="status" aria-live="polite">
        <i data-lucide="sparkles" class="w-4 h-4 text-green-400" aria-hidden="true"></i>
        <span class="font-semibold"><span class="text-green-300">{{ ready_count }}</span> {% if ready_count == 1 %}candidate ready{% else %}candidates ready{% endif %} - Click green cards to analyze</span>
    </div>
    {% else %}
    <div class="text-[11px] text-gray-500 mb-1.5 flex items-center gap-2 px-3 py-2 rounded-lg bg-gray-800/30 border border-gray-700/30" role="status" aria-live="polite">
        <i data-lucide="info" class="w-4 h-4" aria-hidden="true"></i>
        <span>Add stocks - candidates (RSI &lt; {{ rsi_threshold|default(35) }}, uptrend) will appear with green highlight</span>
    </div>
    {% endif %}
    
    <!-- Single Row Horizontal Scroll Layout for Ticker Cards -->
    <div class="relative mb-1.5 htmx-request:opacity-40 htmx-request:blur-sm transition-all duration-300" id="watchlist-scroll-wrapper">
        <button 
            id="watchlist-scroll-left" 
            class="watchlist-nav-btn watchlist-nav-btn-left watchlist-interactive-element" 
            aria-label="Scroll left"
            disabled>
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
        </button>
        <div class="watchlist-scroll-container flex flex-row gap-3 px-10 transition-all duration-300" id="ticker-cards-container" role="list" aria-label="Watch list ticker cards">
            {% if preview_data %}
                {% for card in preview_data %}
                    {# Use pre-calculated values from backend - no need to recalculate #}
                    {% set symbol = card.symbol %}
                    {% set price = card.get('price') %}
                    {% set rsi = card.get('rsi') %}
                    {% set trend = card.get('trend') %}
                    {% set meets_criteria = card.get('meets_criteria', false) %}
                    {% set error = card.get('error') %}
                    {% set rsi_color = card.get('rsi_color', 'text-gray-400') %}
                    {% set trend_icon = card.get('trend_icon', 'minus') %}
                    {% set trend_color = card.get('trend_color', 'text-gray-400') %}
                    {% set border_class = card.get('border_class', 'border-blue-500/30') %}
                    {% set bg_class = card.get('bg_class', 'bg-blue-500/5') %}
                    {% set sma_200 = card.get('sma_200') %}
                    {% set atr = card.get('atr') %}
                    {% set price_vs_sma_pct = card.get('price_vs_sma_pct') %}
                    {% set price_vs_sma_color = card.get('price_vs_sma_color', 'text-gray-400') %}
                    {% set price_vs_sma_icon = card.get('price_vs_sma_icon', 'minus') %}
                    {% set rejection_reason = card.get('rejection_reason') %}
                    {% set rsi_progress_pct = card.get('rsi_progress_pct') %}
                    {% set sma_progress_pct = card.get('sma_progress_pct') %}
                    {% set volume = card.get('volume') %}
                    {% set earnings_in_days = card.get('earnings_in_days') %}
                    {% set pe_ratio = card.get('pe_ratio') %}
                    {% set market_cap = card.get('market_cap') %}
                    {% set logo_svg = card.get('logo_svg') %}
                    {% set rsi_threshold = rsi_threshold|default(35) %}
                    {% set sma_proximity_pct = sma_proximity_pct|default(3.0) %}
                    {% include "components/watchlist_card.html" %}
                {% endfor %}
            {% elif symbols %}
                {% for symbol in symbols %}
                    {% set price = none %}
                    {% set rsi = none %}
                    {% set trend = none %}
                    {% set meets_criteria = false %}
                    {% set rsi_color = "text-gray-400" %}
                    {% set trend_icon = "minus" %}
                    {% set trend_color = "text-gray-400" %}
                    {% set border_class = "border-blue-500/30" %}
                    {% set bg_class = "bg-blue-500/5" %}
                    {% include "components/watchlist_card.html" %}
                {% endfor %}
            {% else %}
                <div class="flex-shrink-0 w-full text-center py-3 text-gray-400" role="status" aria-live="polite">
                    <i data-lucide="eye-off" class="w-4 h-4 mx-auto mb-1" aria-hidden="true"></i>
                    <p class="text-[10px]">No tickers yet</p>
                </div>
            {% endif %}
        </div>
        <button 
            id="watchlist-scroll-right" 
            class="watchlist-nav-btn watchlist-nav-btn-right watchlist-interactive-element" 
            aria-label="Scroll right"
            disabled>
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
        </button>
    </div>
    
    <!-- Compact Add Ticker -->
    <form 
        id="add-ticker-form"
        hx-post="/api/watch-list"
        hx-target="#watch-list"
        hx-swap="innerHTML"
        hx-indicator="#watchlist-loading-overlay"
        class="flex gap-1.5 relative z-10 watchlist-interactive-element">
        <div class="flex-1">
            <input 
                type="text" 
                id="add-ticker-input" 
                name="symbol"
                class="w-full px-2 py-1.5 rounded-lg text-xs text-white font-mono uppercase watchlist-interactive-element"
                placeholder="Add ticker..."
                maxlength="5"
                style="text-transform: uppercase;"
                autocomplete="off"
                aria-label="Add ticker symbol"
                aria-describedby="ticker-input-help"
            />
            <input type="hidden" name="action" value="add">
            <div id="ticker-input-help" class="sr-only">Enter a stock ticker symbol to add to watch list</div>
        </div>
        <button 
            type="submit"
            id="add-ticker-btn"
            class="btn-glass px-3 py-1.5 rounded-lg text-xs font-semibold text-white hover:bg-blue-600/30 transition-all border border-blue-500/30 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed watchlist-interactive-element"
            aria-label="Add ticker to watch list">
            <span id="add-ticker-loading" class="htmx-indicator">
                <i data-lucide="loader-2" class="w-3.5 h-3.5 lucide-spin"></i>
            </span>
            <i data-lucide="plus" class="w-3.5 h-3.5 htmx-indicator-hidden"></i>
        </button>
    </form>
</div>
{% include "scripts/watchlist_dropdown.html" %}
