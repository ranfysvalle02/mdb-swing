<div class="glass-panel rounded-xl overflow-hidden border border-purple-500/30 relative" 
     x-data="{ collapsed: false }"
     data-current-preset="{{ current_preset|default('Buy Low') }}">
    {# Loading Indicator Overlay #}
    <div id="signal-hunter-section-loading" class="htmx-indicator absolute inset-0 bg-gray-900/90 backdrop-blur-md rounded-xl z-30 flex items-center justify-center">
        <div class="flex flex-col items-center gap-3">
            <i data-lucide="loader-2" class="w-6 h-6 text-purple-400 animate-spin"></i>
            <span class="text-sm text-gray-300 font-medium" id="loading-message">Loading preset...</span>
            {% if current_preset == 'Catch Momentum' %}
            <span class="text-xs text-yellow-400 font-medium animate-pulse">This may take 30-60 seconds...</span>
            {% endif %}
        </div>
    </div>
    
    {# Compact Header #}
    <div class="border-b border-purple-500/20 bg-gradient-to-r from-purple-500/10 to-pink-500/10 flex-shrink-0">
        <div class="flex items-center justify-between px-2.5 py-1">
            <div class="flex items-center gap-1.5 flex-1 min-w-0">
                <i data-lucide="radar" class="w-3 h-3 text-purple-400 flex-shrink-0"></i>
                <h2 class="text-[11px] font-bold text-white">SIGNAL HUNTER</h2>
                <span class="text-[9px] text-gray-400">({{ strategy_name|default('Default') }})</span>
            </div>
            <div class="flex items-center gap-1.5 flex-shrink-0 overflow-x-auto" style="scrollbar-width: thin;">
                {% for preset_name in presets.keys() %}
                <button
                    hx-get="/api/signal-hunter-section?preset_name={{ preset_name }}"
                    hx-target="#signal-hunter-section-wrapper"
                    hx-swap="innerHTML"
                    hx-indicator="#signal-hunter-section-loading"
                    hx-on::before-request="document.getElementById('loading-message').textContent = 'Loading {{ preset_name }}...';"
                    @click.stop
                    class="px-2 py-1 bg-gradient-to-r {% if current_preset == preset_name %}from-purple-500/30 to-pink-500/30 border-purple-500/60 text-purple-300{% else %}from-gray-800/50 to-gray-700/50 border-gray-700/50 text-gray-300 hover:from-gray-700/60 hover:to-gray-600/60{% endif %} border rounded text-xs font-semibold transition-all whitespace-nowrap flex-shrink-0">
                    {{ preset_name }}
                </button>
                {% endfor %}
                <button
                    hx-get="/api/signal-hunter-modal"
                    hx-target="#modal-container"
                    hx-swap="innerHTML"
                    @click.stop
                    class="px-2 py-1 bg-gradient-to-r from-orange-500/30 to-yellow-500/30 border-orange-500/60 text-orange-300 border rounded text-xs font-semibold transition-all whitespace-nowrap flex-shrink-0 hover:from-orange-500/40 hover:to-yellow-500/40"
                    title="Open custom filter builder">
                    <i data-lucide="sliders-horizontal" class="w-3 h-3 inline-block"></i>
                    Custom
                </button>
                <button
                    id="signal-hunter-refresh-btn"
                    hx-get="/api/signal-hunter-section?preset_name={{ current_preset|default('Buy Low') }}"
                    hx-target="#signal-hunter-section-wrapper"
                    hx-swap="innerHTML"
                    hx-indicator="#signal-hunter-section-loading"
                    hx-on::before-request="document.getElementById('loading-message').textContent = 'Refreshing {{ current_preset|default('Buy Low') }}...'"
                    @click.stop
                    class="p-1 rounded hover:bg-purple-500/30 transition-all text-gray-400 hover:text-purple-300 border border-transparent hover:border-purple-500/50"
                    aria-label="Refresh Signal Hunter"
                    title="Refresh current preset">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
                <button 
                    @click="collapsed = !collapsed"
                    class="p-1 rounded hover:bg-gray-700/50 transition-all text-gray-400 hover:text-white"
                    aria-label="Toggle collapse">
                    <i data-lucide="chevron-down" 
                       class="w-4 h-4 transition-transform duration-200"
                       :class="collapsed ? '-rotate-180' : ''"></i>
                </button>
            </div>
        </div>
    </div>
    
    {# Results Grid - Collapsible Horizontal Scroll #}
    <div id="signal-hunter-content" 
         x-show="!collapsed"
         x-cloak
         class="overflow-hidden">
        {% if results and results|length > 0 %}
            {% set candidate_count = results|selectattr('is_candidate')|list|length %}
            
            <!-- Signal Hunter Cards Container - Compact but Usable -->
            <div class="h-10">
                <div class="signal-hunter-scroll-container flex flex-row gap-2 px-3 overflow-x-auto h-full items-center" 
                     id="signal-hunter-cards-container" 
                     role="list" 
                     aria-label="Signal Hunter stock cards"
                     style="scrollbar-width: thin; scrollbar-color: rgba(112, 0, 255, 0.3) transparent;">
                    {% for stock in results %}
                    <div class="signal-hunter-card glass rounded-lg border-2 {% if stock.is_candidate %}border-green-500/70 bg-green-500/15 shadow-green-500/10{% else %}border-gray-700/50 bg-gray-800/25{% endif %} min-w-[13rem] h-10 flex flex-row items-center gap-2 px-3 flex-shrink-0 hover:scale-[1.02] hover:shadow-md transition-all cursor-pointer group"
                         {% if stock.is_candidate %}
                         hx-get="/api/analysis-preview?symbol={{ stock.symbol }}"
                         hx-target="#modal-container"
                         hx-swap="innerHTML"
                         {% endif %}>
                        {# Left: Symbol + Candidate Status #}
                        <div class="flex items-center gap-1.5 flex-shrink-0">
                            <div class="font-bold text-white text-sm group-hover:text-purple-300 transition-colors leading-none min-w-[3.5rem]">{{ stock.symbol }}</div>
                        </div>
                        
                        {# Center: Key Metrics #}
                        <div class="flex items-center gap-1.5 flex-1 min-w-0">
                            {# RSI - Most Important #}
                            {% set stock_rsi = stock.rsi|default(None) %}
                            {% if stock_rsi is not none %}
                            <div class="px-1.5 py-0.5 rounded text-[10px] font-bold leading-none {% if stock_rsi < 35 %}text-green-400 bg-green-500/15 border border-green-500/40{% elif stock_rsi > 65 %}text-red-400 bg-red-500/15 border border-red-500/40{% else %}text-gray-400 bg-gray-700/30 border border-gray-600/30{% endif %}">
                                RSI {{ "%.0f"|format(stock_rsi) }}
                            </div>
                            {% endif %}
                            
                            {# Price vs SMA-200 % - Critical for strategy #}
                            {% set stock_sma_pct = stock.price_vs_sma_200_pct|default(None) %}
                            {% if stock_sma_pct is not none %}
                            <div class="px-1.5 py-0.5 rounded text-[10px] font-semibold leading-none {% if stock_sma_pct <= 5 and stock_sma_pct >= -2 %}text-green-400 bg-green-500/15 border border-green-500/40{% else %}text-gray-400 bg-gray-700/30 border border-gray-600/30{% endif %}">
                                {% if stock_sma_pct > 0 %}+{% endif %}{{ "%.1f"|format(stock_sma_pct) }}%
                            </div>
                            {% endif %}
                            
                            {# Price #}
                            {% set stock_price = stock.price|default(None) %}
                            {% if stock_price %}
                            <div class="text-xs font-semibold text-white leading-none whitespace-nowrap">${{ "%.2f"|format(stock_price) }}</div>
                            {% endif %}
                        </div>
                        
                        {# Right: Actions - Show add or remove based on watchlist status #}
                        <div class="flex items-center gap-1 flex-shrink-0">
                            {% if stock.symbol in watchlist_symbols %}
                            {# Already in watchlist - Show remove button #}
                            <button 
                                hx-post="/api/watch-list"
                                hx-vals='{"action": "remove", "symbol": "{{ stock.symbol }}"}'
                                hx-target="#watch-list"
                                hx-swap="innerHTML"
                                hx-indicator="#watchlist-loading-overlay"
                                hx-confirm="Remove {{ stock.symbol|e }} from watchlist?"
                                hx-on::after-request="
                                    if(event.detail.successful) {
                                        htmx.trigger('body', 'showToast', {
                                            detail: {message: '{{ stock.symbol|e }} removed from watchlist', type: 'success'}
                                        });
                                    }
                                "
                                @click.stop
                                class="px-2 py-1 rounded text-[10px] bg-red-500/20 hover:bg-red-500/30 text-red-300 border border-red-500/50 transition-all font-semibold leading-none flex items-center justify-center gap-1 z-10 relative hover:shadow-sm"
                                title="Remove {{ stock.symbol|e }} from watchlist">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                            {% else %}
                            {# Not in watchlist - Show add button #}
                            <button 
                                hx-post="/api/watch-list"
                                hx-vals='{"action": "add", "symbol": "{{ stock.symbol }}"}'
                                hx-target="#watch-list"
                                hx-swap="innerHTML"
                                hx-indicator="#watchlist-loading-overlay"
                                hx-on::after-request="
                                    if(event.detail.successful) {
                                        htmx.trigger('body', 'showToast', {
                                            detail: {message: '{{ stock.symbol|e }} added to watchlist', type: 'success'}
                                        });
                                    }
                                "
                                @click.stop
                                class="px-2 py-1 rounded text-[10px] bg-purple-500/20 hover:bg-purple-500/30 text-purple-300 border border-purple-500/50 transition-all font-semibold leading-none flex items-center justify-center gap-1 z-10 relative hover:shadow-sm"
                                title="Add {{ stock.symbol|e }} to watchlist">
                                <i data-lucide="plus" class="w-3 h-3"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            {% if candidate_count > 0 %}
            <div class="text-[10px] text-green-400 px-3 pb-1 pt-0.5 flex items-center gap-1 border-t border-green-500/20">
                <i data-lucide="sparkles" class="w-2.5 h-2.5 text-green-400"></i>
                <span><span class="text-green-300 font-semibold">{{ candidate_count }}</span> candidate{{ 's' if candidate_count != 1 else '' }}</span>
            </div>
            {% endif %}
        {% else %}
            <div class="text-center py-1 text-gray-400">
                <i data-lucide="inbox" class="w-4 h-4 mx-auto mb-0.5 text-gray-600"></i>
                <p class="text-[9px]">No stocks found</p>
                <p class="text-[8px] text-gray-500 mt-0.5">Try a different preset</p>
            </div>
        {% endif %}
    </div>
</div>


{% include "scripts/lucide_init.html" %}
