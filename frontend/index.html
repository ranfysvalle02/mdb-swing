<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLUX - Swing Trading Evolved</title>
    <!-- Design System CSS -->
    <link rel="stylesheet" href="/static/css/flux-design-system.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script>
        // Suppress Tailwind CDN production warning BEFORE loading Tailwind
        (function() {
            // Override console methods before Tailwind loads
            const originalWarn = console.warn;
            const originalError = console.error;
            
            console.warn = function(...args) {
                const message = args[0];
                if (message && typeof message === 'string' && (
                    message.includes('cdn.tailwindcss.com') || 
                    message.includes('should not be used in production') ||
                    message.includes('Tailwind CSS')
                )) {
                    return; // Suppress Tailwind CDN warning
                }
                originalWarn.apply(console, args);
            };
            
            console.error = function(...args) {
                const message = args[0];
                // Only suppress Tailwind CDN warnings, NOT syntax errors or HTMX errors
                if (message && typeof message === 'string' && (
                    (message.includes('cdn.tailwindcss.com') || 
                     message.includes('should not be used in production') ||
                     message.includes('Tailwind CSS')) &&
                    !message.includes('SyntaxError') &&
                    !message.includes('htmx:syntax:error') &&
                    !message.includes('Invalid or unexpected token')
                )) {
                    return; // Suppress Tailwind CDN error
                }
                originalError.apply(console, args);
            };
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        // Configure HTMX to handle script errors gracefully
        if (typeof htmx !== 'undefined') {
            // Override HTMX's script processing to catch errors
            htmx.on('htmx:syntax:error', function(event) {
                console.error('HTMX syntax error:', event.detail);
                // Don't prevent the swap, just log the error
                return true;
            });
            
            // Also catch errors during script evaluation
            document.addEventListener('htmx:afterSwap', function(event) {
                // Scripts are executed automatically by HTMX, errors are caught by global handler
                
                // Refresh Lucide icons after any swap
                setTimeout(() => {
                    if (typeof window.refreshLucideIcons === 'function') {
                        window.refreshLucideIcons();
                    } else if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 100);
                
                // Re-initialize Alpine.js for newly swapped content
                if (typeof Alpine !== 'undefined') {
                    try {
                        const target = event.detail.target;
                        if (!target) return;
                        
                        // CRITICAL: Signal Hunter section needs immediate initialization
                        // to prevent "collapsed is not defined" errors
                        if (target.id === 'signal-hunter-section-wrapper' || target.closest('#signal-hunter-section-wrapper')) {
                            // Initialize immediately - find the x-data element
                            const alpineElement = target.querySelector('[x-data]') || target.querySelector('.glass-panel[x-data]');
                            if (alpineElement && typeof Alpine.initTree === 'function') {
                                try {
                                    Alpine.initTree(alpineElement);
                                } catch (e) {
                                    console.warn('Error initializing Alpine on signal hunter section:', e);
                                    // Fallback to initializing on target
                                    Alpine.initTree(target);
                                }
                            }
                            return; // Early return - don't use setTimeout for signal hunter
                        }
                        
                        // For other swaps, use setTimeout for DOM readiness
                        setTimeout(() => {
                            if (typeof Alpine.initTree === 'function') {
                                // If modal-container, initialize Alpine on the dialog content
                                if (target && target.id === 'modal-container') {
                                    const dialog = target.querySelector('dialog.htmx-modal');
                                    if (dialog) {
                                        // Initialize Alpine on the modal body content
                                        const modalBody = dialog.querySelector('.htmx-modal-body');
                                        if (modalBody) {
                                            // Check for strategy builder wizard specifically
                                            const wizard = modalBody.querySelector('.strategy-builder-wizard');
                                            if (wizard) {
                                                try {
                                                    Alpine.initTree(wizard);
                                                } catch (e) {
                                                    console.error('Error initializing strategy builder wizard:', e);
                                                    // Fallback to initializing the whole modal body
                                                    Alpine.initTree(modalBody);
                                                }
                                            } else {
                                                // Check if there's an element with x-data - initialize that first
                                                const alpineElement = modalBody.querySelector('[x-data]');
                                                if (alpineElement) {
                                                    try {
                                                        Alpine.initTree(alpineElement);
                                                    } catch (e) {
                                                        console.warn('Error initializing Alpine on x-data element:', e);
                                                        // Fallback to modal body
                                                        Alpine.initTree(modalBody);
                                                    }
                                                } else {
                                                    // No x-data element, initialize on modal body
                                                    Alpine.initTree(modalBody);
                                                }
                                            }
                                        } else {
                                            Alpine.initTree(dialog);
                                        }
                                    } else {
                                        // No dialog found, try initializing directly on target
                                        Alpine.initTree(target);
                                    }
                                } else {
                                    // Normal swap - initialize on target
                                    // Check for x-data elements first
                                    const alpineElement = target.querySelector('[x-data]');
                                    if (alpineElement) {
                                        try {
                                            Alpine.initTree(alpineElement);
                                        } catch (e) {
                                            console.warn('Error initializing Alpine on x-data element:', e);
                                            Alpine.initTree(target);
                                        }
                                    } else {
                                        Alpine.initTree(target);
                                    }
                                }
                            }
                        }, 100); // Increased delay to ensure DOM is ready
                    } catch (e) {
                        console.error('Alpine.js initialization error:', e);
                    }
                }
            });
            
            // Prevent duplicate toasts - check after swap completes (safer approach)
            document.addEventListener('htmx:afterSwap', function(event) {
                // After swap, check for duplicate toasts by comparing data attributes
                // This avoids CSS selector issues with special characters in messages
                try {
                    const allToasts = document.querySelectorAll('.toast[data-toast-message]');
                    const messageMap = new Map();
                    
                    allToasts.forEach((toast, index) => {
                        const message = toast.getAttribute('data-toast-message');
                        if (message) {
                            const normalizedMessage = message.replace(/\s+/g, ' ').trim();
                            if (messageMap.has(normalizedMessage)) {
                                // Duplicate found - remove the older one
                                const olderToast = messageMap.get(normalizedMessage);
                                olderToast.classList.add('fade-out');
                                setTimeout(() => {
                                    if (olderToast && olderToast.parentNode) {
                                        olderToast.remove();
                                    }
                                }, 100);
                            }
                            messageMap.set(normalizedMessage, toast);
                        }
                    });
                } catch (e) {
                    // If anything fails, just skip duplicate check - toasts will still work
                    // This is non-critical functionality
                }
            });
            
            // ============================================
            // CLEAN HTMX MODAL SYSTEM - Event Handlers
            // ============================================
            
            // Clean modal close function with exit animations
            function closeHtmxModal(dialog) {
                if (!dialog) return;
                
                // Add closing class for exit animation
                dialog.classList.add('closing');
                
                // Close immediately (removes backdrop)
                dialog.close();
                
                // Wait for exit animation to complete, then remove from DOM
                setTimeout(() => {
                    // Remove closing class
                    dialog.classList.remove('closing');
                    
                    // Remove from DOM after animation
                    if (dialog && dialog.parentNode) {
                        dialog.remove();
                    }
                    
                    // Unlock body scroll if no modals remain
                    const remainingModals = document.querySelectorAll('dialog.htmx-modal[open]');
                    if (remainingModals.length === 0 && document.body) {
                        document.body.style.overflow = '';
                    }
                }, 200); // Match exit animation duration
            }
            
            // Make function globally available
            window.closeHtmxModal = closeHtmxModal;
            
            // Show loading state during HTMX request
            // Removed duplicate loading handler - handled by the main beforeRequest handler below
            
            // When HTMX inserts a modal dialog, open it automatically
            document.addEventListener('htmx:afterSwap', function(event) {
                const target = event.detail.target;
                const modalContainer = document.getElementById('modal-container');
                let dialog = null;
                
                // Check if target is the dialog itself (happens with beforeend swap)
                if (target && target.tagName === 'DIALOG' && target.classList.contains('htmx-modal')) {
                    dialog = target;
                }
                // Check if target is modal-container (direct swap)
                else if (target && target.id === 'modal-container') {
                    dialog = target.querySelector('dialog.htmx-modal:not([open])');
                }
                // Check if target is inside modal-container (beforeend swap into container)
                else if (target && target.closest && target.closest('#modal-container')) {
                    dialog = modalContainer ? modalContainer.querySelector('dialog.htmx-modal:not([open])') : null;
                }
                // Fallback: always check modal-container for any new unopened dialogs
                if (!dialog && modalContainer) {
                    // Find the most recent dialog that's not the loading one
                    const allDialogs = Array.from(modalContainer.querySelectorAll('dialog.htmx-modal'));
                    // Filter out loading modal and already-open dialogs, get the last one
                    const unopenedDialogs = allDialogs.filter(d => !d.open && d.id !== 'loading-modal');
                    dialog = unopenedDialogs.length > 0 ? unopenedDialogs[unopenedDialogs.length - 1] : null;
                }
                
                // Always remove loading dialog when real modal arrives
                const loadingDialog = document.getElementById('loading-modal');
                if (loadingDialog) {
                    loadingDialog.remove();
                }
                
                if (dialog) {
                    
                    // Close any other existing dialogs to prevent conflicts
                    const existingDialogs = document.querySelectorAll('dialog.htmx-modal[open]');
                    existingDialogs.forEach(existingDialog => {
                        try {
                            if (existingDialog.open && existingDialog !== dialog && existingDialog.id !== 'loading-modal') {
                                existingDialog.close();
                            }
                        } catch (e) {
                            // Ignore errors when closing
                        }
                    });
                    
                    // Remove loading state if present
                    dialog.classList.remove('htmx-modal-loading');
                    
                    // Function to safely show modal
                    const showModalSafely = () => {
                        // Verify dialog is in document before showing
                        if (!document.contains(dialog)) {
                            // If not attached, wait for next frame and retry
                            requestAnimationFrame(() => {
                                if (document.contains(dialog)) {
                                    try {
                                        // Ensure no other dialogs are open
                                        const otherDialogs = document.querySelectorAll('dialog.htmx-modal[open]');
                                        otherDialogs.forEach(d => {
                                            if (d !== dialog && d.open) {
                                                d.close();
                                            }
                                        });
                                        dialog.showModal();
                                        if (document.body) {
                                            document.body.style.overflow = 'hidden';
                                        }
                                    } catch (e) {
                                        console.error('Failed to show modal:', e);
                                    }
                                } else {
                                    // Still not attached, try one more time after a small delay
                                    setTimeout(() => {
                                        if (document.contains(dialog)) {
                                            try {
                                                // Ensure no other dialogs are open
                                                const otherDialogs = document.querySelectorAll('dialog.htmx-modal[open]');
                                                otherDialogs.forEach(d => {
                                                    if (d !== dialog && d.open) {
                                                        d.close();
                                                    }
                                                });
                                                dialog.showModal();
                                                if (document.body) {
                                                    document.body.style.overflow = 'hidden';
                                                }
                                            } catch (e) {
                                                console.error('Failed to show modal after retry:', e);
                                            }
                                        }
                                    }, 50);
                                }
                            });
                            return;
                        }
                        
                        // Dialog is attached, ensure no other dialogs are open, then show it
                        try {
                            // Close any other open dialogs
                            const otherDialogs = document.querySelectorAll('dialog.htmx-modal[open]');
                            otherDialogs.forEach(d => {
                                if (d !== dialog && d.open) {
                                    d.close();
                                }
                            });
                            
                            // Small delay to ensure other dialogs are closed
                            setTimeout(() => {
                                if (document.contains(dialog) && !dialog.open) {
                                    dialog.showModal();
                                    
                                    // Lock body scroll
                                    if (document.body) {
                                        document.body.style.overflow = 'hidden';
                                    }
                                    
                                    // Initialize Lucide icons in the modal
                                    setTimeout(() => {
                                        if (typeof lucide !== 'undefined') {
                                            lucide.createIcons();
                                        }
                                    }, 50);
                                }
                            }, 50);
                        } catch (e) {
                            console.error('Failed to show modal:', e);
                        }
                    };
                    
                    // Use requestAnimationFrame to ensure smooth animation start
                    requestAnimationFrame(showModalSafely);
                }
            });
            
            // Additional handler for afterSettle to ensure Alpine initializes in modals
            document.addEventListener('htmx:afterSettle', function(event) {
                const target = event.detail.target;
                
                // If modal-container, ensure Alpine initializes on modal content
                if (target && target.id === 'modal-container') {
                    if (typeof Alpine !== 'undefined' && typeof Alpine.initTree === 'function') {
                        setTimeout(() => {
                            try {
                                const dialog = target.querySelector('dialog.htmx-modal');
                                if (dialog) {
                                    const modalBody = dialog.querySelector('.htmx-modal-body');
                                    if (modalBody) {
                                        // Initialize Alpine on modal body content
                                        Alpine.initTree(modalBody);
                                    }
                                }
                            } catch (e) {
                                console.debug('Alpine init error in modal:', e);
                            }
                        }, 150);
                    }
                }
            });
            
            // Setup modal close handlers - use event delegation on document
            // This works even if modals are added dynamically
            document.addEventListener('click', function(event) {
                // Handle modal close button clicks (handles clicks on icon inside button)
                const closeBtn = event.target.closest('.htmx-modal-close');
                if (closeBtn) {
                    const dialog = closeBtn.closest('dialog.htmx-modal');
                    if (dialog) {
                        event.preventDefault();
                        event.stopPropagation();
                        closeHtmxModal(dialog);
                        return;
                    }
                }
                
                // Handle clicking backdrop to close modal
                // When clicking on dialog backdrop, event.target is the dialog element itself
                if (event.target.tagName === 'DIALOG' && event.target.classList.contains('htmx-modal')) {
                    // Clicked directly on dialog (backdrop), not on content inside
                    closeHtmxModal(event.target);
                }
            });
            
            // Handle ESC key to close modal
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const openDialog = document.querySelector('dialog.htmx-modal[open]');
                    if (openDialog) {
                        closeHtmxModal(openDialog);
                    }
                }
            });
            
            // Show preview modal using pre-computed data from card
            window.showPreviewModal = function(cardElement) {
                // Extract pre-computed data from card attributes
                const symbol = cardElement.getAttribute('data-symbol');
                const meetsCriteria = cardElement.getAttribute('data-meets-criteria') === 'true';
                const price = cardElement.getAttribute('data-price');
                const rsi = cardElement.getAttribute('data-rsi');
                const trend = cardElement.getAttribute('data-trend');
                const sma200 = cardElement.getAttribute('data-sma-200');
                const atr = cardElement.getAttribute('data-atr');
                const priceVsSmaPct = cardElement.getAttribute('data-price-vs-sma-pct');
                const rejectionReason = cardElement.getAttribute('data-rejection-reason');
                const rsiThreshold = parseInt(cardElement.getAttribute('data-rsi-threshold')) || 35;
                
                // Calculate change percentage (if we have price data)
                let changePct = null;
                // We don't have prev_close in card, so skip for now or fetch it
                
                // Build preview HTML using pre-computed data
                const previewHTML = buildPreviewModalContent({
                    symbol: symbol,
                    price: price ? parseFloat(price) : null,
                    changePct: changePct,
                    rsi: rsi ? parseFloat(rsi) : null,
                    trend: trend || null,
                    sma200: sma200 ? parseFloat(sma200) : null,
                    atr: atr ? parseFloat(atr) : null,
                    meetsCriteria: meetsCriteria,
                    rejectionReason: rejectionReason || null,
                    rsiThreshold: rsiThreshold
                });
                
                // Create modal dialog
                const modalId = `preview-modal-${symbol.toLowerCase()}`;
                const modalHTML = `
                    <dialog id="${modalId}" class="htmx-modal" data-modal-id="${modalId}">
                        <div class="htmx-modal-content" style="max-width: max-w-2xl;">
                            <div class="htmx-modal-header">
                                <h2 class="htmx-modal-title">
                                    <i data-lucide="eye" class="text-yellow-400 w-5 h-5"></i>
                                    <span>${symbol} Analysis Preview</span>
                                </h2>
                                <button class="htmx-modal-close" aria-label="Close modal" type="button">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="htmx-modal-body">
                                ${previewHTML}
                            </div>
                        </div>
                    </dialog>
                `;
                
                // Insert into modal container
                const modalContainer = document.getElementById('modal-container');
                if (modalContainer) {
                    modalContainer.innerHTML = modalHTML;
                    const dialog = modalContainer.querySelector('dialog.htmx-modal');
                    if (dialog) {
                        dialog.showModal();
                        if (document.body) {
                            document.body.style.overflow = 'hidden';
                        }
                        // Initialize Lucide icons and HTMX processing
                        setTimeout(() => {
                            if (typeof lucide !== 'undefined') {
                                lucide.createIcons();
                            }
                            // Process HTMX attributes on dynamically inserted content
                            if (typeof htmx !== 'undefined') {
                                htmx.process(dialog);
                            }
                        }, 50);
                    }
                }
            };
            
            // Build progress indicator HTML
            function buildProgressIndicator(symbol) {
                return `
                    <div class="space-y-4">
                        <div class="glass rounded-lg p-4 border border-purple-500/30 bg-purple-500/10">
                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center">
                                    <i data-lucide="sparkles" class="w-6 h-6 text-purple-400"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white">${symbol} AI Analysis</h3>
                                    <p class="text-sm text-gray-400">Analyzing market data, news, and technical indicators...</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex items-center gap-3 p-3 rounded-lg bg-blue-500/10 border border-blue-500/30">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center">
                                            <i data-lucide="database" class="w-4 h-4 text-blue-400"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-white">Fetching Market Data</div>
                                        <div class="text-xs text-gray-400">Retrieving price history from Alpaca API...</div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i data-lucide="loader-2" class="w-5 h-5 text-blue-400 lucide-spin"></i>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-800/20 border border-gray-700/30 opacity-50">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-gray-700/30 flex items-center justify-center">
                                            <i data-lucide="search" class="w-4 h-4 text-gray-500"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-gray-500">Searching Web & News</div>
                                        <div class="text-xs text-gray-600">Gathering recent headlines via Firecrawl...</div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i data-lucide="circle" class="w-5 h-5 text-gray-600"></i>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-800/20 border border-gray-700/30 opacity-50">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-gray-700/30 flex items-center justify-center">
                                            <i data-lucide="activity" class="w-4 h-4 text-gray-500"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-gray-500">Analyzing Technicals</div>
                                        <div class="text-xs text-gray-600">Calculating RSI, trend, ATR, and SMA...</div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i data-lucide="circle" class="w-5 h-5 text-gray-600"></i>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-800/20 border border-gray-700/30 opacity-50">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-gray-700/30 flex items-center justify-center">
                                            <i data-lucide="brain" class="w-4 h-4 text-gray-500"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-gray-500">AI Processing</div>
                                        <div class="text-xs text-gray-600">Analyzing with GPT-4o using strategy context...</div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i data-lucide="circle" class="w-5 h-5 text-gray-600"></i>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-800/20 border border-gray-700/30 opacity-50">
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 rounded-full bg-gray-700/30 flex items-center justify-center">
                                            <i data-lucide="check-circle" class="w-4 h-4 text-gray-500"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="text-sm font-semibold text-gray-500">Finalizing Results</div>
                                        <div class="text-xs text-gray-600">Preparing analysis and caching...</div>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <i data-lucide="circle" class="w-5 h-5 text-gray-600"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Build preview modal content from pre-computed data
            function buildPreviewModalContent(data) {
                const { symbol, price, changePct, rsi, trend, sma200, atr, meetsCriteria, rejectionReason, rsiThreshold } = data;
                
                const rsiColor = rsi !== null && rsi < rsiThreshold ? 'text-green-400' : (rsi !== null ? 'text-red-400' : 'text-gray-400');
                const rsiBorder = rsi !== null && rsi < rsiThreshold ? 'border-green-500/30' : (rsi !== null ? 'border-red-500/30' : 'border-gray-700/50');
                const trendColor = trend === 'UP' ? 'text-green-400' : (trend === 'DOWN' ? 'text-red-400' : 'text-gray-400');
                const trendBorder = trend === 'UP' ? 'border-green-500/30' : (trend === 'DOWN' ? 'border-red-500/30' : 'border-gray-700/50');
                
                return `
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-12 h-12 rounded-full ${meetsCriteria ? 'bg-green-500/20' : 'bg-yellow-500/20'} flex items-center justify-center">
                                <i data-lucide="${meetsCriteria ? 'check-circle' : 'info'}" class="${meetsCriteria ? 'text-green-400' : 'text-yellow-400'} w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white">${symbol}</h3>
                                <p class="text-sm ${meetsCriteria ? 'text-green-400' : 'text-yellow-400'}">
                                    ${meetsCriteria ? 'âœ“ Candidate - Meets entry criteria' : 'Not a candidate - See details below'}
                                </p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="glass rounded-lg p-4 text-center border ${price ? 'border-blue-500/30' : 'border-gray-700/50'}">
                                <div class="text-xs text-gray-400 mb-1 flex items-center justify-center gap-1">
                                    <i data-lucide="dollar-sign" class="w-3 h-3"></i>
                                    Price
                                </div>
                                <div class="text-xl font-bold text-white">${price ? '$' + parseFloat(price).toFixed(2) : 'N/A'}</div>
                                ${changePct !== null ? `<div class="text-xs mt-1 ${changePct >= 0 ? 'text-green-400' : 'text-red-400'}">${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%</div>` : ''}
                            </div>
                            
                            <div class="glass rounded-lg p-4 text-center border ${rsiBorder}">
                                <div class="text-xs text-gray-400 mb-1 flex items-center justify-center gap-1">
                                    <i data-lucide="activity" class="w-3 h-3"></i>
                                    RSI
                                </div>
                                <div class="text-xl font-bold ${rsiColor}">${rsi !== null ? rsi.toFixed(1) : 'N/A'}</div>
                                <div class="text-xs text-gray-500 mt-1">Need: &lt; ${rsiThreshold}</div>
                            </div>
                            
                            <div class="glass rounded-lg p-4 text-center border ${trendBorder}">
                                <div class="text-xs text-gray-400 mb-1 flex items-center justify-center gap-1">
                                    <i data-lucide="trending-up" class="w-3 h-3"></i>
                                    Trend
                                </div>
                                <div class="text-xl font-bold ${trendColor}">${trend || 'N/A'}</div>
                                <div class="text-xs text-gray-500 mt-1">Need: UP</div>
                            </div>
                            
                            <div class="glass rounded-lg p-4 text-center border border-gray-700/50">
                                <div class="text-xs text-gray-400 mb-1 flex items-center justify-center gap-1">
                                    <i data-lucide="shield" class="w-3 h-3"></i>
                                    ATR
                                </div>
                                <div class="text-xl font-bold text-white">${atr ? '$' + parseFloat(atr).toFixed(2) : 'N/A'}</div>
                                ${atr && price ? `<div class="text-xs text-gray-500 mt-1">${((parseFloat(atr) / parseFloat(price)) * 100).toFixed(1)}% of price</div>` : ''}
                            </div>
                        </div>
                        
                        ${meetsCriteria ? `
                        <div class="glass rounded-lg p-4 bg-green-500/10 border border-green-500/30">
                            <div class="flex items-start gap-2">
                                <i data-lucide="check-circle-2" class="text-green-400 w-5 h-5 mt-0.5 flex-shrink-0"></i>
                                <div>
                                    <h4 class="text-sm font-semibold text-green-400 mb-1">Meets Entry Criteria</h4>
                                    <p class="text-sm text-gray-200">This stock meets our balanced low criteria: RSI &lt; ${rsiThreshold} and uptrend. Ready for AI analysis to get detailed insights.</p>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div class="glass rounded-lg p-4 bg-yellow-500/10 border border-yellow-500/30">
                            <div class="flex items-start gap-2">
                                <i data-lucide="alert-circle" class="text-yellow-400 w-5 h-5 mt-0.5 flex-shrink-0"></i>
                                <div>
                                    <h4 class="text-sm font-semibold text-yellow-400 mb-1">Why Not a Candidate</h4>
                                    <p class="text-sm text-gray-200">${rejectionReason || 'Does not meet entry criteria'}</p>
                                </div>
                            </div>
                        </div>
                        `}
                        
                        ${sma200 && price ? `
                        <div class="glass rounded-lg p-3 border border-gray-700/50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="trending-up" class="text-blue-400 w-4 h-4"></i>
                                    <span class="text-xs text-gray-400">SMA-200</span>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-bold text-white">$${parseFloat(sma200).toFixed(2)}</div>
                                    <div class="text-xs ${parseFloat(price) >= parseFloat(sma200) ? 'text-green-400' : 'text-red-400'}">
                                        Price is ${parseFloat(price) >= parseFloat(sma200) ? ((parseFloat(price) / parseFloat(sma200) - 1) * 100).toFixed(1) + '% above' : ((1 - parseFloat(price) / parseFloat(sma200)) * 100).toFixed(1) + '% below'} SMA-200
                                    </div>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="pt-4 border-t border-gray-700/50">
                            <form hx-post="/api/analyze" 
                                  hx-target="closest .htmx-modal-body" 
                                  hx-swap="innerHTML"
                                  hx-indicator="#ai-analysis-progress-${symbol.toLowerCase()}"
                                  hx-on::before-request="document.getElementById('ai-analysis-progress-${symbol.toLowerCase()}').style.display = 'block';"
                                  class="w-full">
                                <input type="hidden" name="ticker" value="${symbol}">
                                <button type="submit"
                                        class="w-full glass-strong py-3 rounded-lg text-sm font-bold text-white hover:bg-purple-600/30 transition-all bg-purple-500/30 flex items-center justify-center gap-2 border border-purple-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="htmx-indicator">
                                        <i data-lucide="loader-2" class="w-4 h-4 lucide-spin"></i>
                                    </span>
                                    <i data-lucide="sparkles" class="w-4 h-4 htmx-indicator-hidden"></i>
                                    <span class="htmx-indicator-hidden">Analyze with AI</span>
                                    <span class="htmx-indicator">Starting analysis...</span>
                                </button>
                            </form>
                            <div id="ai-analysis-progress-${symbol.toLowerCase()}" class="htmx-indicator mt-4" style="display: none;">
                                ${buildProgressIndicator(symbol)}
                            </div>
                        </div>
                        
                        <div class="glass rounded-lg p-3 bg-purple-500/10 border border-purple-500/30">
                            <div class="text-xs font-semibold text-purple-300 mb-1 flex items-center gap-1">
                                <i data-lucide="info" class="w-3 h-3"></i>
                                About Balanced Low Strategy
                            </div>
                            <p class="text-xs text-gray-300">We look for stocks that are oversold (RSI &lt; ${rsiThreshold}) but still in an uptrend. This creates a "balanced low" buying opportunity with bounce-back potential.</p>
                        </div>
                    </div>
                `;
            }
        }
    </script>
    <!-- Alpine.js App State - MUST be defined BEFORE Alpine.js initializes -->
    <script>
        // Helper function to safely check if Alpine.js is ready
        function isAlpineReady() {
            return typeof Alpine !== 'undefined' && 
                   (typeof Alpine.start === 'function' || typeof Alpine.initTree === 'function');
        }
        
        // Helper function to get Alpine.js app state (defined early for use in other functions)
        function getAlpineState() {
            if (!isAlpineReady()) return null;
            const bodyEl = document.body;
            if (bodyEl?._x_dataStack?.[0]) {
                return bodyEl._x_dataStack[0];
            }
            try {
                if (typeof Alpine.$data === 'function') {
                    return Alpine.$data(bodyEl);
                }
            } catch (e) {
                // Silently fail - Alpine may not be ready
                return null;
            }
            return null;
        }
        
        // Removed analyzeStockFromWatchlist - cards now use pure HTMX attributes
        // Cards have hx-post, hx-trigger, hx-target directly in their HTML
        
        /**
         * Alpine.js App State - Staff Engineer Level Architecture
         * 
         * Centralized reactive state management replacing global variables.
         * All UI state is managed through Alpine.js reactivity.
         * 
         * IMPORTANT: This function MUST be defined before Alpine.js initializes.
         */
        function appState() {
            // Ensure function is always available
            if (typeof window === 'undefined') {
                console.error('appState: window object not available');
                return {};
            }
            
            try {
                return {
                    /**
                     * Modal state management
                     * @type {Object<string, boolean>}
                     */
                    modals: {
                        strategy: false,
                        'strategy-config': false,
                        'strategy-help': false,
                        'ai-score': false,
                        scanner: false,
                        'buy-order': false,
                        explanation: false,
                        'positions-info': false,
                        'risk-levels': false,
                        'scanner-info': false,
                        'symbol-preview': false,
                        'analysis': false
                    },
                    
                    /**
                     * Tab state management
                     * @type {string} activeTab - Currently active tab ID
                     * @type {string[]} tabs - Available tab IDs
                     */
                    activeTab: 'positions',
                    tabs: ['positions', 'strategy'],
                    canAnalyze: true, // Enable analyze button by default
                    
                    mainView: 'watchlist',
                    
                    /**
                     * Stock scanning and display state
                     * @type {Object} stocks - Stock-related state
                     */
                    stocks: {
                        all: [],
                        displayed: [],
                        filtered: [],
                        currentPage: 1,
                        perPage: 12,
                        isLoading: false,
                        isScanning: false,
                        showAllMode: false,
                        filterValue: 'all',
                        sortValue: 'score_desc'
                    },
                    
                    /**
                     * Cache state for stock data
                     * @type {Object} cache - Cache-related state
                     */
                    cache: {
                        stocks: null,
                        timestamp: null,
                        duration: 15 * 60 * 1000
                    },
                    
                    /**
                     * WebSocket connection state
                     * @type {Object} ws - WebSocket-related state
                     */
                    ws: {
                        connection: null,
                        timeout: null,
                        retryCount: 0
                    },
                    
                    /**
                     * UI state for warnings, progress, etc.
                     * @type {Object} ui - UI-related state
                     */
                    ui: {
                        warningBannerVisible: false,
                        warningMessage: '',
                        progressVisible: false,
                        progressPercent: 0,
                        progressMessage: '',
                        scanningMessage: ''
                    },
                    
                    /**
                     * Toast notification state
                     * @type {Array<Object>} toasts - Array of toast objects
                     */
                    toasts: [],
                    
                    /**
                     * Initialize app state
                     * Called on page load via x-init directive
                     * @method init
                     */
                    async init() {
                        // Ensure all modals are closed on init
                        Object.keys(this.modals).forEach(key => {
                            this.modals[key] = false;
                        });
                        
                        // Ensure metric modal is hidden
                        const metricModal = document.getElementById('metric-info-modal');
                        if (metricModal) {
                            metricModal.style.display = 'none';
                        }
                        document.body.style.overflow = '';
                        
                        // Initialize tabs
                        this.switchTab('positions-tab');
                        
                        // Initialize Lucide icons
                        this.refreshLucideIcons();
                    },
                    
                    /**
                     * Open a modal by ID
                     * @method openModal
                     * @param {string} modalId - Modal identifier
                     */
                    openModal(modalId) {
                        try {
                            if (!this.modals || !this.modals.hasOwnProperty(modalId)) {
                                console.warn(`Modal '${modalId}' not found`);
                                if (!this.modals) {
                                    this.modals = {
                                        strategy: false,
                                        'strategy-config': false,
                                        'strategy-help': false,
                                        'ai-score': false,
                                        scanner: false,
                                        'buy-order': false,
                                        explanation: false,
                                        'positions-info': false,
                                        'risk-levels': false,
                                        'scanner-info': false,
                                        'symbol-preview': false,
                                        'analysis': false
                                    };
                                }
                                if (!this.modals.hasOwnProperty(modalId)) {
                                    this.modals[modalId] = false;
                                }
                            }
                            
                            this.modals[modalId] = true;
                            
                            if (modalId === 'strategy-config') {
                                setTimeout(() => {
                                    try {
                                        const strategyContent = document.getElementById('strategy-config-content');
                                        const firecrawlSection = document.getElementById('firecrawl-query-section');
                                        if (strategyContent && typeof htmx !== 'undefined' && strategyContent.offsetParent !== null) {
                                            htmx.trigger(strategyContent, 'load');
                                        }
                                        if (firecrawlSection && typeof htmx !== 'undefined' && firecrawlSection.offsetParent !== null) {
                                            htmx.trigger(firecrawlSection, 'load');
                                        }
                                    } catch (e) {
                                        console.error('Error triggering HTMX load:', e);
                                    }
                                }, 150);
                            }
                            
                            this.$nextTick(() => {
                                try {
                                    this.refreshLucideIcons();
                                    document.body.style.overflow = 'hidden';
                                } catch (e) {
                                    console.error('Error refreshing icons:', e);
                                }
                            });
                        } catch (error) {
                            console.error('Error in openModal:', error);
                        }
                    },
                    
                    /**
                     * Close a modal by ID
                     * @method closeModal
                     * @param {string} modalId - Modal identifier
                     */
                    closeModal(modalId) {
                        if (!this.modals || !this.modals.hasOwnProperty(modalId)) {
                            return;
                        }
                        
                        this.modals[modalId] = false;
                        
                        const anyModalOpen = Object.values(this.modals).some(open => open === true);
                        if (!anyModalOpen) {
                            document.body.style.overflow = '';
                        }
                        
                        this.$nextTick(() => this.refreshLucideIcons());
                    },
                    
                    /**
                     * Switch between tabs
                     * @method switchTab
                     * @param {string} tabId - Tab identifier
                     */
                    switchTab(tabId) {
                        const tabMap = {
                            'positions-tab': 'positions',
                            'strategy-tab': 'strategy'
                        };
                        this.activeTab = tabMap[tabId] || tabId;
                        
                        const buttons = document.querySelectorAll('.tab-btn');
                        buttons.forEach(btn => {
                            btn.classList.remove('text-white', 'bg-purple-500/20', 'border-b-2', 'border-purple-500');
                            btn.classList.add('text-gray-200');
                        });
                        
                        const activeBtn = document.getElementById(`tab-${tabId.replace('-tab', '')}-btn`);
                        if (activeBtn) {
                            activeBtn.classList.remove('text-gray-200');
                            activeBtn.classList.add('text-white', 'bg-purple-500/20', 'border-b-2', 'border-purple-500');
                        }
                    },
                    
                    /**
                     * Switch main view (watchlist vs analysis)
                     * @method switchMainView
                     * @param {string} view - View name ('watchlist' or 'analysis')
                     */
                    switchMainView(view) {
                        this.mainView = view;
                        this.$nextTick(() => this.refreshLucideIcons());
                    },
                    
                    /**
                     * Refresh Lucide icons
                     * @method refreshLucideIcons
                     */
                    refreshLucideIcons() {
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    },
                    
                    
                    /**
                     * Show stocks
                     * @method showStocks
                     */
                    showStocks(stocks, options = {}) {
                        this.stocks.all = stocks || [];
                        this.applyFilterAndSort();
                    },
                    
                    /**
                     * Apply filter and sort
                     * @method applyFilterAndSort
                     */
                    applyFilterAndSort() {
                        this.stocks.currentPage = 1;
                    },
                    
                    /**
                     * Add toast notification
                     * @method addToast
                     */
                    addToast(message, type = 'info', duration = 3000) {
                        const toast = {
                            id: Date.now() + Math.random(),
                            message,
                            type,
                            duration,
                            visible: true
                        };
                        this.toasts.push(toast);
                        
                        setTimeout(() => {
                            toast.visible = false;
                            setTimeout(() => {
                                const index = this.toasts.indexOf(toast);
                                if (index > -1) {
                                    this.toasts.splice(index, 1);
                                }
                            }, 300);
                        }, duration);
                    },
                    
                    /**
                     * Show toast (alias for addToast)
                     * @method showToast
                     */
                    showToast(message, type, duration) {
                        this.addToast(message, type, duration);
                    },
                    
                    // refreshStocks and analyzeSingleStock removed - now handled by HTMX
                };
            } catch (error) {
                console.error('Error creating appState:', error);
                return {
                    modals: {},
                    activeTab: 'positions',
                    mainView: 'watchlist',
                    stocks: { all: [], isScanning: false, filterValue: 'all', sortValue: 'score_desc' },
                    toasts: [],
                    canAnalyze: false,
                    init: function() {},
                    openModal: function() {},
                    closeModal: function() {},
                    switchTab: function() {},
                    switchMainView: function() {},
                    refreshLucideIcons: function() {},
                    loadAnalysisPreview: function() {},
                    showStocks: function() {},
                    applyFilterAndSort: function() {},
                    addToast: function() {},
                    showToast: function() {}
                };
            }
        }
        
        // Make appState globally available immediately
        window.appState = appState;
        
        // Expose helper functions globally for use in inline handlers
        window.closeModal = function(modalId) {
            const app = appState();
            if (app && typeof app.closeModal === 'function') {
                app.closeModal(modalId);
            }
        };
        
        window.showToast = function(message, type, duration) {
            const app = appState();
            if (app && typeof app.showToast === 'function') {
                app.showToast(message, type, duration);
            }
        };
    </script>
    <!-- Alpine.js - Reactive state management (MIT License) -->
    <!-- Load Alpine.js without defer to ensure it initializes before DOMContentLoaded -->
    <script>
        // Global error handler for Alpine.js to prevent uncaught promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            // Check if error is from Alpine.js transitions
            const errorSource = event.reason?.stack || event.reason?.toString() || '';
            const errorMessage = event.reason?.message || '';
            
            if (errorSource.includes('cdn.min.js') || 
                errorSource.includes('Alpine') || 
                errorMessage.includes('is not a function') ||
                errorMessage.includes('_x_toggleAndCascadeWithTransitions')) {
                // Suppress Alpine.js transition errors - they're non-critical
                // These happen when transitions are interrupted or elements are removed
                console.debug('Alpine.js transition error suppressed:', event.reason);
                event.preventDefault();
                return false;
            }
        });
        
        // Catch synchronous errors from Alpine.js
        window.addEventListener('error', function(event) {
            if (event.filename && event.filename.includes('cdn.min.js')) {
                // Only suppress transition-related errors
                if (event.message && (
                    event.message.includes('is not a function') || 
                    event.message.includes('transition') || 
                    event.message.includes('_x_toggleAndCascadeWithTransitions'))) {
                    console.debug('Alpine.js transition error suppressed:', event.message);
                    event.preventDefault();
                    return false;
                }
            }
        }, true);
        
        /**
         * Alpine.js Cleanup Utility
         * Safely destroys Alpine.js components before DOM removal to prevent transition errors
         */
        window.cleanupAlpineElement = function(element) {
            if (typeof Alpine === 'undefined' || !element) return;
            
            try {
                // Check if element has Alpine.js instance
                if (element.__x && typeof Alpine.destroyTree === 'function') {
                    Alpine.destroyTree(element);
                }
                // Also check child elements with Alpine.js instances
                const alpineElements = element.querySelectorAll('[x-data]');
                alpineElements.forEach(el => {
                    if (el.__x && typeof Alpine.destroyTree === 'function') {
                        try {
                            Alpine.destroyTree(el);
                        } catch (e) {
                            console.debug('Alpine.js cleanup error on child element (non-critical):', e);
                        }
                    }
                });
            } catch (e) {
                console.debug('Alpine.js cleanup error (non-critical):', e);
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
    <!-- Lucide Icons - Modern, beautiful icons perfect for dark mode (MIT License) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Typography now handled by design system CSS */
        /* Fonts loaded via link tags in head */
        
        /* Enhanced Readability - Higher Contrast for Dark Mode */
        /* Make all gray text MUCH more readable for older eyes */
        .text-gray-500 {
            color: #d1d5db !important; /* gray-300 - much lighter */
            font-weight: 500;
        }
        
        .text-gray-400 {
            color: #e5e7eb !important; /* gray-200 - very light */
            font-weight: 500;
        }
        
        .text-gray-300 {
            color: #f3f4f6 !important; /* gray-100 - almost white */
            font-weight: 500;
        }
        
        /* Ensure body text is bright white */
        body {
            color: #ffffff !important;
        }
        
        /* Make sure all paragraphs and text elements are readable */
        p, span, div, label, li, td, th {
            color: inherit;
        }
        
        /* Increase font weight for better readability */
        .text-xs {
            font-weight: 500;
        }
        
        .text-sm {
            font-weight: 500;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(239, 68, 68, 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(239, 68, 68, 0.7); }
        
        .htmx-indicator{display:none} 
        .htmx-request .htmx-indicator{display:block} 
        .htmx-request.htmx-indicator{display:block}
        
        /* Alpine.js x-cloak - hide elements until Alpine is initialized */
        [x-cloak] { display: none !important; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .glass-strong {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(239, 68, 68, 0.2);
            box-shadow: 0 8px 32px 0 rgba(239, 68, 68, 0.1);
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 50%, #eab308 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Glow effects */
        .glow-red {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
        
        .glow-green {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }
        
        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.8); }
        }
        
        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        /* Transaction highlight animation */
        @keyframes highlight-transaction {
            0% { 
                background-color: rgba(34, 197, 94, 0.3);
                border-color: rgba(34, 197, 94, 0.6);
                box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
                transform: scale(1.02);
            }
            50% { 
                background-color: rgba(34, 197, 94, 0.5);
                border-color: rgba(34, 197, 94, 0.8);
                box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
                transform: scale(1.03);
            }
            100% { 
                background-color: transparent;
                border-color: rgba(34, 197, 94, 0.3);
                box-shadow: none;
                transform: scale(1);
            }
        }
        
        .highlight-transaction {
            animation: highlight-transaction 2s ease-out forwards;
        }
        
        /* Cancel fade-out animation - fast and smooth */
        @keyframes fade-out-cancel {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1);
                max-height: 200px;
                margin-bottom: 0.5rem;
            }
            100% {
                opacity: 0;
                transform: translateX(-30px) scale(0.95);
                max-height: 0;
                margin-bottom: 0;
                padding-top: 0;
                padding-bottom: 0;
                overflow: hidden;
            }
        }
        
        .fade-out-cancel {
            animation: fade-out-cancel 0.25s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .animate-shimmer {
            animation: shimmer 2s infinite;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .slide-in-right {
            animation: slideInRight 0.4s ease-out;
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .scale-in {
            animation: scaleIn 0.3s ease-out;
        }
        
        /* 3D Modal Animations */
        @keyframes slideIn3D {
            from { 
                opacity: 0; 
                transform: perspective(1000px) rotateX(-10deg) translateY(50px) scale(0.9);
            }
            to { 
                opacity: 1; 
                transform: perspective(1000px) rotateX(0deg) translateY(0) scale(1);
            }
        }
        
        @keyframes slideOut3D {
            from { 
                opacity: 1; 
                transform: perspective(1000px) rotateX(0deg) translateY(0) scale(1);
            }
            to { 
                opacity: 0; 
                transform: perspective(1000px) rotateX(10deg) translateY(-50px) scale(0.9);
            }
        }
        
        @keyframes slideInFromRight {
            from { 
                opacity: 0; 
                transform: perspective(1000px) rotateY(-15deg) translateX(100%);
            }
            to { 
                opacity: 1; 
                transform: perspective(1000px) rotateY(0deg) translateX(0);
            }
        }
        
        @keyframes slideOutToRight {
            from { 
                opacity: 1; 
                transform: perspective(1000px) rotateY(0deg) translateX(0);
            }
            to { 
                opacity: 0; 
                transform: perspective(1000px) rotateY(15deg) translateX(100%);
            }
        }
        
        .modal-content.slide-in-3d {
            animation: slideIn3D 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .modal-content.slide-out-3d {
            animation: slideOut3D 0.3s cubic-bezier(0.55, 0.055, 0.675, 0.19);
        }
        
        .info-icon {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .info-icon:hover {
            transform: scale(1.1) rotate(5deg);
            color: #3b82f6;
        }
        
        .info-icon:active {
            transform: scale(0.95);
        }
        
        /* FLUX Animated Background Effects - Subtle & Interactive */
        @keyframes flux-gradient-shift {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }
        @keyframes flux-orb-float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.2;
            }
            25% {
                transform: translate(30px, -25px) scale(1.15);
                opacity: 0.3;
            }
            50% {
                transform: translate(-20px, -40px) scale(0.95);
                opacity: 0.25;
            }
            75% {
                transform: translate(15px, -15px) scale(1.05);
                opacity: 0.28;
            }
        }
        @keyframes flux-orb-float-alt {
            0%, 100% {
                transform: translate(0, 0) scale(1);
                opacity: 0.15;
            }
            25% {
                transform: translate(-35px, 20px) scale(0.9);
                opacity: 0.2;
            }
            50% {
                transform: translate(25px, 35px) scale(1.1);
                opacity: 0.18;
            }
            75% {
                transform: translate(-10px, 10px) scale(1.0);
                opacity: 0.17;
            }
        }
        @keyframes flux-wave {
            0%, 100% {
                transform: translateX(-50%) translateY(0) scaleY(1);
                opacity: 0.1;
            }
            50% {
                transform: translateX(-50%) translateY(-10px) scaleY(1.2);
                opacity: 0.15;
            }
        }
        .flux-header-bg {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Base gradient layer - slow drift */
        .flux-header-bg::before {
            content: '';
            position: absolute;
            inset: -50%;
            background: 
                radial-gradient(circle at 15% 25%, rgba(59, 130, 246, 0.12) 0%, transparent 45%),
                radial-gradient(circle at 85% 75%, rgba(34, 197, 94, 0.1) 0%, transparent 45%),
                radial-gradient(circle at 50% 50%, rgba(99, 102, 241, 0.06) 0%, transparent 55%);
            background-size: 300% 300%;
            animation: flux-gradient-shift 18s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        /* Floating orb layer - medium speed */
        .flux-header-bg::after {
            content: '';
            position: absolute;
            inset: -30%;
            background: 
                radial-gradient(ellipse at 25% 35%, rgba(59, 130, 246, 0.18) 0%, transparent 35%),
                radial-gradient(ellipse at 75% 65%, rgba(34, 197, 94, 0.15) 0%, transparent 35%);
            animation: flux-orb-float 22s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
            mix-blend-mode: screen;
        }
        /* Interactive hover effects */
        .flux-header-bg:hover {
            border-color: rgba(34, 197, 94, 0.3);
        }
        .flux-header-bg:hover::before {
            animation-duration: 10s;
            opacity: 1.2;
        }
        .flux-header-bg:hover::after {
            animation-duration: 14s;
            opacity: 1.3;
        }
        /* Mouse tracking effect layer */
        .flux-header-bg .flux-mouse-track {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(34, 197, 94, 0.1) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
            transform: translate(-50%, -50%);
        }
        .flux-header-bg:hover .flux-mouse-track {
            opacity: 1;
        }
        .flux-header-content {
            position: relative;
            z-index: 1;
        }
        /* Enhanced FLUX text with gradient animation and smooth bounce */
        @keyframes flux-text-bounce {
            0%, 100% {
                transform: translateX(0) scale(1);
            }
            25% {
                transform: translateX(-2px) scale(1.01);
            }
            50% {
                transform: translateX(0) scale(1);
            }
            75% {
                transform: translateX(2px) scale(1.01);
            }
        }
        @keyframes flux-text-glow {
            0%, 100% {
                filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.4));
            }
            50% {
                filter: drop-shadow(0 0 16px rgba(34, 197, 94, 0.6));
            }
        }
        @keyframes flux-gradient-fluctuate {
            0% {
                background-position: 0% 50%;
            }
            16.66% {
                background-position: 25% 75%;
            }
            33.33% {
                background-position: 50% 100%;
            }
            50% {
                background-position: 75% 50%;
            }
            66.66% {
                background-position: 100% 25%;
            }
            83.33% {
                background-position: 75% 0%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        @keyframes flux-gradient-hue {
            0% {
                filter: hue-rotate(0deg);
            }
            50% {
                filter: hue-rotate(180deg);
            }
            100% {
                filter: hue-rotate(360deg);
            }
        }
        .flux-text {
            background: linear-gradient(
                135deg,
                #60a5fa 0%,
                #a855f7 20%,
                #ec4899 40%,
                #f43f5e 60%,
                #f59e0b 80%,
                #22c55e 100%
            );
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: 
                flux-gradient-fluctuate 8s ease-in-out infinite,
                flux-gradient-shift 6s ease-in-out infinite,
                flux-text-bounce 3s ease-in-out infinite,
                flux-text-glow 2s ease-in-out infinite;
            font-weight: 800;
            letter-spacing: 0.05em;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: inline-block;
        }
        .flux-text::after {
            content: 'FLUX';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                135deg,
                #60a5fa 0%,
                #a855f7 20%,
                #ec4899 40%,
                #f43f5e 60%,
                #f59e0b 80%,
                #22c55e 100%
            );
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: blur(8px);
            opacity: 0.4;
            z-index: -1;
            animation: flux-gradient-fluctuate 8s ease-in-out infinite, flux-gradient-shift 6s ease-in-out infinite;
        }
        .flux-text:hover {
            filter: drop-shadow(0 0 25px rgba(34, 197, 94, 0.8));
            transform: scale(1.05);
            animation-duration: 1.5s, 1.5s, 1s;
        }
        /* Logo SVG animations */
        @keyframes logo-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes logo-pulse {
            0%, 100% { 
                opacity: 0.5;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.1);
            }
        }
        @keyframes logo-float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-3px) rotate(180deg);
            }
        }
        .logo-svg {
            animation: logo-float 4s ease-in-out infinite;
            filter: drop-shadow(0 0 8px rgba(0, 240, 255, 0.4));
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .logo-svg:hover {
            filter: drop-shadow(0 0 16px rgba(0, 240, 255, 0.8));
            transform: scale(1.1);
        }
        .logo-outer-ring {
            animation: logo-spin 20s linear infinite;
            transform-origin: 25px 25px;
        }
        .logo-inner-ring {
            animation: logo-pulse 2s ease-in-out infinite;
            transform-origin: 25px 25px;
        }
        /* Subtle background animation for main content area */
        @keyframes flux-content-shimmer {
            0%, 100% {
                background-position: -200% 0;
            }
            50% {
                background-position: 200% 0;
            }
        }
        body {
            background: 
                linear-gradient(135deg, rgba(15, 23, 42, 1) 0%, rgba(30, 41, 59, 1) 100%),
                radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(34, 197, 94, 0.05) 0%, transparent 50%);
            background-size: 100% 100%, 200% 200%, 200% 200%;
            background-attachment: fixed;
        }
        
        /* Toast animations */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        .toast {
            animation: slideInRight 0.3s ease-out;
        }
        
        .toast.fade-out {
            animation: fadeOut 0.3s ease-out;
        }
        
        /* Fix hover/scroll issues */
        .ticker-card {
            position: relative;
            will-change: transform;
            backface-visibility: hidden;
            cursor: pointer;
        }
        
        .ticker-card:hover {
            transform: translateY(-1px);
            z-index: 10;
        }
        
        /* Enhanced styling for candidate cards */
        .ticker-card[data-meets-criteria="true"] {
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
            animation: candidate-pulse 2s ease-in-out infinite;
        }
        
        @keyframes candidate-pulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
            }
            50% {
                box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
            }
        }
        
        /* Prevent scroll issues with overflow containers */
        #watchlist-section,
        #watchlist-content,
        #ticker-cards-container {
            contain: layout style paint;
        }
        
        /* Tooltip - Using fixed positioning to escape parent overflow */
        /* Classic CSS Tooltips - Simple hover, no JS */
        .tooltip {
            position: relative;
            cursor: help;
            display: inline-block;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 12px;
            line-height: 1.6;
            white-space: normal;
            max-width: 300px;
            min-width: 200px;
            z-index: 10000;
            border: 1px solid rgba(59, 130, 246, 0.4);
            transition: opacity 0.2s ease, visibility 0.2s ease;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.7);
            font-weight: 400;
            pointer-events: none;
            margin-bottom: 8px;
        }
        
        /* Inside modals, tooltips need fixed positioning and higher z-index */
        .htmx-modal .tooltip .tooltip-text {
            position: fixed !important;
            z-index: 99999 !important;
        }
        
        .tooltip .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(15, 23, 42, 0.98);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Tooltip positioning variants */
        .tooltip.tooltip-bottom .tooltip-text {
            bottom: auto;
            top: 125%;
            margin-bottom: 0;
            margin-top: 8px;
        }
        
        .tooltip.tooltip-bottom .tooltip-text::after {
            top: auto;
            bottom: 100%;
            border-top-color: transparent;
            border-bottom-color: rgba(15, 23, 42, 0.98);
        }
        
        .tooltip.tooltip-left .tooltip-text {
            left: auto;
            right: 125%;
            top: 50%;
            transform: translateY(-50%);
            margin-bottom: 0;
            margin-right: 8px;
        }
        
        .tooltip.tooltip-left .tooltip-text::after {
            left: auto;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            border-top-color: transparent;
            border-left-color: rgba(15, 23, 42, 0.98);
        }
        
        .tooltip.tooltip-right .tooltip-text {
            left: 125%;
            top: 50%;
            transform: translateY(-50%);
            margin-bottom: 0;
            margin-left: 8px;
        }
        
        .tooltip.tooltip-right .tooltip-text::after {
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            border-top-color: transparent;
            border-right-color: rgba(15, 23, 42, 0.98);
        }
        
        /* Card hover effects */
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.5);
        }
        
        /* Tab styles */
        .tab-btn {
            position: relative;
        }
        
        .tab-btn.active {
            color: white;
            background: rgba(139, 92, 246, 0.1);
            border-bottom-color: rgba(139, 92, 246, 0.5);
        }
        
        .tab-content {
            min-height: 200px;
        }
        
        /* Single row layout */
        @media (min-width: 1024px) {
            .flex-row > div {
                min-height: 600px;
                max-height: calc(100vh - 200px);
            }
        }
        
        input[type="checkbox"] {
            accent-color: #3b82f6;
        }
        
        /* Badge styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .badge-warning {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
            border: 1px solid rgba(234, 179, 8, 0.3);
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        /* Rejection modal CSS removed - now using HTMX modal system */
        
        /* Modal - Hidden by default, Alpine.js x-show adds inline style to show */
        /* ============================================
           CLEAN HTMX MODAL SYSTEM - CSS3 + Native Dialog
           ============================================ */
        
        /* Native dialog element - uses ::backdrop pseudo-element */
        .htmx-modal {
            margin: auto;
            padding: 0;
            border: none;
            border-radius: 0;
            background: transparent;
            max-width: 95vw;
            width: 1200px;
            max-height: 95vh;
            z-index: 1000;
            will-change: transform, opacity;
        }
        
        /* Native backdrop - automatically handled by browser */
        .htmx-modal::backdrop {
            background: rgba(5, 5, 7, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            animation: modalBackdropFadeIn 0.2s ease-out;
        }
        
        /* Modal content container */
        .htmx-modal-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.75), 0 0 40px rgba(112, 0, 255, 0.1);
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: modalContentEnter 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-family: var(--font-body);
            will-change: transform, opacity, filter;
            transform-style: preserve-3d;
        }
        
        /* Modal loading state */
        .htmx-modal-loading {
            position: relative;
        }
        
        /* Modal header */
        .htmx-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        
        .htmx-modal-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            font-family: var(--font-heading);
            color: white;
            margin: 0;
        }
        
        /* Close button */
        .htmx-modal-close {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        .htmx-modal-close:hover {
            background: rgba(255, 0, 85, 0.2);
            border-color: rgba(255, 0, 85, 0.4);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 0, 85, 0.3);
        }
        
        .htmx-modal-close:active {
            transform: scale(0.95);
        }
        
        /* Modal body - scrollable content */
        .htmx-modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        
        /* CSS3 Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Modal backdrop animations */
        @keyframes modalBackdropFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
                -webkit-backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
            }
        }
        
        @keyframes modalBackdropFadeOut {
            from {
                opacity: 1;
                backdrop-filter: blur(16px);
                -webkit-backdrop-filter: blur(16px);
            }
            to {
                opacity: 0;
                backdrop-filter: blur(0px);
                -webkit-backdrop-filter: blur(0px);
            }
        }
        
        /* Modal content animations */
        @keyframes modalContentEnter {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(-20px) rotateX(5deg);
                filter: blur(4px);
            }
            50% {
                opacity: 0.8;
                transform: scale(0.98) translateY(-5px) rotateX(2deg);
                filter: blur(1px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0) rotateX(0deg);
                filter: blur(0px);
            }
        }
        
        @keyframes modalContentExit {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0) rotateX(0deg);
                filter: blur(0px);
            }
            100% {
                opacity: 0;
                transform: scale(0.95) translateY(10px) rotateX(-3deg);
                filter: blur(2px);
            }
        }
        
        /* Dialog open state - content animation handled by .htmx-modal-content */
        .htmx-modal[open] {
            animation: none; /* Content handles its own animation */
        }
        
        /* Modal exit animation */
        .htmx-modal.closing .htmx-modal-content {
            animation: modalContentExit 0.25s ease-in forwards;
        }
        
        .htmx-modal.closing::backdrop {
            animation: modalBackdropFadeOut 0.25s ease-in forwards;
        }
        
        /* Ensure tooltips appear above modals - use fixed positioning to escape stacking contexts */
        .htmx-modal .tooltip .tooltip-text {
            position: fixed !important;
            z-index: 99999 !important;
        }
        
        /* Ensure tooltip buttons are clickable */
        .htmx-modal .tooltip button {
            position: relative;
            z-index: 1;
        }
        
        /* Modal styles for info modals */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }
        
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: #fff;
        }
        
        /* Progress bar animation */
        @keyframes progress-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        #progress-bar {
            transition: width 0.3s ease-out;
            animation: progress-pulse 2s ease-in-out infinite;
        }
        
        /* Stock card fade-in */
        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .stock-card-new {
            animation: cardFadeIn 0.4s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.2s ease-out;
        }
        
        /* Smooth transitions for HTMX swaps */
        .htmx-swapping {
            opacity: 0;
            transition: opacity 0.15s ease-out;
        }
        
        .htmx-swapping.htmx-swapping {
            opacity: 1;
            transition: opacity 0.2s ease-in;
        }
        
        /* AI Score Badge Enhancements */
        .badge-success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.15));
            border-color: rgba(34, 197, 94, 0.4);
        }
        
        .badge-info {
            background: linear-gradient(135deg, rgba(132, 204, 22, 0.2), rgba(101, 163, 13, 0.15));
            border-color: rgba(132, 204, 22, 0.3);
        }
        
        .badge-warning {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.15));
            border-color: rgba(251, 191, 36, 0.3);
        }
        
        .badge-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.15));
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        /* Score glow animation for high scores */
        @keyframes scoreGlow {
            0%, 100% { box-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }
            50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.5); }
        }
        
        .score-glow-animate {
            animation: scoreGlow 2s ease-in-out infinite;
        }
        
        /* Line clamp utility */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Hide scrollbar but keep functionality */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* Custom scrollbar for headlines section */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(34, 197, 94, 0.3) rgba(34, 197, 94, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(34, 197, 94, 0.1);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(34, 197, 94, 0.3);
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(34, 197, 94, 0.5);
        }
        
        /* Gray scrollbar for non-candidate cards */
        .watchlist-card-non-candidate .custom-scrollbar {
            scrollbar-color: rgba(156, 163, 175, 0.3) rgba(156, 163, 175, 0.1);
        }
        .watchlist-card-non-candidate .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(156, 163, 175, 0.1);
        }
        .watchlist-card-non-candidate .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(156, 163, 175, 0.3);
        }
        .watchlist-card-non-candidate .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(156, 163, 175, 0.5);
        }
        
        /* Smooth scrolling */
        .smooth-scroll {
            scroll-behavior: smooth;
        }
        
        /* Lucide Icons Styling - Modern, beautiful icons for dark mode */
        [data-lucide] {
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Spinner animation for Lucide loader icons */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .lucide-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Stock card responsive sizing for horizontal slider */
        .stock-card-slider {
            min-width: 320px;
            max-width: 380px;
            width: 100%;
            height: auto;
            min-height: 220px;
            flex-shrink: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stock-card-slider:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(239, 68, 68, 0.15);
        }
        
        /* Slider track animation */
        #slider-track {
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Slider navigation buttons */
        #slider-prev, #slider-next {
            transition: opacity 0.3s ease, transform 0.2s ease;
        }
        
        #slider-prev:hover, #slider-next:hover {
            transform: translateY(-50%) scale(1.1);
        }
        
        /* Smooth card slide-in animation */
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .card-slide-in {
            animation: slideInFromRight 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        /* Smooth card entrance animation */
        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        /* Pulse animation for profit potential */
        @keyframes profitPulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.9;
                transform: scale(1.02);
            }
        }
        
        .profit-highlight {
            animation: profitPulse 2s ease-in-out infinite;
        }
        
        /* Smooth filter transition */
        #trending-stocks-slider {
            transition: opacity 0.3s ease;
        }
        
        #trending-stocks-slider.filtering {
            opacity: 0.5;
        }
        
        /* Select dropdown styling */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        
        /* Smooth transitions for interactive elements */
        select:hover {
            border-color: rgba(234, 179, 8, 0.7);
            background-color: rgba(55, 65, 81, 0.7);
        }
        
        select:focus {
            border-color: rgba(234, 179, 8, 0.9);
            box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1);
        }
        
        /* Card hover effects */
        .card-hover {
            position: relative;
            overflow: hidden;
        }
        
        .card-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            transition: left 0.5s ease;
        }
        
        .card-hover:hover::before {
            left: 100%;
        }
        
        /* Profit potential glow effect */
        .profit-highlight {
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        
        /* Smooth number transitions */
        .number-transition {
            transition: all 0.3s ease;
        }
        
        /* Responsive transitions */
        #trending-stocks-slider {
            transition: opacity 0.3s ease;
        }
        
        /* Button responsiveness */
        button {
            transition: all 0.2s ease;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        /* Range slider styling */
        .slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            outline: none;
        }
        
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.4);
            transition: all 0.2s ease;
        }
        
        .slider-thumb::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.6);
        }
        
        .slider-thumb::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 6px rgba(34, 197, 94, 0.4);
            transition: all 0.2s ease;
        }
        
        .slider-thumb::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.6);
        }
        
        .slider-thumb::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.6));
            border-radius: 4px;
        }
        
        .slider-thumb::-moz-range-track {
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.6));
            border-radius: 4px;
        }
        
        /* Slider container hover effect */
        #trending-stocks-slider:hover ~ #slider-prev,
        #trending-stocks-slider:hover ~ #slider-next,
        #trending-stocks-slider:hover + #slider-prev,
        #trending-stocks-slider:hover + #slider-next {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* HTMX Loading Indicators */
        .htmx-indicator {
            opacity: 0;
            transition: opacity 200ms ease-in;
            pointer-events: none;
        }
        .htmx-request .htmx-indicator {
            opacity: 1;
        }
        .htmx-request.htmx-indicator {
            opacity: 1;
        }
        
        .htmx-indicator-hidden {
            display: inline-block;
        }
        
        .htmx-request .htmx-indicator-hidden {
            display: none;
        }
        
        /* Strategy preset button loading states */
        .preset-loading-indicator {
            display: none;
        }
        .htmx-request .preset-loading-indicator {
            display: inline-block;
        }
        .htmx-request .preset-loading-indicator-hidden {
            display: none;
        }
        
        /* Smooth highlight animation for strategy updates */
        @keyframes strategy-highlight {
            0% {
                background-color: rgba(139, 92, 246, 0.2);
            }
            100% {
                background-color: transparent;
            }
        }
        #strategy-display.animate-pulse {
            animation: strategy-highlight 1s ease-out;
        }
        
        /* Real-time Strategy Display Loading States */
        #strategy-display-content {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #strategy-display-content.htmx-request {
            pointer-events: none;
        }
        
        /* Skeleton Loading Animation */
        @keyframes skeleton-shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }
        
        .skeleton-loading {
            position: absolute;
            inset: 0;
            z-index: 5;
            pointer-events: none;
        }
        
        .skeleton-loading > div > div {
            background: linear-gradient(
                90deg,
                rgba(55, 65, 81, 0.3) 0%,
                rgba(75, 85, 99, 0.5) 50%,
                rgba(55, 65, 81, 0.3) 100%
            );
            background-size: 2000px 100%;
            animation: skeleton-shimmer 2s infinite;
        }
        
        /* Smooth value transitions */
        [x-text] {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Real-time update pulse effect */
        @keyframes value-update-pulse {
            0%, 100% {
                transform: scale(1);
                color: inherit;
            }
            50% {
                transform: scale(1.05);
                color: rgb(196, 181, 253);
            }
        }
        
        .value-updating {
            animation: value-update-pulse 0.6s ease-in-out;
        }
        
        /* Loading overlay backdrop blur */
        #strategy-display-content .absolute.inset-0 {
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        /* Show arrows when hovering over slider container */
        .relative:hover #slider-prev,
        .relative:hover #slider-next {
            opacity: 1 !important;
            pointer-events: auto !important;
        }
        
        /* Logo Animation */
        .logo-svg {
            animation: spin 10s linear infinite;
        }
        
        /* Navigation z-index fix - sticky header */
        nav {
            z-index: 100;
            position: sticky;
            top: 0;
        }
        
        /* Main content spacing */
        .main-content {
            padding-top: 120px;
        }
    </style>
</head>
<body class="text-white min-h-screen p-6" 
      x-data="appState()" 
      x-init="init(); if (typeof checkFirstLoad === 'function') { checkFirstLoad(); }"
      @htmx:after-swap.window="if (typeof window.refreshLucideIcons === 'function') window.refreshLucideIcons(); else if (typeof lucide !== 'undefined') lucide.createIcons()">
    <!-- Ambient Background - Animated Orbs -->
    <div class="ambient-wrapper">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    
    <!-- Toast Container - Alpine.js Component -->
    <div class="fixed top-4 right-4 space-y-2 pointer-events-none" style="z-index: 150;">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.visible"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-x-full"
                 x-transition:enter-end="opacity-100 translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-x-0"
                 x-transition:leave-end="opacity-0 translate-x-full"
                 class="pointer-events-auto">
                <div :class="{
                    'border-green-500/30 bg-green-500/10': toast.type === 'success',
                    'border-blue-500/30 bg-blue-500/10': toast.type === 'info',
                    'border-yellow-500/30 bg-yellow-500/10': toast.type === 'warning',
                    'border-red-500/30 bg-red-500/10': toast.type === 'error'
                }"
                class="toast glass rounded-lg p-4 border shadow-lg min-w-[300px] max-w-[400px] animate-fade-in">
                    <div class="flex items-start gap-3">
                        <i :data-lucide="toast.type === 'success' ? 'check-circle-2' : toast.type === 'warning' ? 'alert-triangle' : toast.type === 'error' ? 'x-circle' : 'info'"
                           :class="{
                               'text-green-400': toast.type === 'success',
                               'text-blue-400': toast.type === 'info',
                               'text-yellow-400': toast.type === 'warning',
                               'text-red-400': toast.type === 'error'
                           }"
                           class="text-lg mt-0.5 flex-shrink-0 w-5 h-5"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-white break-words" x-text="toast.message"></p>
                        </div>
                        <button @click="removeToast(toast.id)" 
                                class="text-gray-400 hover:text-white transition flex-shrink-0">
                            <i data-lucide="x" class="text-xs w-3 h-3"></i>
                        </button>
                    </div>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Toast Container (for HTMX hx-swap-oob compatibility) -->
    <div id="toast-container" class="fixed top-4 right-4 space-y-2 pointer-events-none" style="z-index: 150;"></div>
    
    <!-- Navigation Bar -->
    <nav class="sticky top-0 z-[100]">
        <div class="glass-panel nav-glass-morph">
            <a href="#" class="flex items-center gap-3 font-heading font-bold text-xl tracking-tight text-white no-underline">
                <!-- Logo SVG -->
                <svg class="logo-svg" width="32" height="32" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="25" cy="25" r="20" stroke="url(#paint0_linear)" stroke-width="4" stroke-dasharray="80 20" class="logo-outer-ring"/>
                    <circle cx="25" cy="25" r="10" stroke="white" stroke-width="4" stroke-opacity="0.5" class="logo-inner-ring"/>
                    <defs>
                        <linearGradient id="paint0_linear" x1="5" y1="5" x2="45" y2="45" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#00F0FF"/>
                            <stop offset="1" stop-color="#7000FF"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span class="flux-text">FLUX</span>
            </a>
            <!-- Top Right Corner: Minimal Modern Design -->
            <div class="flex items-center gap-2" 
                 x-data="{ userMenuOpen: false }"
                 @keydown.escape.window="userMenuOpen = false">
                
                <!-- Strategy Selector - Minimal Icon Button -->
                <div id="strategy-selector-container"
                     hx-get="/api/strategy-selector"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <div class="p-2 rounded-lg">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-white/50"></i>
                    </div>
                </div>
                
                <!-- Minimal Account Balance - Inline -->
                <div id="account-info" 
                     hx-get="/api/balance-compact" 
                     hx-trigger="load, every 10s[document.visibilityState === 'visible']" 
                     hx-swap="innerHTML" 
                     hx-indicator="#account-info"
                     hx-on::htmx:response-error="console.error('Balance fetch error:', event.detail)"
                     class="hidden md:flex items-center">
                    <div class="flex items-center justify-center py-1">
                        <i data-lucide="loader-2" class="w-3 h-3 animate-spin text-primary"></i>
                    </div>
                </div>
                
                <!-- User Menu Button - Minimal -->
                <button 
                    @click="userMenuOpen = !userMenuOpen"
                    class="p-2 rounded-lg hover:bg-white/5 transition-colors text-white/70 hover:text-white relative"
                    aria-label="Account menu"
                    :aria-expanded="userMenuOpen"
                    type="button">
                    <i data-lucide="user" class="w-4 h-4"></i>
                </button>
                    
                <!-- User Menu Dropdown -->
                <div 
                    x-show="userMenuOpen"
                    x-transition:enter="transition ease-out duration-150"
                    x-transition:enter-start="opacity-0 scale-95"
                    x-transition:enter-end="opacity-100 scale-100"
                    x-transition:leave="transition ease-in duration-100"
                    x-transition:leave-start="opacity-100 scale-100"
                    x-transition:leave-end="opacity-0 scale-95"
                    @click.away="userMenuOpen = false"
                    @keydown.escape="userMenuOpen = false"
                    class="absolute top-full right-0 mt-2 w-80 glass-panel rounded-lg border border-white/10 shadow-xl z-50 overflow-hidden"
                    style="display: none;">
                    
                    <!-- Account Balance Section -->
                    <div class="px-4 py-4 border-b border-white/10">
                        <div class="text-xs text-white/60 mb-2 uppercase tracking-wider">Account Balance</div>
                        <div id="account-info-menu" 
                             hx-get="/api/balance" 
                             hx-trigger="load, every 10s[document.visibilityState === 'visible']" 
                             hx-swap="innerHTML" 
                             hx-indicator="#account-info-menu">
                            <div class="flex items-center justify-center py-4">
                                <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-primary"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu Items -->
                    <div class="py-2">
                        <button 
                            @click="userMenuOpen = false; if (typeof showAccountManager === 'function') showAccountManager();"
                            class="w-full flex items-center gap-3 px-4 py-2.5 text-left hover:bg-white/5 transition-colors text-sm text-white/90"
                            type="button">
                            <i data-lucide="settings" class="w-4 h-4 text-white/60"></i>
                            <span>Manage Accounts</span>
                        </button>
                        <button 
                            hx-get="/api/balance"
                            hx-target="#account-info-menu, #account-info"
                            hx-swap="innerHTML"
                            @click="userMenuOpen = false"
                            class="w-full flex items-center gap-3 px-4 py-2.5 text-left hover:bg-white/5 transition-colors text-sm text-white/90"
                            type="button">
                            <i data-lucide="refresh-cw" class="w-4 h-4 text-white/60"></i>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="max-w-[1400px] mx-auto pb-12 px-4 md:px-6" style="position: relative; z-index: 1; width: 100%;">
    <!-- Account balance shown only on mobile (hidden on desktop since nav has it) -->
    <div class="md:hidden block mb-6">
        <div class="glass-panel rounded-xl p-4">
            <div id="account-info-mobile" 
                 hx-get="/api/balance" 
                 hx-trigger="load, every 10s[document.visibilityState === 'visible']" 
                 hx-swap="innerHTML" 
                 hx-indicator="#account-info-mobile">
                <div class="flex items-center justify-center py-2">
                    <i data-lucide="loader-2" class="w-4 h-4 animate-spin text-primary"></i>
                    <span class="ml-2 text-xs text-muted">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Strategy Help Button - Elegant Floating Action Button -->
    <button 
        id="strategy-help-btn"
        x-data="{ showTooltip: false }"
        @mouseenter="showTooltip = true"
        @mouseleave="showTooltip = false"
        @click="
            modals['strategy-help'] = true;
            if (typeof refreshLucideIcons === 'function') refreshLucideIcons();
        "
        class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-gradient-to-br from-purple-500/90 to-cyan-500/90 backdrop-blur-xl border border-purple-400/30 shadow-2xl shadow-purple-500/30 flex items-center justify-center text-white hover:scale-110 hover:shadow-purple-500/50 transition-all duration-300 group"
        aria-label="Learn about our strategy">
        <i data-lucide="help-circle" class="w-7 h-7 transition-transform group-hover:rotate-12"></i>
        <!-- Tooltip -->
        <div 
            x-show="showTooltip"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 translate-y-2"
            x-transition:enter-end="opacity-100 translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 translate-y-0"
            x-transition:leave-end="opacity-0 translate-y-2"
            class="absolute bottom-full right-0 mb-3 px-4 py-2 bg-gray-900/95 backdrop-blur-xl border border-purple-500/30 rounded-lg shadow-xl whitespace-nowrap text-sm text-white pointer-events-none">
            <span class="font-semibold">Learn Our Strategy</span>
            <div class="absolute top-full right-6 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-purple-500/30"></div>
        </div>
    </button>

    <!-- Strategy Help Modal - Premium Design -->
    <div 
        id="strategy-help-modal"
        x-show="modals['strategy-help']"
        x-cloak
        @click.self="modals['strategy-help'] = false"
        @keydown.escape.window="modals['strategy-help'] = false"
        class="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0">
        
        <div 
            x-show="modals['strategy-help']"
            @click.stop
            class="glass-panel rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border border-purple-500/30 shadow-2xl shadow-purple-500/20"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 scale-95 translate-y-4"
            x-transition:enter-end="opacity-100 scale-100 translate-y-0"
            x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="opacity-100 scale-100 translate-y-0"
            x-transition:leave-end="opacity-0 scale-95 translate-y-4">
            
            <!-- Header -->
            <div class="sticky top-0 z-10 p-6 border-b border-purple-500/20 bg-gradient-to-r from-purple-500/10 to-cyan-500/10 backdrop-blur-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500/30 to-cyan-500/30 flex items-center justify-center border border-purple-400/30">
                            <i data-lucide="target" class="w-6 h-6 text-purple-300"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-white">Our Strategy</h2>
                            <p class="text-sm text-gray-300 mt-0.5">Buy Low, Sell High - The Bounce-Back Method</p>
                        </div>
                    </div>
                    <button 
                        @click="modals['strategy-help'] = false"
                        class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-all">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6 space-y-6">
                <!-- Intro -->
                <div class="p-5 rounded-xl bg-gradient-to-br from-purple-500/10 to-cyan-500/10 border border-purple-500/20">
                    <p class="text-gray-200 text-lg leading-relaxed">
                        Think of it like buying a house in a <strong class="text-white">good neighborhood</strong> that's temporarily on sale. 
                        We find stocks that are:
                    </p>
                </div>

                <!-- Strategy Points Grid -->
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="group p-5 rounded-xl bg-purple-500/10 border border-purple-500/30 hover:bg-purple-500/15 hover:border-purple-500/50 transition-all duration-300 hover:scale-[1.02]">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500/30 to-purple-600/30 flex items-center justify-center border border-purple-400/30 group-hover:scale-110 transition-transform">
                                <i data-lucide="trending-down" class="w-6 h-6 text-purple-300"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-white text-lg mb-2">LOW</h3>
                                <p class="text-sm text-gray-300 leading-relaxed">Oversold (temporarily beaten down, like a sale)</p>
                            </div>
                        </div>
                    </div>

                    <div class="group p-5 rounded-xl bg-green-500/10 border border-green-500/30 hover:bg-green-500/15 hover:border-green-500/50 transition-all duration-300 hover:scale-[1.02]">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-green-500/30 to-green-600/30 flex items-center justify-center border border-green-400/30 group-hover:scale-110 transition-transform">
                                <i data-lucide="anchor" class="w-6 h-6 text-green-300"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-white text-lg mb-2">NEAR SUPPORT</h3>
                                <p class="text-sm text-gray-300 leading-relaxed">Close to their 200-day average (the "foundation" - shows it's still a good stock)</p>
                            </div>
                        </div>
                    </div>

                    <div class="group p-5 rounded-xl bg-blue-500/10 border border-blue-500/30 hover:bg-blue-500/15 hover:border-blue-500/50 transition-all duration-300 hover:scale-[1.02]">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500/30 to-blue-600/30 flex items-center justify-center border border-blue-400/30 group-hover:scale-110 transition-transform">
                                <i data-lucide="trending-up" class="w-6 h-6 text-blue-300"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-white text-lg mb-2">IN AN UPTREND</h3>
                                <p class="text-sm text-gray-300 leading-relaxed">Price is above the 200-day average (the neighborhood is improving, not declining)</p>
                            </div>
                        </div>
                    </div>

                    <div class="group p-5 rounded-xl bg-yellow-500/10 border border-yellow-500/30 hover:bg-yellow-500/15 hover:border-yellow-500/50 transition-all duration-300 hover:scale-[1.02]">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500/30 to-yellow-600/30 flex items-center justify-center border border-yellow-400/30 group-hover:scale-110 transition-transform">
                                <i data-lucide="sparkles" class="w-6 h-6 text-yellow-300"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-white text-lg mb-2">READY TO BOUNCE</h3>
                                <p class="text-sm text-gray-300 leading-relaxed">AI validates there's good reason to expect a bounce back up</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary -->
                <div class="p-6 rounded-xl bg-gradient-to-r from-green-500/10 via-purple-500/10 to-cyan-500/10 border border-green-500/30 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-green-500/5 to-transparent opacity-50"></div>
                    <div class="relative">
                        <p class="text-gray-200 text-base leading-relaxed">
                            <strong class="text-white text-lg">We buy when they're low</strong>, set a stop loss to protect us if we're wrong, 
                            and <strong class="text-white text-lg">take profit when they bounce back up</strong>. 
                        </p>
                        <p class="text-green-300 font-bold text-lg mt-3 flex items-center gap-2">
                            <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                            Simple. Focused. Buy low, sell high.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Signal Hunter Section - Above Dashboard -->
    <div id="signal-hunter-section-wrapper" 
         hx-get="/api/signal-hunter-section" 
         hx-trigger="load" 
         hx-swap="innerHTML"
         class="mb-6">
        <div class="glass-panel rounded-2xl p-8 border border-purple-500/30 text-center">
            <i data-lucide="loader-2" class="w-8 h-8 animate-spin text-purple-400 mx-auto mb-2"></i>
            <p class="text-gray-400">Loading Signal Hunter...</p>
        </div>
    </div>

    <!-- Main Dashboard Layout: Watchlist + Positions/Strategy -->
    <div class="dashboard-container mb-6">
        
        <!-- WATCHLIST - Main Section (Left, Larger on Desktop) -->
        <div id="watchlist-section" class="dashboard-main glass-panel rounded-2xl overflow-hidden border border-yellow-500/30">
            <!-- Watchlist Header with View Toggle -->
            <div class="border-b border-yellow-500/20 bg-yellow-500/10 flex-shrink-0">
                <!-- Header Row: Title + View Toggle + Controls -->
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="relative flex-shrink-0">
                            <div id="watchlist-icon" class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-500/30 via-amber-500/20 to-red-500/30 flex items-center justify-center border-2 border-yellow-500/40 transition-all duration-300 shadow-lg shadow-yellow-500/20">
                                <i data-lucide="trending-up" class="w-6 h-6 text-yellow-300"></i>
                            </div>
                            <div id="watchlist-pulse" class="absolute inset-0 rounded-full bg-yellow-500/30 animate-ping opacity-0"></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <!-- Watchlist Title -->
                            <div class="flex items-center gap-3 mb-1">
                                <h2 id="main-section-title" class="text-xl font-bold text-white">WATCHLIST</h2>
                                <span id="radar-status-badge" class="badge badge-info text-xs px-2 py-1 hidden">
                                    <span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-1.5 animate-pulse"></span>
                                    <span id="radar-status-text">watching...</span>
                                </span>
                            </div>
                            <!-- Progress State: Message + Details (hidden by default) -->
                            <div id="header-progress" class="hidden">
                                <div id="progress-message" class="text-sm font-semibold text-white">FLUX is analyzing...</div>
                                <div id="progress-details" class="text-xs text-gray-100 mt-0.5 font-medium"></div>
                            </div>
                            <p id="header-subtitle" class="text-xs text-gray-100">
                                Click cards to analyze stocks and view detailed analysis
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <!-- Progress Percentage (hidden by default, shown when scanning) -->
                        <div id="progress-percentage-container" class="hidden text-right mr-2">
                            <div id="progress-percentage" class="text-xl font-bold text-yellow-400">0%</div>
                            <div class="text-xs text-gray-200 font-medium">Complete</div>
                        </div>
                        <span id="cache-indicator" class="hidden badge badge-info text-xs px-2 py-1" title="Showing cached data">
                            <i data-lucide="database" class="mr-1 w-3 h-3"></i>
                            <span id="cache-time">Cached</span>
                        </span>
                    </div>
                </div>
                <!-- Progress Bar Row (hidden by default, shown when scanning) -->
                <div id="progress-bar-container" class="hidden px-4 pb-3">
                    <div class="w-full bg-gray-700/50 rounded-full h-2 overflow-hidden shadow-inner">
                        <div id="progress-bar" class="bg-gradient-to-r from-yellow-500 via-amber-500 to-red-500 h-2 rounded-full transition-all duration-500 ease-out relative overflow-hidden" style="width: 0%">
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-shimmer"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area: Watchlist View -->
            <div class="flex-1 p-4 min-h-0 overflow-y-auto overflow-x-hidden" style="overscroll-behavior: contain;">
                
                <!-- WATCHLIST VIEW (Default) -->
                <div id="watchlist-view" x-show="mainView === 'watchlist'" x-transition class="h-full flex flex-col">
                    <!-- Watchlist Content with Integrated Preview -->
                    <div id="watchlist-content" 
                         hx-get="/api/watch-list" 
                         hx-trigger="load"
                         hx-swap="innerHTML"
                         hx-indicator="#watchlist-content"
                         hx-on::before-request="
                             const indicator = document.getElementById('watchlist-re-evaluating');
                             if (indicator) indicator.style.display = 'block';
                         "
                         hx-on::after-request="
                             const indicator = document.getElementById('watchlist-re-evaluating');
                             if (indicator) {
                                 setTimeout(() => indicator.style.display = 'none', 500);
                             }
                         "
                         class="fade-in flex-1 min-h-0 relative">
                        <!-- Re-evaluation Indicator -->
                        <div id="watchlist-re-evaluating" 
                             class="absolute top-0 left-0 right-0 z-20 bg-purple-500/20 border-b border-purple-500/30 px-4 py-2 text-center text-xs text-purple-300 font-semibold backdrop-blur-sm"
                             style="display: none;">
                            <div class="flex items-center justify-center gap-2">
                                <i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i>
                                <span>Re-evaluating watchlist with new strategy criteria...</span>
                            </div>
                        </div>
                        <div class="text-center py-8 text-gray-200">
                            <i data-lucide="loader-2" class="mb-2 w-5 h-5 lucide-spin"></i>
                            <p class="text-xs">Loading watchlist...</p>
                        </div>
                    </div>
                    
                    <!-- Analyze Status Message - Compact -->
                    <div id="analyze-status-message" class="text-xs mt-1.5 font-medium text-center min-h-[1rem]"></div>
                </div>
            </div>
        </div>
        
        <!-- 2-Tab Section (Right, Smaller on Desktop) - Positions & Strategy Only -->
        <div class="dashboard-sidebar">
            <div class="glass-panel rounded-2xl overflow-hidden border border-purple-500/20 h-full flex flex-col min-h-0">
                <!-- Tab Headers -->
                <div class="flex border-b border-gray-700/50 flex-shrink-0">
                    <button @click="switchTab('positions-tab')" id="tab-positions-btn" class="tab-btn flex-1 px-2 py-2 text-xs font-semibold text-white bg-purple-500/20 border-b-2 border-purple-500 transition-all">
                        <i data-lucide="briefcase" class="mr-1.5 text-xs w-3 h-3"></i>Positions
                    </button>
                    <button @click="switchTab('strategy-tab')" id="tab-strategy-btn" class="tab-btn flex-1 px-2 py-2 text-xs font-semibold text-gray-200 hover:text-white transition-all">
                        <i data-lucide="settings" class="mr-1.5 text-xs w-3 h-3"></i>Strategy
                    </button>
                </div>
                
                <!-- Tab Content -->
                <div class="p-4 flex-1 overflow-y-auto min-h-0">
                    <!-- Positions Tab -->
                    <div x-show="activeTab === 'positions'" x-transition class="tab-content">
                        <h2 class="text-lg font-bold text-white mb-3">Your Low Buys</h2>
                        <p class="text-xs text-gray-100 mb-3 font-medium">Active positions - Buy Low, Sell High</p>
                        <!-- HTMX Pattern: Optimized polling - only when tab is active and visible -->
                        <!-- Positions list refreshes every 5 seconds when positions tab is active -->
                        <!-- Beautiful Loading State - Only shows on initial load -->
                        <div id="positions-loading" class="mb-4" style="display: none;">
                            <div class="glass rounded-xl p-6 border border-purple-500/30 animate-fade-in">
                                <div class="flex items-center justify-center gap-4">
                                    <div class="relative">
                                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-500/20 via-pink-500/20 to-blue-500/20 flex items-center justify-center border-2 border-purple-500/40 shadow-lg shadow-purple-500/20">
                                            <i data-lucide="loader-2" class="text-purple-400 w-8 h-8 lucide-spin" style="animation-duration: 2s;"></i>
                                            <div class="absolute inset-0 rounded-full bg-purple-500/20 blur-sm"></div>
                                        </div>
                                        <div class="absolute inset-0 rounded-full border-2 border-purple-500/30 animate-ping"></div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-base font-semibold text-white mb-1">Loading Positions...</div>
                                        <div class="text-xs text-gray-100">Fetching your low buys</div>
                                    </div>
                                </div>
                            </div>
                            <script>if (typeof lucide !== 'undefined') lucide.createIcons();</script>
                        </div>
                        <div id="positions-list" 
                             hx-get="/api/positions" 
                             :hx-trigger="activeTab === 'positions' ? 'load, every 5s[document.visibilityState === \'visible\']' : 'load'"
                             hx-swap="innerHTML"
                             hx-on::before-request="
                                const listEl = document.getElementById('positions-list');
                                const loadingEl = document.getElementById('positions-loading');
                                if (!listEl.hasAttribute('data-loaded') && loadingEl) {
                                    loadingEl.style.display = 'block';
                                }
                             "
                             hx-on::after-settle="
                                const listEl = document.getElementById('positions-list');
                                const loadingEl = document.getElementById('positions-loading');
                                listEl.setAttribute('data-loaded', 'true');
                                if (loadingEl) {
                                    loadingEl.style.display = 'none';
                                }
                             "></div>
                    </div>
                    
                    <!-- Strategy Tab -->
                    <div x-show="activeTab === 'strategy'" x-cloak x-transition class="tab-content">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <h2 class="text-lg font-bold text-white">Strategy</h2>
                                <button 
                                    type="button"
                                    @click="modals['strategy-help'] = true; if (typeof refreshLucideIcons === 'function') refreshLucideIcons();"
                                    class="group relative w-6 h-6 rounded-full bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/30 flex items-center justify-center text-purple-300 hover:text-purple-200 transition-all hover:scale-110"
                                    aria-label="Learn about our strategy">
                                    <i data-lucide="help-circle" class="w-4 h-4"></i>
                                    <span class="absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 bg-gray-900/95 backdrop-blur-xl border border-purple-500/30 rounded text-xs text-white whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                        Learn Strategy
                                    </span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Compact Strategy Info Card -->
                        <div class="mb-4 p-4 rounded-xl bg-gradient-to-r from-purple-500/10 to-cyan-500/10 border border-purple-500/20 hover:border-purple-500/30 transition-all cursor-pointer group"
                             @click="modals['strategy-help'] = true; if (typeof refreshLucideIcons === 'function') refreshLucideIcons();">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500/30 to-cyan-500/30 flex items-center justify-center border border-purple-400/30 group-hover:scale-110 transition-transform">
                                    <i data-lucide="target" class="w-5 h-5 text-purple-300"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="text-sm font-semibold text-white">Buy Low, Sell High</h3>
                                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:text-purple-300 group-hover:translate-x-1 transition-all"></i>
                                    </div>
                                    <p class="text-xs text-gray-300 leading-relaxed">
                                        We find oversold stocks near support in uptrends, buy low, set stop losses, and take profit on bounces.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div id="strategy-display" 
                             hx-get="/api/strategy-display" 
                             hx-trigger="load"
                             hx-swap="innerHTML" 
                             hx-indicator="#strategy-display"
                             hx-on::before-request="
                                // Only proceed if element is visible
                                const el = event.target;
                                if (!el || !el.offsetParent && el.style.display !== 'none') {
                                    return false;
                                }
                             "
                             x-init="
                                // Load content when tab becomes active
                                $watch('activeTab', (value) => {
                                    if (value === 'strategy') {
                                        $nextTick(() => {
                                            const el = document.getElementById('strategy-display');
                                            if (el && el.offsetParent !== null && typeof htmx !== 'undefined') {
                                                // Small delay to ensure element is fully visible
                                                setTimeout(() => {
                                                    if (el && el.offsetParent !== null) {
                                                        htmx.trigger(el, 'load');
                                                    }
                                                }, 100);
                                            }
                                        });
                                    }
                                });
                                // Set up polling when strategy tab is active
                                let pollInterval = null;
                                $watch('activeTab', (value) => {
                                    if (value === 'strategy') {
                                        if (pollInterval) clearInterval(pollInterval);
                                        pollInterval = setInterval(() => {
                                            if (document.visibilityState === 'visible') {
                                                const el = document.getElementById('strategy-display');
                                                if (el && el.offsetParent !== null && typeof htmx !== 'undefined') {
                                                    htmx.trigger(el, 'load');
                                                }
                                            }
                                        }, 30000);
                                    } else {
                                        if (pollInterval) {
                                            clearInterval(pollInterval);
                                            pollInterval = null;
                                        }
                                    }
                                });
                             "
                             class="fade-in">
                            <div class="text-center py-4 text-gray-200">
                                <i data-lucide="loader-2" class="mb-2 w-5 h-5 lucide-spin"></i>
                                <p class="text-xs">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div> <!-- End Main Content Container -->

    <!-- Strategy Configuration Modal - Loaded via HTMX into #modal-container -->

    <!-- Scanner Info Modal -->
    <div id="scanner-info-modal" 
         class="modal" 
         x-show="modals['scanner-info']"
         x-cloak
         x-transition
         @click.self="closeModal('scanner-info')">
        <div class="modal-content fade-in" 
             x-show="modals['scanner-info']"
             x-transition
             style="max-width: 700px;">
            <span class="close-modal" @click="closeModal('scanner-info')">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="search" class="text-red-500 w-5 h-5"></i>
                How the Market Scanner Works
            </h2>
            <div class="space-y-4 text-sm">
                <p class="text-white font-medium">The Market Scanner lets you check any stock on-demand. Just type in a stock symbol (like AAPL or NVDA) and FLUX will analyze it using the same intelligent system.</p>
                
                <div class="glass rounded-lg p-4 border-l-4 border-red-500/50">
                    <h3 class="font-bold text-white mb-2">What Happens When You Scan</h3>
                    <p class="text-white text-xs mb-2 font-medium">The scanner does a complete analysis in seconds:</p>
                    <ul class="text-gray-100 text-xs list-disc list-inside ml-4 space-y-1 font-medium">
                        <li>Looks at 500+ days of price history</li>
                        <li>Calculates RSI (is it "on sale"?), SMA-200 (is it trending up?), and ATR (how volatile?)</li>
                        <li>Gets the latest 3 news headlines about the company</li>
                        <li>Reads the full news articles (not just headlines - they can be misleading!)</li>
                        <li>AI analyzes everything and gives you a score from 0-10</li>
                    </ul>
                </div>
                
                <div class="glass rounded-lg p-4 border-l-4 border-blue-500/50">
                    <h3 class="font-bold text-white mb-2">Understanding the AI Score</h3>
                    <p class="text-white text-xs mb-2 font-medium">The score tells you how good of a buying opportunity this is:</p>
                    <div class="space-y-2">
                        <div class="glass rounded p-2 bg-green-500/10 border border-green-500/30">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-xs font-bold text-green-400">8-10: Excellent Opportunity</span>
                                <span class="text-xs text-gray-200">âœ…</span>
                            </div>
                            <p class="text-white text-sm font-medium">Strong buy signal! FLUX found this opportunity through market scanning.</p>
                        </div>
                        <div class="glass rounded p-2 bg-yellow-500/10 border border-yellow-500/30">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-bold text-yellow-400">5-7: Maybe, But Wait</span>
                                <span class="text-sm text-gray-200">âš ï¸</span>
                            </div>
                            <p class="text-white text-sm font-medium">Moderate opportunity. The numbers look okay, but not great. Might be worth watching, but not buying yet.</p>
                        </div>
                        <div class="glass rounded p-2 bg-red-500/10 border border-red-500/30">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-bold text-red-400">0-4: Avoid This Stock</span>
                                <span class="text-sm text-gray-200">âŒ</span>
                            </div>
                            <p class="text-white text-sm font-medium">Weak signal or bad news. The AI found reasons to avoid this stock right now. Better opportunities exist elsewhere.</p>
                        </div>
                    </div>
                </div>
                
                <div class="glass rounded-lg p-4 border-l-4 border-purple-500/50">
                    <h3 class="font-bold text-white mb-2">What You'll See</h3>
                    <p class="text-white text-xs mb-2 font-medium">After scanning, you'll get a detailed report showing:</p>
                    <ul class="text-gray-100 text-xs list-disc list-inside ml-4 space-y-1 font-medium">
                        <li><strong>The AI Score</strong> - Overall rating (0-10)</li>
                        <li><strong>RSI Value</strong> - Is the stock "on sale"? (lower is better for buying)</li>
                        <li><strong>SMA-200 Status</strong> - Is it trending up or down?</li>
                        <li><strong>ATR Value</strong> - How volatile is it?</li>
                        <li><strong>AI's Reasoning</strong> - Why it gave this score (in plain English!)</li>
                        <li><strong>Recent News</strong> - What news influenced the decision</li>
                    </ul>
                </div>
                
                <div class="glass rounded-lg p-4 border-l-4 border-yellow-500/50 bg-yellow-500/5">
                    <h3 class="font-bold text-white mb-2 text-sm">ðŸ’¡ Pro Tip</h3>
                    <p class="text-white text-xs font-medium">Use the scanner to learn! Try scanning different stocks and see how the scores change. Notice patterns - stocks with low RSI and good news tend to score higher. This helps you understand what makes a good investment.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Backtest functionality removed - keeping UI focused -->

    <!-- AI Score Educational Modal -->
    <div id="ai-score-modal" 
         class="modal" 
         x-show="modals['ai-score']"
         x-cloak
         x-transition
         @click.self="closeModal('ai-score')">
        <div class="modal-content fade-in" 
             x-show="modals['ai-score']"
             x-transition
             style="max-width: 700px;">
            <span class="close-modal" @click="closeModal('ai-score')">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="brain" class="text-purple-500 w-5 h-5"></i>
                Understanding the AI Score
            </h2>
            <div class="space-y-4 text-sm">
                <p class="text-gray-300">The AI Score (0-10) is a comprehensive rating that combines technical indicators, news analysis, and market sentiment to help you make informed trading decisions.</p>
                
                <div class="glass rounded-lg p-4 border-l-4 border-purple-500/50">
                    <h3 class="font-bold text-white mb-2">How the AI Calculates the Score</h3>
                    <p class="text-gray-300 text-xs mb-2">The AI analyzes multiple factors:</p>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li><strong>Technical Indicators:</strong> RSI, SMA-200 trend, ATR volatility</li>
                        <li><strong>News Analysis:</strong> Reads full articles (not just headlines!) to understand context</li>
                        <li><strong>Market Sentiment:</strong> Positive vs negative news, company fundamentals</li>
                        <li><strong>Risk Assessment:</strong> Volatility, market conditions, company stability</li>
                    </ul>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-green-500/50">
                    <h3 class="font-bold text-white mb-2">Score Breakdown</h3>
                    <div class="space-y-2">
                        <div class="glass rounded p-3 bg-green-500/10 border border-green-500/30">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-bold text-green-400">8-10: Excellent Opportunity</span>
                                <span class="text-xs text-gray-500">âœ…</span>
                            </div>
                            <p class="text-gray-300 text-xs">Strong buy signal! Technical indicators look great, news is positive, and risk is manageable. This is what we're looking for.</p>
                        </div>
                        <div class="glass rounded p-3 bg-yellow-500/10 border border-yellow-500/30">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-bold text-yellow-400">5-7: Moderate Opportunity</span>
                                <span class="text-xs text-gray-500">âš ï¸</span>
                            </div>
                            <p class="text-gray-300 text-xs">Mixed signals. Some indicators look good, but there might be concerns in the news or technicals. Worth watching, but not a strong buy.</p>
                        </div>
                        <div class="glass rounded p-3 bg-red-500/10 border border-red-500/30">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-bold text-red-400">0-4: Avoid This Stock</span>
                                <span class="text-xs text-gray-500">âŒ</span>
                            </div>
                            <p class="text-gray-300 text-xs">Weak signal or bad news detected. The AI found reasons to avoid this stock - could be negative news, poor technicals, or high risk.</p>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-blue-500/50">
                    <h3 class="font-bold text-white mb-2">Why News Matters</h3>
                    <p class="text-gray-300 text-xs mb-2">The AI doesn't just read headlines - it reads full articles to understand context:</p>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li><strong>Headlines can be misleading:</strong> "Stock drops 5%" might sound bad, but the article might explain it's temporary</li>
                        <li><strong>Context matters:</strong> The AI understands if news is company-specific or market-wide</li>
                        <li><strong>Automatic rejection:</strong> If it finds serious issues (fraud, bankruptcy), score = 0 automatically</li>
                    </ul>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-yellow-500/50 bg-yellow-500/5">
                    <h3 class="font-bold text-white mb-2 text-sm">ðŸ’¡ Pro Tip</h3>
                    <p class="text-gray-300 text-xs">The AI Score is a tool, not a guarantee. Always review the reasoning and your own research. A score of 8+ means the AI thinks it's a good opportunity based on the data it analyzed, but markets are unpredictable!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Levels Educational Modal -->
    <div id="risk-levels-modal" 
         class="modal" 
         x-show="modals['risk-levels']"
         x-cloak
         x-transition
         @click.self="closeModal('risk-levels')">
        <div class="modal-content fade-in" 
             x-show="modals['risk-levels']"
             x-transition
             style="max-width: 700px;">
            <span class="close-modal" @click="closeModal('risk-levels')">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="shield" class="text-yellow-500 w-5 h-5"></i>
                Understanding Risk Levels
            </h2>
            <div class="space-y-4 text-sm">
                <p class="text-gray-300">Every stock analysis includes a risk assessment. Understanding these levels helps you make informed decisions about which trades to approve.</p>
                
                <div class="glass rounded-lg p-4 border-l-4 border-green-500/50">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="badge badge-success text-sm">LOW RISK</span>
                        <span class="text-gray-400 text-xs">Safest opportunities</span>
                    </div>
                    <p class="text-gray-300 text-xs mb-2">Low risk stocks typically have:</p>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li>Stable price movements (low volatility)</li>
                        <li>Positive news and strong fundamentals</li>
                        <li>Established companies with good track records</li>
                        <li>Clear uptrend with strong technical indicators</li>
                    </ul>
                    <p class="text-gray-400 text-xs mt-2"><strong>Example:</strong> Large tech companies like Apple or Microsoft during stable market conditions.</p>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-yellow-500/50">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="badge badge-warning text-sm">MEDIUM RISK</span>
                        <span class="text-gray-400 text-xs">Moderate opportunities</span>
                    </div>
                    <p class="text-gray-300 text-xs mb-2">Medium risk stocks typically have:</p>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li>Moderate price volatility</li>
                        <li>Mixed or neutral news</li>
                        <li>Some uncertainty in market conditions</li>
                        <li>Good technicals but some concerns</li>
                    </ul>
                    <p class="text-gray-400 text-xs mt-2"><strong>Example:</strong> Growth stocks or companies in competitive industries.</p>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-red-500/50">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="badge badge-danger text-sm">HIGH RISK</span>
                        <span class="text-gray-400 text-xs">Risky opportunities</span>
                    </div>
                    <p class="text-gray-300 text-xs mb-2">High risk stocks typically have:</p>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li>High price volatility (big swings)</li>
                        <li>Negative or concerning news</li>
                        <li>Uncertain market conditions</li>
                        <li>Weaker technical indicators</li>
                    </ul>
                    <p class="text-gray-400 text-xs mt-2"><strong>Example:</strong> Small-cap stocks, volatile sectors, or companies facing challenges.</p>
                    <p class="text-red-400 text-xs mt-2 font-bold">âš ï¸ High risk trades require extra caution and may not be suitable for all investors.</p>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-blue-500/50">
                    <h3 class="font-bold text-white mb-2">How Risk Affects Your Strategy</h3>
                    <p class="text-gray-300 text-xs mb-2">The system automatically adjusts position sizing based on risk:</p>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li><strong>Low Risk:</strong> Larger position sizes (more shares)</li>
                        <li><strong>Medium Risk:</strong> Moderate position sizes</li>
                        <li><strong>High Risk:</strong> Smaller position sizes (fewer shares) to limit potential losses</li>
                    </ul>
                    <p class="text-gray-400 text-xs mt-2">This protects your capital - riskier stocks get smaller positions so you don't lose too much if they drop.</p>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-yellow-500/50 bg-yellow-500/5">
                    <h3 class="font-bold text-white mb-2 text-sm">ðŸ’¡ Remember</h3>
                    <p class="text-gray-300 text-xs">Risk level is just one factor. Always consider the AI score, your own research, and your risk tolerance. Even "low risk" trades can lose money - never invest more than you can afford to lose!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Positions Educational Modal -->
    <div id="positions-info-modal" 
         class="modal" 
         x-show="modals['positions-info']"
         x-cloak
         x-transition
         @click.self="closeModal('positions-info')">
        <div class="modal-content fade-in" 
             x-show="modals['positions-info']"
             x-transition
             style="max-width: 700px;">
            <span class="close-modal" @click="closeModal('positions-info')">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="wallet" class="text-purple-500 w-5 h-5"></i>
                Understanding Your Positions
            </h2>
            <div class="space-y-4 text-sm">
                <p class="text-gray-300">Your positions show all the stocks you currently own. Understanding this section helps you track your investments and manage your portfolio.</p>
                
                <div class="glass rounded-lg p-4 border-l-4 border-purple-500/50">
                    <h3 class="font-bold text-white mb-2">What You'll See</h3>
                    <p class="text-gray-300 text-xs mb-2">For each position, you'll see:</p>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li><strong>Symbol:</strong> The stock ticker (e.g., AAPL, NVDA)</li>
                        <li><strong>Shares:</strong> How many shares you own</li>
                        <li><strong>Average Price:</strong> The price you bought at</li>
                        <li><strong>Current Value:</strong> Total value of your position (shares Ã— current price)</li>
                        <li><strong>P&L (Profit & Loss):</strong> How much you've gained or lost</li>
                        <li><strong>P&L %:</strong> Your gain/loss as a percentage</li>
                    </ul>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-green-500/50">
                    <h3 class="font-bold text-white mb-2">Understanding Profit & Loss</h3>
                    <div class="space-y-2">
                        <div class="glass rounded p-2 bg-green-500/10 border border-green-500/30">
                            <p class="text-gray-300 text-xs"><strong>Green P&L:</strong> You're making money! The stock price is above what you paid.</p>
                            <p class="text-gray-400 text-xs mt-1">Example: Bought at $100, now worth $110 â†’ +$10 profit (+10%)</p>
                        </div>
                        <div class="glass rounded p-2 bg-red-500/10 border border-red-500/30">
                            <p class="text-gray-300 text-xs"><strong>Red P&L:</strong> You're losing money. The stock price is below what you paid.</p>
                            <p class="text-gray-400 text-xs mt-1">Example: Bought at $100, now worth $95 â†’ -$5 loss (-5%)</p>
                        </div>
                    </div>
                    <p class="text-gray-400 text-xs mt-2">ðŸ’¡ <strong>Remember:</strong> P&L is "unrealized" until you sell. It changes with the stock price!</p>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-blue-500/50">
                    <h3 class="font-bold text-white mb-2">Position Actions</h3>
                    <p class="text-gray-300 text-xs mb-2">You can take actions on your positions:</p>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li><strong>SELL:</strong> Sell all shares and close the position</li>
                        <li><strong>Analyze:</strong> Run a new analysis to see current AI score and indicators</li>
                    </ul>
                    <p class="text-gray-400 text-xs mt-2">ðŸ’¡ <strong>Tip:</strong> Use the analyze button to check if you should hold or sell based on current conditions.</p>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-yellow-500/50">
                    <h3 class="font-bold text-white mb-2">Automatic Safety Features</h3>
                    <p class="text-gray-300 text-xs mb-2">When you approved a trade, the system automatically set up:</p>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li><strong>Stop Loss:</strong> Automatically sells if price drops too much (limits losses)</li>
                        <li><strong>Take Profit:</strong> Automatically sells if price goes up enough (locks in gains)</li>
                    </ul>
                    <p class="text-gray-400 text-xs mt-2">These protect your capital - you don't need to watch constantly!</p>
                </div>

                <div class="glass rounded-lg p-4 border-l-4 border-red-500/50">
                    <h3 class="font-bold text-white mb-2">âš ï¸ Important Notes</h3>
                    <ul class="text-gray-400 text-xs list-disc list-inside ml-4 space-y-1">
                        <li>Positions update in real-time as stock prices change</li>
                        <li>P&L is "unrealized" - you haven't actually made/lost money until you sell</li>
                        <li>The system won't suggest buying more shares of stocks you already own</li>
                        <li>Always review positions regularly and consider taking profits or cutting losses</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Rejection modal removed - now handled by HTMX modal system in analysis_modal_wrapper.html -->

    <!-- Explanation Modal -->
    <div id="explanation-modal" 
         class="modal" 
         x-show="modals.explanation"
         x-cloak
         x-transition
         @click.self="closeModal('explanation')">
        <div class="modal-content fade-in" 
             x-show="modals.explanation"
             x-transition
             style="max-width: 95vw; width: 1600px; max-height: 95vh; padding: 2.5rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
            <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-700/50">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="info" class="text-purple-400 w-4 h-4"></i>
                    <span id="explanation-symbol">Detailed Explanation</span>
                </h2>
                <span class="close-modal" @click="closeModal('explanation')" style="float: none;">&times;</span>
            </div>
            <div id="explanation-content" class="space-y-3">
                <div class="text-center py-8 text-gray-500">
                    <i data-lucide="loader-2" class="text-2xl mb-2 w-8 h-8 lucide-spin"></i>
                    <p class="text-sm">Loading explanation...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Metric Info Modal -->
    <div id="metric-info-modal" class="modal" style="display: none;">
        <div class="modal-content fade-in slide-in-3d" style="max-width: 600px; padding: 2rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
            <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-700/50">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i id="metric-icon" data-lucide="trending-up" class="text-blue-400 w-5 h-5"></i>
                    <span id="metric-title">Metric Information</span>
                </h2>
                <span class="close-modal cursor-pointer text-gray-400 hover:text-white text-2xl transition-transform hover:rotate-90" @click="closeMetricModal()">&times;</span>
            </div>
            <div id="metric-content" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <i data-lucide="loader-2" class="text-2xl mb-2 w-8 h-8 lucide-spin"></i>
                    <p class="text-sm">Loading information...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Buy Order Modal -->
    <div id="buy-order-modal" 
         class="modal" 
         x-show="modals['buy-order']"
         x-cloak
         x-transition
         @click.self="closeModal('buy-order')">
        <div class="modal-content fade-in" 
             x-show="modals['buy-order']"
             x-transition
             style="max-width: 500px; padding: 2rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
            <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-700/50">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <i data-lucide="shopping-cart" class="text-green-400 w-5 h-5"></i>
                    <span id="buy-modal-symbol">Buy Stock</span>
                </h2>
                <span class="close-modal cursor-pointer text-gray-400 hover:text-white text-2xl" @click="closeModal('buy-order')">&times;</span>
            </div>
            <form id="buy-order-form" 
                  hx-post="/api/quick-buy" 
                  hx-target="body" 
                  hx-swap="none"
                  hx-indicator="#buy-order-form">
                <input type="hidden" name="symbol" id="buy-order-symbol" value="">
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-300 mb-3">
                        <i data-lucide="sliders-horizontal" class="text-green-400 mr-2 w-4 h-4"></i>
                        Number of Shares
                    </label>
                    <div class="relative">
                        <input 
                            type="range" 
                            id="buy-qty-slider" 
                            name="qty" 
                            min="1" 
                            max="99" 
                            value="10" 
                            step="1"
                            class="w-full h-3 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"
                            oninput="updateBuyQtyDisplay(this.value)"
                        >
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>1</span>
                            <span>50</span>
                            <span>99</span>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="inline-flex items-center gap-3 glass rounded-lg px-6 py-3 border border-green-500/30 bg-green-500/10">
                            <span class="text-3xl font-bold text-green-400" id="buy-qty-display">10</span>
                            <span class="text-gray-400 text-sm">shares</span>
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-3 glass rounded-lg border border-gray-700/50 bg-gray-800/30">
                    <div class="text-xs text-gray-400 mb-2">Order Summary</div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-300 text-sm">Symbol:</span>
                        <span class="text-white font-bold" id="buy-summary-symbol">-</span>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-gray-300 text-sm">Quantity:</span>
                        <span class="text-green-400 font-bold" id="buy-summary-qty">10</span>
                    </div>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-700/30">
                        <span class="text-gray-300 text-sm">Order Type:</span>
                        <span class="text-yellow-400 font-semibold text-xs">LIMIT (with Stop Loss & Take Profit)</span>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button 
                        type="button"
                        @click="closeModal('buy-order')"
                        class="flex-1 glass-strong py-2.5 rounded-lg text-sm font-semibold text-white hover:bg-gray-600/30 transition-all bg-gray-500/20 flex items-center justify-center gap-1.5 border border-gray-500/30">
                        <i data-lucide="x" class="text-xs w-3 h-3"></i>
                        <span>CANCEL</span>
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 glass-strong py-2.5 rounded-lg text-sm font-bold text-white hover:bg-green-600/30 transition-all bg-green-500/30 flex items-center justify-center gap-1.5 border border-green-500/50">
                        <i data-lucide="check" class="text-xs w-3 h-3"></i>
                        <span>CONFIRM BUY</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- HTMX Pattern: Just-in-Time Modal Container
         Modals are fetched from server when needed, not hidden in DOM.
         This container receives modal HTML fragments via HTMX.
    -->
    <div id="modal-container" aria-live="polite" aria-atomic="true"></div>

    <script>/**
         * WebSocket Connection State
         * 
         * Manages WebSocket connection for real-time stock scanning updates.
         */
        let wsConnection = null;
        let wsTimeout = null;
        let wsRetryCount = 0;
        let previousStocks = null; // For intelligent refresh detection
        
        
        // Compare stocks for intelligent refresh
        function compareStocks(oldStocks, newStocks) {
            if (!oldStocks || oldStocks.length === 0) return true; // New scan
            
            const oldMap = new Map();
            oldStocks.forEach(s => {
                oldMap.set(s.symbol, { score: s.score || 0, symbol: s.symbol });
            });
            
            const newMap = new Map();
            newStocks.forEach(s => {
                newMap.set(s.symbol, { score: s.ai_score || 0, symbol: s.symbol });
            });
            
            // Check if symbols changed
            if (oldMap.size !== newMap.size) return true;
            
            // Check if any symbols are different
            for (const symbol of oldMap.keys()) {
                if (!newMap.has(symbol)) return true;
            }
            
            for (const symbol of newMap.keys()) {
                if (!oldMap.has(symbol)) return true;
            }
            
            // Check if scores changed significantly (more than 0.5 difference)
            for (const [symbol, oldData] of oldMap.entries()) {
                const newData = newMap.get(symbol);
                if (Math.abs(oldData.score - newData.score) > 0.5) {
                    return true;
                }
            }
            
            return false; // No significant changes
        }
        let isLoadingMore = false;
        let allStocks = [];
        let allStocksForFilter = [];
        let displayedStocks = [];
        let customSymbols = null; // Can be set for custom scans (currently unused - backend handles symbol selection)
        const STOCKS_PER_PAGE = 12; // Items per page
        
        // Pagination state
        let currentPage = 1;
        let showAllMode = false;
        let filteredStocks = [];
        
        // Load latest scan from MongoDB via API
        async function loadLatestScan() {
            try {
                const response = await fetch('/api/latest-scan');
                if (!response.ok) {
                    console.warn('Failed to load latest scan:', response.status);
                    return null;
                }
                const scanData = await response.json();
                if (scanData && scanData.stocks && scanData.stocks.length > 0) {
                    return scanData;
                }
                return null;
            } catch (e) {
                console.warn('Failed to load latest scan from API:', e);
                return null;
            }
        }
        
        function updateRadarStatus(status, text) {
            const badge = document.getElementById('radar-status-badge');
            const statusText = document.getElementById('radar-status-text');
            const radarIcon = document.getElementById('radar-icon');
            const radarPulse = document.getElementById('radar-pulse');
            
            if (badge && statusText) {
                if (status === 'scanning') {
                    badge.classList.remove('hidden');
                    badge.className = 'badge badge-info text-xs px-2 py-1';
                    statusText.textContent = text || 'FLUX is analyzing...';
                    if (radarPulse) radarPulse.classList.remove('opacity-0');
                    if (radarIcon) radarIcon.classList.add('animate-pulse');
                } else if (status === 'idle') {
                    badge.classList.add('hidden');
                    if (radarPulse) radarPulse.classList.add('opacity-0');
                    if (radarIcon) radarIcon.classList.remove('animate-pulse');
                } else if (status === 'complete') {
                    badge.classList.remove('hidden');
                    badge.className = 'badge badge-success text-xs px-2 py-1';
                    statusText.textContent = text || 'FLUX is ready';
                    if (radarPulse) radarPulse.classList.add('opacity-0');
                    if (radarIcon) radarIcon.classList.remove('animate-pulse');
                    setTimeout(() => updateRadarStatus('idle'), 3000);
                }
            }
        }
        
        function updateScanButtonState(isScanning) {
            const btn = document.getElementById('scan-now-btn');
            const icon = document.getElementById('scan-icon');
            const text = document.getElementById('scan-text');
            
            if (btn && icon && text) {
                if (isScanning) {
                    btn.disabled = true;
                    btn.classList.add('opacity-75', 'cursor-not-allowed');
                    icon.setAttribute('data-lucide', 'loader-2');
                    icon.className = 'lucide-spin text-sm w-4 h-4';
                    lucide.createIcons();
                    text.textContent = 'Loading...';
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                    icon.setAttribute('data-lucide', 'eye');
                    icon.className = 'text-sm w-4 h-4';
                    lucide.createIcons();
                    text.textContent = 'Watch';
                }
            }
        }
        
        function loadTrendingStocksWithProgress(backgroundRefresh = false, customSymbols = null) {
            // Try to find section - could be radar-section or watchlist-section
            const section = document.getElementById('radar-section') || document.getElementById('watchlist-section');
            const slider = document.getElementById('trending-stocks-slider');
            // Merged progress into header - use new IDs
            const headerNormal = document.getElementById('header-normal');
            const headerProgress = document.getElementById('header-progress');
            const headerSubtitle = document.getElementById('header-subtitle');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const progressPercentageContainer = document.getElementById('progress-percentage-container');
            const scanningState = document.getElementById('scanning-state');
            const emptyState = document.getElementById('empty-state');
            const progressBar = document.getElementById('progress-bar');
            const progressMessage = document.getElementById('progress-message');
            const progressPercentage = document.getElementById('progress-percentage');
            const progressDetails = document.getElementById('progress-details');
            const scanningMessage = document.getElementById('scanning-message');
            
            // Note: Backend handles symbol selection (scans 10+ stocks intelligently)
            // No need to specify symbols here - WebSocket endpoint has its own list
            
            // Show section if it exists
            if (section) {
                section.classList.remove('hidden');
            }
            
            // Update UI state
            updateRadarStatus('scanning', 'Scanning...');
            updateScanButtonState(true);
            
            // If background refresh, don't show progress UI
            if (backgroundRefresh) {
                // Hide progress, show normal header
                if (headerNormal) headerNormal.classList.remove('hidden');
                if (headerProgress) headerProgress.classList.add('hidden');
                if (headerSubtitle) headerSubtitle.classList.remove('hidden');
                if (progressBarContainer) progressBarContainer.classList.add('hidden');
                if (progressPercentageContainer) progressPercentageContainer.classList.add('hidden');
                if (scanningState) scanningState.classList.add('hidden');
                // Keep existing content, just refresh in background
            } else {
                // Hide empty state
                if (emptyState) emptyState.classList.add('hidden');
                
                // Show scanning state
                if (scanningState) {
                    scanningState.classList.remove('hidden');
                    scanningState.classList.add('fade-in');
                }
                
                // Show progress UI for foreground refresh
                const sliderTrack = document.getElementById('slider-track');
                if (sliderTrack) sliderTrack.innerHTML = '';
                // Show progress in header, hide normal title
                if (headerNormal) headerNormal.classList.add('hidden');
                if (headerProgress) headerProgress.classList.remove('hidden');
                if (headerSubtitle) headerSubtitle.classList.add('hidden');
                if (progressBarContainer) progressBarContainer.classList.remove('hidden');
                if (progressPercentageContainer) progressPercentageContainer.classList.remove('hidden');
                if (progressBar) progressBar.style.width = '0%';
                if (progressMessage) progressMessage.textContent = 'FLUX connects to the markets...';
                if (progressPercentage) progressPercentage.textContent = '0%';
                if (progressDetails) progressDetails.textContent = 'Initializing watch';
                if (scanningMessage) scanningMessage.textContent = 'FLUX connects to the markets...';
            }
            
            // Reset state
            allStocks = [];
            allStocksForFilter = []; // Reset filter array to prevent stale data
            displayedStocks = [];
            currentPage = 1; // Start at page 1, not 0
            isLoadingMore = false;
            
            // Clear slider track immediately for fresh start
            const sliderTrack = document.getElementById('slider-track');
            if (sliderTrack) {
                sliderTrack.innerHTML = '';
            }
            
            // Determine WebSocket URL with optional custom symbols
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            let wsUrl = `${protocol}//${window.location.host}/ws`;
            const params = [];
            if (customSymbols && customSymbols.length > 0) {
                params.push(`symbols=${customSymbols.join(',')}`);
            } else if (window.pendingCustomSymbols && window.pendingCustomSymbols.length > 0) {
                params.push(`symbols=${window.pendingCustomSymbols.join(',')}`);
                window.pendingCustomSymbols = null; // Clear after use
            }
            if (params.length > 0) {
                wsUrl += `?${params.join('&')}`;
            }
            
            // Close existing connection properly
            if (wsConnection) {
                if (wsConnection.readyState === WebSocket.OPEN || wsConnection.readyState === WebSocket.CONNECTING) {
                    wsConnection.close(1000, 'New analysis started');
                }
                wsConnection.onopen = null;
                wsConnection.onmessage = null;
                wsConnection.onerror = null;
                wsConnection.onclose = null;
                wsConnection = null;
            }
            
            // Clear any existing timeout
            if (wsTimeout) {
                clearTimeout(wsTimeout);
                wsTimeout = null;
            }
            
            // Small delay to ensure cleanup completes before new connection
            // Use setTimeout instead of await since this function is not async
            setTimeout(() => {
                // Create WebSocket connection
                wsConnection = new WebSocket(wsUrl);
                
                // Set connection timeout (5 seconds)
                wsTimeout = setTimeout(() => {
                    if (wsConnection && wsConnection.readyState !== WebSocket.OPEN) {
                        console.error('[WS] Connection timeout after 5 seconds');
                        handleConnectionFailure();
                    }
                }, 5000);
                
                wsConnection.onopen = () => {
                    if (wsTimeout) {
                        clearTimeout(wsTimeout);
                        wsTimeout = null;
                    }
                    wsRetryCount = 0; // Reset retry count on successful connection
                    // Refetch progress elements to ensure fresh references
                    const progressMsg = document.getElementById('progress-message');
                    const scanningMsg = document.getElementById('scanning-message');
                    if (progressMsg) progressMsg.textContent = 'Connected - FLUX is analyzing the markets...';
                    if (scanningMsg) scanningMsg.textContent = 'FLUX analyzes stocks for trading opportunities';
                };
                
                wsConnection.onmessage = (event) => {
                    // Refetch progress elements inside handler to ensure fresh references
                    const progressBar = document.getElementById('progress-bar');
                    const progressPercentage = document.getElementById('progress-percentage');
                    const progressMessage = document.getElementById('progress-message');
                    const progressDetails = document.getElementById('progress-details');
                    const headerNormal = document.getElementById('header-normal');
                    const headerProgress = document.getElementById('header-progress');
                    const headerSubtitle = document.getElementById('header-subtitle');
                    const progressBarContainer = document.getElementById('progress-bar-container');
                    const progressPercentageContainer = document.getElementById('progress-percentage-container');
                    const scanningMessage = document.getElementById('scanning-message');
                    
                    try {
                        const data = JSON.parse(event.data);
                        
                        if (data.type === 'progress') {
                            // Update progress bar
                            const percentage = data.percentage || 0;
                            if (progressBar) progressBar.style.width = `${percentage}%`;
                            if (progressPercentage) progressPercentage.textContent = `${percentage}%`;
                            if (progressMessage) progressMessage.textContent = data.message || 'FLUX is analyzing...';
                            
                            if (data.symbol) {
                                if (progressDetails) progressDetails.textContent = `FLUX analyzing ${data.symbol} (${data.current}/${data.total})`;
                                const scanningMsg = document.getElementById('scanning-message');
                                if (scanningMsg) scanningMsg.textContent = `FLUX analyzing ${data.symbol}...`;
                            }
                            
                            // Show stage if available
                            if (progressDetails) {
                                if (data.stage === 'technicals') {
                                    progressDetails.textContent += ' â€¢ Calculating indicators...';
                                } else if (data.stage === 'ai') {
                                    progressDetails.textContent += ' â€¢ FLUX analyzes...';
                                }
                            }
                        } else if (data.type === 'stock_complete') {
                        // Include all stocks - even without scores (allows retry)
                        // Stocks with null/undefined scores will be shown with "N/A" for retry
                        
                        // Check if stock already exists (avoid duplicates)
                        const existingIndex = allStocks.findIndex(s => s.symbol === data.stock.symbol);
                        if (existingIndex >= 0) {
                            // Update existing stock
                            allStocks[existingIndex] = data.stock;
                            const filterIndex = allStocksForFilter.findIndex(s => s.symbol === data.stock.symbol);
                            if (filterIndex >= 0) {
                                allStocksForFilter[filterIndex] = data.stock;
                            } else {
                                allStocksForFilter.push(data.stock);
                            }
                        } else {
                            // Add new stock
                            allStocks.push(data.stock);
                            allStocksForFilter.push(data.stock);
                        }
                        
                        // Hide scanning state immediately when first stock arrives (transparent AI)
                        const scanningState = document.getElementById('scanning-state');
                        const emptyState = document.getElementById('empty-state');
                        if (scanningState && allStocks.length > 0) {
                            scanningState.classList.add('hidden');
                        }
                        if (emptyState) {
                            emptyState.classList.add('hidden');
                        }
                        
                        // Show filter controls if we have stocks
                        const filterControls = document.getElementById('filter-sort-controls');
                        if (filterControls && allStocks.length > 0) {
                            filterControls.classList.remove('hidden');
                        }
                        
                        // Apply current filter and sort, then update display IMMEDIATELY (no delay)
                        applyFilterAndSort(true); // Pass true to skip fade animation for streaming
                        
                        // Update progress with null checks
                        if (progressBar) progressBar.style.width = `${data.percentage}%`;
                        if (progressPercentage) progressPercentage.textContent = `${data.percentage}%`;
                        if (progressMessage) progressMessage.textContent = `Analyzing... ${data.current}/${data.total} complete`;
                        
                        // Update count to show how many cards are actually displayed
                        const sliderTrack = document.getElementById('slider-track');
                        const visibleCards = sliderTrack ? sliderTrack.querySelectorAll('[data-symbol]').length : 0;
                        if (progressDetails) progressDetails.textContent = `Latest: ${data.stock.symbol} â€¢ ${visibleCards} card${visibleCards !== 1 ? 's' : ''} shown`;
                        
                        // Show progress container if hidden
                        // Ensure progress is visible
                        if (headerNormal) headerNormal.classList.add('hidden');
                        if (headerProgress) headerProgress.classList.remove('hidden');
                        if (headerSubtitle) headerSubtitle.classList.add('hidden');
                        if (progressBarContainer) progressBarContainer.classList.remove('hidden');
                        if (progressPercentageContainer) progressPercentageContainer.classList.remove('hidden');
                        
                        // Update radar status to show streaming
                        updateRadarStatus('scanning', `Analyzing ${data.current}/${data.total}... ${visibleCards} card${visibleCards !== 1 ? 's' : ''} shown`);
                    } else if (data.type === 'complete') {
                        console.log('[WS] Complete message received:', {
                            stocksReceived: data.stocks?.length || 0,
                            currentStocks: allStocks.length,
                            expected: data.expected,
                            total: data.total
                        });
                        
                        // Merge stocks from complete message with already received stocks
                        // Include all stocks - even without scores (allows retry)
                        const completeStocks = data.stocks || [];
                        
                        // Create a map of existing stocks by symbol to avoid duplicates
                        const existingStocksMap = new Map();
                        allStocks.forEach(stock => {
                            existingStocksMap.set(stock.symbol, stock);
                        });
                        
                        // Add/update stocks from complete message
                        completeStocks.forEach(stock => {
                            existingStocksMap.set(stock.symbol, stock);
                        });
                        
                        // Update arrays with merged data
                        allStocks = Array.from(existingStocksMap.values());
                        allStocksForFilter = [...allStocks];
                        
                        // Show filter/sort controls
                        const filterControls = document.getElementById('filter-sort-controls');
                        if (filterControls && allStocks.length > 0) {
                            filterControls.classList.remove('hidden');
                        }
                        
                        // Reset pagination when new stocks arrive
                        currentPage = 1;
                        showAllMode = false;
                        const toggle = document.getElementById('show-all-toggle');
                        if (toggle) toggle.checked = false;
                        
                        // Intelligent refresh detection - compare with previous results
                        const hasChanges = compareStocks(previousStocks, allStocks);
                        
                        if (!hasChanges && previousStocks && previousStocks.length > 0) {
                            // No new signals detected
                            const appState = getAlpineState();
                            if (appState?.showToast) {
                                appState.showToast('FLUX found no new signals', 'info', 4000);
                            }
                        } else if (hasChanges && previousStocks && previousStocks.length > 0) {
                            // New signals found
                            const newCount = allStocks.length - previousStocks.length;
                            if (newCount > 0) {
                                const appState = getAlpineState();
                                if (appState?.showToast) {
                                    appState.showToast(`FLUX found ${newCount} new signal${newCount !== 1 ? 's' : ''}`, 'success', 4000);
                                }
                            } else {
                                const appState = getAlpineState();
                                if (appState?.showToast) {
                                    appState.showToast('FLUX found updated signals', 'success', 4000);
                                }
                            }
                        } else if (!previousStocks || previousStocks.length === 0) {
                            // First scan
                            if (allStocks.length > 0) {
                                const appState = getAlpineState();
                                if (appState?.showToast) {
                                    appState.showToast(`FLUX found ${allStocks.length} signal${allStocks.length !== 1 ? 's' : ''}`, 'success', 4000);
                                }
                            }
                        }
                        
                        // Scan results are saved to MongoDB via backend - no localStorage needed
                        
                        // Check for warnings
                        const hasWarnings = data.warnings && data.warnings.length > 0;
                        const isPartial = data.expected && data.total < data.expected;
                        
                        // Hide scanning state
                        const scanningState = document.getElementById('scanning-state');
                        const emptyState = document.getElementById('empty-state');
                        if (scanningState) scanningState.classList.add('hidden');
                        
                        // Apply filter and sort, then display (ONLY ONCE)
                        applyFilterAndSort();
                        
                        // Wait a bit for applyFilterAndSort to update displayedStocks
                        setTimeout(() => {
                            if (displayedStocks.length > 0) {
                                const signalText = displayedStocks.length === 1 ? 'signal' : 'signals';
                                updateRadarStatus('complete', `FLUX found ${displayedStocks.length} ${signalText}`);
                            } else {
                                if (emptyState) {
                                    emptyState.classList.remove('hidden');
                                    // Reload preview when empty state is shown
                                    const appState = getAlpineState();
                                    if (appState?.loadAnalysisPreview) {
                                        appState.loadAnalysisPreview();
                                    }
                                }
                                updateRadarStatus('complete', 'FLUX found nothing');
                            }
                        }, 200);
                        
                        // Update progress
                        progressBar.style.width = '100%';
                        progressPercentage.textContent = '100%';
                        
                        // Update progress message after a delay to ensure displayedStocks is updated
                        setTimeout(() => {
                            const displayCount = displayedStocks.length || allStocks.length;
                            if (hasWarnings || isPartial) {
                                progressMessage.textContent = `FLUX analysis complete! Scanned ${data.total} stocks, showing ${displayCount}`;
                                if (progressDetails) progressDetails.textContent = hasWarnings ? data.warnings[0] : 'Some stocks may have limited data';
                                if (progressBar) progressBar.style.background = 'linear-gradient(to right, #f59e0b, #d97706)';
                                
                                // Show warning banner
                                showWarningBanner(hasWarnings ? data.warnings.join(' ') : 'Some stocks have limited analysis data');
                            } else {
                                progressMessage.textContent = `FLUX analysis complete! Scanned ${data.total} stocks, showing ${displayCount}`;
                                if (progressDetails) progressDetails.textContent = '';
                            }
                        }, 250);
                        
                        // Hide progress after a moment
                        setTimeout(() => {
                            // Hide progress, show normal header
                            if (headerNormal) headerNormal.classList.remove('hidden');
                            if (headerProgress) headerProgress.classList.add('hidden');
                            if (headerSubtitle) headerSubtitle.classList.remove('hidden');
                            if (progressBarContainer) progressBarContainer.classList.add('hidden');
                            if (progressPercentageContainer) progressPercentageContainer.classList.add('hidden');
                        }, hasWarnings || isPartial ? 4000 : 2000);
                        
                        // Update button state
                        updateScanButtonState(false);
                        
                        // Update Alpine.js state
                        const appState = getAlpineState();
                        if (appState) {
                            appState.stocks.isScanning = false;
                            appState.canAnalyze = true;
                        }
                        
                        // Always show "Find More Signals" button
                        const findMoreContainer = document.getElementById('find-more-container');
                        findMoreContainer.classList.remove('hidden');
                        
                        // Restore "Find More Signals" button if it was disabled
                        const findMoreBtn = document.querySelector('#find-more-container button');
                        if (findMoreBtn) {
                            findMoreBtn.disabled = false;
                            findMoreBtn.innerHTML = '<i data-lucide="refresh-cw" class="w-4 h-4"></i><span>Scan Again</span>';
                            lucide.createIcons();
                            findMoreBtn.disabled = false;
                        }
                    } else if (data.type === 'error') {
                        const isRateLimit = data.is_rate_limit || data.error_type === 'rate_limit';
                        if (progressMessage) {
                            progressMessage.textContent = isRateLimit 
                                ? `âš ï¸ FLUX is rate-limited - using cached data` 
                                : `FLUX encountered an error: ${data.message}`;
                        }
                        if (progressDetails) {
                            progressDetails.textContent = isRateLimit 
                                ? 'Some news analysis may be limited. Retrying...' 
                                : `Failed: ${data.symbol || 'Unknown'}`;
                        }
                        
                        if (isRateLimit) {
                            if (progressBar) progressBar.style.background = 'linear-gradient(to right, #f59e0b, #d97706)';
                            const appState = getAlpineState();
                            if (appState?.showToast) {
                                appState.showToast('Rate limit reached - using cached data', 'warning', 4000);
                            }
                        } else {
                            if (progressBar) progressBar.style.background = 'linear-gradient(to right, #ef4444, #dc2626)';
                            const appState = getAlpineState();
                            if (appState?.showToast) {
                                appState.showToast(`Error: ${data.message || 'Unknown error'}`, 'error', 4000);
                            }
                        }
                        
                        // Update status
                        updateRadarStatus('idle');
                        updateScanButtonState(false);
                        
                        // Update Alpine.js state
                        const appState = getAlpineState();
                        if (appState) {
                            appState.stocks.isScanning = false;
                            appState.canAnalyze = true;
                        }
                    }
                    } catch (err) {
                        console.error('Error parsing WebSocket message:', err);
                    }
                };
                
                wsConnection.onerror = (error) => {
                    console.error('[WS] WebSocket error:', error);
                    if (wsTimeout) {
                        clearTimeout(wsTimeout);
                        wsTimeout = null;
                    }
                    handleConnectionFailure();
                };
                
                wsConnection.onclose = (event) => {
                    if (wsTimeout) {
                        clearTimeout(wsTimeout);
                        wsTimeout = null;
                    }
                    
                    // Only handle as error if not a normal closure and we don't have results
                    if (event.code !== 1000 && allStocks.length === 0 && !backgroundRefresh) {
                        // Abnormal closure - attempt retry
                        if (wsRetryCount < 3) {
                            wsRetryCount++;
                            setTimeout(() => {
                                loadTrendingStocksWithProgress(backgroundRefresh);
                            }, 1000 * wsRetryCount); // Exponential backoff
                            return;
                        } else {
                            handleConnectionFailure();
                            return;
                        }
                    }
                    
                    updateScanButtonState(false);
                    updateRadarStatus('idle');
                    
                    // Update Alpine.js state
                    const appState = getAlpineState();
                    if (appState) {
                        appState.stocks.isScanning = false;
                        appState.canAnalyze = true;
                    }
                };
            }, 100); // End of setTimeout for WebSocket creation
        }
        // Ensure function is globally accessible
        window.loadTrendingStocksWithProgress = loadTrendingStocksWithProgress;
        
        function handleConnectionFailure() {
                console.error('[WS] Connection failure - falling back to HTTP');
                if (progressMessage) progressMessage.textContent = 'FLUX cannot connect - falling back to standard mode...';
                if (progressDetails) progressDetails.textContent = 'Using cached data if available';
                if (progressBar) progressBar.style.background = 'linear-gradient(to right, #f59e0b, #d97706)';
                updateScanButtonState(false);
                updateRadarStatus('idle');
                const appState = getAlpineState();
                if (appState) {
                    appState.stocks.isScanning = false;
                    appState.canAnalyze = true;
                    if (appState.showToast) {
                        appState.showToast('Connection failed - using cached data', 'warning', 5000);
                    }
                }
                
                // Fallback to regular fetch
                setTimeout(() => {
                    loadTrendingStocksFallback();
                }, 1000);
        }
        
        async function loadTrendingStocksFallback() {
            // Fallback to regular HTTP fetch if WebSocket fails
            const slider = document.getElementById('trending-stocks-slider');
            // Use merged header progress elements
            const headerNormal = document.getElementById('header-normal');
            const headerProgress = document.getElementById('header-progress');
            const headerSubtitle = document.getElementById('header-subtitle');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const progressPercentageContainer = document.getElementById('progress-percentage-container');
            
            try {
                // Show loading state only if slider is empty
                if (!slider.innerHTML.trim() || slider.innerHTML.includes('Discovering')) {
                    slider.innerHTML = '<div class="text-center py-8 text-gray-400 min-w-full flex items-center justify-center"><div><i data-lucide="loader-2" class="lucide-spin text-2xl mb-2 w-8 h-8"></i><p class="text-sm">Loading stocks...</p></div></div>';
                    lucide.createIcons();
                }
                
                const response = await fetch('/api/auto-setup');
                const data = await response.json();
                
                if (data.success && data.stocks && data.stocks.length > 0) {
                    // Check if we got fewer stocks than expected
                    if (data.expected && data.stocks.length < data.expected) {
                        showWarningBanner(`Only ${data.stocks.length} of ${data.expected} stocks loaded. Some may have limited data.`);
                    }
                    
                    showWhatsNew(data.stocks);
                    // Hide progress, show normal header
                    if (headerNormal) headerNormal.classList.remove('hidden');
                    if (headerProgress) headerProgress.classList.add('hidden');
                    if (headerSubtitle) headerSubtitle.classList.remove('hidden');
                    if (progressBarContainer) progressBarContainer.classList.add('hidden');
                    if (progressPercentageContainer) progressPercentageContainer.classList.add('hidden');
                } else {
                    // Try to use cache if available
                    // Try to load latest scan from MongoDB
                    const scanData = await loadLatestScan();
                    if (scanData && scanData.stocks && scanData.stocks.length > 0) {
                        showWarningBanner('Using latest scan from database - fresh analysis unavailable');
                        showWhatsNew(scanData.stocks);
                        // Hide progress, show normal header
                        if (headerNormal) headerNormal.classList.remove('hidden');
                        if (headerProgress) headerProgress.classList.add('hidden');
                        if (headerSubtitle) headerSubtitle.classList.remove('hidden');
                        if (progressBarContainer) progressBarContainer.classList.add('hidden');
                        if (progressPercentageContainer) progressPercentageContainer.classList.add('hidden');
                    } else {
                        throw new Error('No stocks available');
                    }
                }
            } catch (err) {
                console.error('Error loading trending stocks:', err);
                
                // Try cache as last resort
                // Try to load latest scan from MongoDB
                const scanData = await loadLatestScan();
                if (scanData && scanData.stocks && scanData.stocks.length > 0) {
                    showWarningBanner('Using latest scan from database - connection error occurred');
                    showWhatsNew(scanData.stocks);
                    progressContainer.classList.add('hidden');
                } else {
                    slider.innerHTML = '<div class="text-center py-8 text-red-400 min-w-full flex items-center justify-center"><div><i data-lucide="alert-circle" class="text-2xl mb-2 w-8 h-8"></i><p class="text-sm mb-2">Failed to load stocks</p><p class="text-xs text-gray-500">Please check your connection and try refreshing</p><button onclick="refreshTrendingStocks()" class="mt-3 badge badge-info cursor-pointer">Retry</button></div></div>';
                    lucide.createIcons();
                }
            }
        }
        
        // Also allow manual refresh of trending stocks
        async function refreshTrendingStocks(useCache = true) {
            // Check for cache if useCache is true
            if (useCache) {
                const cacheKey = 'eye_stocks';
                const cached = localStorage.getItem(cacheKey);
                
                if (cached) {
                    try {
                        const cachedData = JSON.parse(cached);
                        const cacheTime = new Date(cachedData.timestamp);
                        const now = new Date();
                        
                        console.log(`[CACHE] Using cache from`, cacheTime.toLocaleTimeString());
                        updateCacheIndicator(cacheTime);
                        showWhatsNew(cachedData.stocks, { isStale: false, cacheAge: now - cacheTime });
                        return;
                    } catch (e) {
                        console.warn('[CACHE] Failed to parse cache:', e);
                    }
                }
            }
            
            // Store previous stocks for comparison
            previousStocks = allStocks.map(s => ({ 
                symbol: s.symbol, 
                score: s.ai_score || 0 
            }));
            
            // Manual scan triggered by user - bypass cache
            
            // Don't clear cache - we'll compare results
            // Reset state
            allStocks = [];
            displayedStocks = [];
            currentPage = 0;
            isLoadingMore = false;
            
            // Hide empty state initially
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.classList.add('hidden');
            
            // Hide cache indicator when refreshing
            const cacheIndicator = document.getElementById('cache-indicator');
            if (cacheIndicator) cacheIndicator.classList.add('hidden');
            
            // Close existing WebSocket if open
            if (wsConnection) {
                wsConnection.close();
                wsConnection = null;
            }
            
            loadTrendingStocksWithProgress(false);
        }
        // Ensure function is globally accessible
        window.refreshTrendingStocks = refreshTrendingStocks;
        
        // Update cache indicator
        function updateCacheIndicator(cacheTime) {
            const cacheIndicator = document.getElementById('cache-indicator');
            const cacheTimeEl = document.getElementById('cache-time');
            
            if (cacheIndicator && cacheTimeEl) {
                const now = new Date();
                const age = now - cacheTime;
                const hours = Math.floor(age / (1000 * 60 * 60));
                const minutes = Math.floor((age % (1000 * 60 * 60)) / (1000 * 60));
                
                if (hours > 0) {
                    cacheTimeEl.textContent = `${hours}h ago`;
                } else if (minutes > 0) {
                    cacheTimeEl.textContent = `${minutes}m ago`;
                } else {
                    cacheTimeEl.textContent = 'Just now';
                }
                
                cacheIndicator.classList.remove('hidden');
            }
        }
        
        async function showWhatsNew(stocks, options = {}) {
            const { isStale = false, cacheAge = 0 } = options;
            const section = document.getElementById('radar-section');
            const slider = document.getElementById('trending-stocks-slider');
            const progressContainer = document.getElementById('progress-container');
            const scanningState = document.getElementById('scanning-state');
            const emptyState = document.getElementById('empty-state');
            const findMoreContainer = document.getElementById('find-more-container');
            
            // Show the section
            section.classList.remove('hidden');
            progressContainer.classList.add('hidden');
            if (scanningState) scanningState.classList.add('hidden');
            
            // Update status
            updateRadarStatus('idle');
            updateScanButtonState(false);
            
            // Scan completed
            
            // Include all stocks - even without scores (allows retry)
            // Sort: stocks with scores first (highest to lowest), then stocks without scores
            const filteredStocks = stocks.sort((a, b) => {
                const scoreA = a.ai_score ?? -1; // Use -1 for null/undefined to sort them last
                const scoreB = b.ai_score ?? -1;
                if (scoreA === -1 && scoreB === -1) return 0; // Both without scores - keep order
                if (scoreA === -1) return 1; // a without score goes last
                if (scoreB === -1) return -1; // b without score goes last
                return scoreB - scoreA; // Highest score first
            });
            
            // Store all stocks
            allStocks = filteredStocks;
            allStocksForFilter = [...filteredStocks];
            
            // Reset pagination when loading new stocks
            currentPage = 1;
            showAllMode = false;
            const toggle = document.getElementById('show-all-toggle');
            if (toggle) toggle.checked = false;
            
            // Show filter/sort controls if we have stocks
            const filterControlsEl = document.getElementById('filter-sort-controls');
            if (filterControlsEl && filteredStocks.length > 0) {
                filterControlsEl.classList.remove('hidden');
            }
            
            // Always show "Find More Signals" button to allow scanning more symbols
            findMoreContainer.classList.remove('hidden');
            
            // Scan results are now saved to MongoDB via backend - no localStorage needed
            
            // Show stale indicator if needed
            if (isStale && cacheAge > 0) {
                const ageMinutes = Math.floor(cacheAge / 60000);
                const appState = getAlpineState();
                if (appState?.showToast) {
                    appState.showToast(`Showing cached data from ${ageMinutes} minute${ageMinutes !== 1 ? 's' : ''} ago`, 'warning', 5000);
                }
            }
            
            // Check for 0/10 stocks (short opportunities)
            const zeroScoreStocks = filteredStocks.filter(s => s.ai_score === 0);
            if (zeroScoreStocks.length > 0) {
                showShortOpportunityBanner(zeroScoreStocks);
            } else {
                // Hide banner if no 0/10 stocks
                const shortBanner = document.getElementById('short-opportunity-banner');
                if (shortBanner) shortBanner.classList.add('hidden');
            }
            
            // Apply filter and sort, then display
            applyFilterAndSort();
            
            if (displayedStocks.length > 0) {
                const signalText = displayedStocks.length === 1 ? 'signal' : 'signals';
                updateRadarStatus('complete', `FLUX found ${displayedStocks.length} ${signalText}`);
            }
        }
        
        function showShortOpportunityBanner(zeroScoreStocks) {
            const banner = document.getElementById('short-opportunity-banner');
            const messageEl = document.getElementById('short-opportunity-message');
            const symbolsEl = document.getElementById('short-opportunity-symbols');
            
            if (!banner || !messageEl || !symbolsEl) return;
            
            const count = zeroScoreStocks.length;
            const symbols = zeroScoreStocks.map(s => s.symbol).join(', ');
            
            messageEl.textContent = `${count} stock${count !== 1 ? 's' : ''} showed up in our scan but got 0/10 for BUY.`;
            symbolsEl.textContent = symbols;
            
            banner.classList.remove('hidden');
        }
        
        // Grid layout - no scroll handlers needed (shows top 5 in grid)
        
        async function findMoreSignals(event) {
            // Full market scan - trigger fresh analysis of all stocks
            
            // Show loading state
            const findMoreBtn = event?.target?.closest('button') || document.querySelector('#find-more-container button');
            if (findMoreBtn) {
                const originalText = findMoreBtn.innerHTML;
                findMoreBtn.disabled = true;
                findMoreBtn.innerHTML = '<i data-lucide="loader-2" class="lucide-spin w-4 h-4"></i> Scanning Markets...';
                lucide.createIcons();
                
                // Close existing WebSocket if open
                if (wsConnection) {
                    wsConnection.close();
                    wsConnection = null;
                }
                
                // Clear current results to show fresh scan
                const sliderTrack = document.getElementById('slider-track');
                if (sliderTrack) {
                    sliderTrack.innerHTML = '';
                }
                
                // Show progress indicator
                // Show progress in header
                const headerNormal = document.getElementById('header-normal');
                const headerProgress = document.getElementById('header-progress');
                const headerSubtitle = document.getElementById('header-subtitle');
                const progressBarContainer = document.getElementById('progress-bar-container');
                const progressPercentageContainer = document.getElementById('progress-percentage-container');
                if (headerNormal) headerNormal.classList.add('hidden');
                if (headerProgress) headerProgress.classList.remove('hidden');
                if (headerSubtitle) headerSubtitle.classList.add('hidden');
                if (progressBarContainer) progressBarContainer.classList.remove('hidden');
                if (progressPercentageContainer) progressPercentageContainer.classList.remove('hidden');
                
                // Trigger full scan (real-time analysis, not cached)
                refreshTrendingStocks();
                
                // Button will be restored when scan completes (handled in complete handler)
            } else {
                refreshTrendingStocks();
            }
        }
        
        function showWarningBanner(message) {
            const banner = document.getElementById('warning-banner');
            const messageEl = document.getElementById('warning-message');
            if (banner && messageEl) {
                messageEl.textContent = message;
                banner.style.opacity = '0';
                banner.classList.remove('hidden');
                
                // Fade in
                setTimeout(() => {
                    banner.style.transition = 'opacity 0.3s ease';
                    banner.style.opacity = '1';
                }, 10);
                
                // Auto-hide after 10 seconds with fade out
                setTimeout(() => {
                    banner.style.opacity = '0';
                    setTimeout(() => {
                        banner.classList.add('hidden');
                    }, 300);
                }, 10000);
            }
        }
        
        /**
         * Create Stock Card (Client-Side)
         * 
         * Generates HTML for a stock card from stock data.
         * Note: Server-side stock_card() template helper exists but not yet integrated with WebSocket flow.
         * 
         * @param {Object} stockData - Stock data object
         * @returns {HTMLElement} Stock card DOM element
         */
        function createStockCard(stockData) {
            const symbol = stockData.symbol || stockData;
            const price = stockData.price;
            const rsi = stockData.rsi;
            const atr = stockData.atr || 0;
            const trend = stockData.trend;
            const sma = stockData.sma || 0;
            const aiScore = stockData.ai_score;
            const aiReason = stockData.ai_reason;
            const riskLevel = stockData.risk_level;
            const hasLimitedData = stockData.has_limited_data || (price && !aiScore && !rsi);
            const cacheHit = stockData.cache_hit || false;
            const similarSignals = stockData.similar_signals || [];
            const confidenceBoost = stockData.confidence_boost || 0.0;
            const winRate = stockData.win_rate || 0.0;
            const similarCount = stockData.similar_count || 0;
            const meetsCriteria = stockData.meets_criteria !== undefined ? stockData.meets_criteria : false;
            
            // Calculate profit potential and risk metrics
            const stopLoss = price && atr > 0 ? price - (2 * atr) : null;
            const takeProfit = price && atr > 0 ? price + (3 * atr) : null;
            const profitPotential = takeProfit && price ? takeProfit - price : null;
            const profitPotentialPct = profitPotential && price ? ((profitPotential / price) * 100) : null;
            const riskAmount = stopLoss && price ? price - stopLoss : null;
            
            let scoreColor = "text-gray-400";
            let scoreBadge = "badge-info";
            let scoreBg = "bg-gray-500/20";
            let scoreBorder = "border-gray-500/30";
            let scoreIcon = "fa-question-circle";
            let scoreGlow = "";
            let trendColor = "text-gray-400";
            let trendIcon = "fa-minus";
            let trendBg = "bg-gray-500/10";
            let rsiStatus = "Neutral";
            let rsiColor = "text-gray-400";
            let rsiIcon = "equal";
            let rsiBg = "bg-gray-500/10";
            // Use AI reason for description if available, otherwise generate from score
            let description = "Trending stock - check analysis";
            let overallSignal = "neutral";
            
            // Improved AI Score Color Coding - Clear, Intuitive Gradients
            if (aiScore !== null && aiScore !== undefined) {
                // Score-based color (primary indicator)
                if (aiScore >= 9) {
                    // Excellent (9-10): Bright green
                    scoreColor = "text-emerald-400";
                    scoreBadge = "badge-success";
                    scoreBg = "bg-emerald-500/25";
                    scoreBorder = "border-emerald-500/50";
                    scoreIcon = "fa-star";
                    scoreGlow = "shadow-lg shadow-emerald-500/30";
                    description = aiReason && aiReason.trim() ? aiReason : "Excellent Low Buy - Strong Bounce Signals";
                    overallSignal = "excellent";
                } else if (aiScore >= 8) {
                    // Strong (8): Green
                    scoreColor = "text-green-400";
                    scoreBadge = "badge-success";
                    scoreBg = "bg-green-500/20";
                    scoreBorder = "border-green-500/40";
                    scoreIcon = "check-circle-2";
                    scoreGlow = meetsCriteria ? "shadow-md shadow-green-500/20" : "";
                    description = aiReason && aiReason.trim() ? aiReason : (meetsCriteria ? "Low Buy Opportunity - Signals Suggest Bounce" : "Strong Score - Monitor Entry");
                    overallSignal = "strong";
                } else if (aiScore >= 7) {
                    // Good (7): Yellow-green
                    scoreColor = "text-lime-400";
                    scoreBadge = "badge-info";
                    scoreBg = "bg-lime-500/15";
                    scoreBorder = "border-lime-500/30";
                    scoreIcon = "fa-check";
                    description = aiReason && aiReason.trim() ? aiReason : "Good Opportunity - Review Details";
                    overallSignal = "good";
                } else if (aiScore >= 5) {
                    // Moderate (5-6): Yellow
                    scoreColor = "text-yellow-400";
                    scoreBadge = "badge-warning";
                    scoreBg = "bg-yellow-500/15";
                    scoreBorder = "border-yellow-500/30";
                    scoreIcon = "alert-triangle";
                    description = aiReason && aiReason.trim() ? aiReason : "Moderate Signal - Proceed with Caution";
                    overallSignal = "moderate";
                } else if (aiScore >= 3) {
                    // Weak (3-4): Orange
                    scoreColor = "text-orange-400";
                    scoreBadge = "badge-warning";
                    scoreBg = "bg-orange-500/15";
                    scoreBorder = "border-orange-500/30";
                    scoreIcon = "alert-circle";
                    description = aiReason && aiReason.trim() ? aiReason : "Weak Signal - High Risk";
                    overallSignal = "weak";
                } else if (aiScore === 0) {
                    // Zero score: AI explicitly recommends avoiding - suggest short opportunity
                    scoreColor = "text-red-500";
                    scoreBadge = "badge-danger";
                    scoreBg = "bg-red-500/20";
                    scoreBorder = "border-red-500/50";
                    scoreIcon = "trending-down";
                    description = aiReason && aiReason.trim() ? aiReason : "AI Recommends Avoiding - Consider Short Opportunity";
                    overallSignal = "avoid";
                } else {
                    // Poor (1-2): Red
                    scoreColor = "text-red-400";
                    scoreBadge = "badge-danger";
                    scoreBg = "bg-red-500/15";
                    scoreBorder = "border-red-500/30";
                    scoreIcon = "x-circle";
                    description = aiReason && aiReason.trim() ? aiReason : "Poor Signal - Not Recommended";
                    overallSignal = "poor";
                }
                
                // Add visual indicator if meets criteria (adds glow/border effect)
                if (meetsCriteria && aiScore >= 7) {
                    scoreGlow = scoreGlow || "shadow-md shadow-green-500/20";
                    scoreBorder = scoreBorder.replace(/30|40|50/, "50");
                }
            }
            
            if (trend === "UP") {
                trendColor = "text-green-400";
                trendIcon = "trending-up";
                trendBg = "bg-green-500/10";
            } else if (trend === "DOWN") {
                trendColor = "text-red-400";
                trendIcon = "trending-down";
                trendBg = "bg-red-500/10";
            }
            
            if (rsi !== null && rsi !== undefined) {
                if (rsi < 30) {
                    rsiStatus = "Oversold";
                    rsiColor = "text-green-400";
                    rsiIcon = "arrow-down";
                    rsiBg = "bg-green-500/10";
                } else if (rsi > 70) {
                    rsiStatus = "Overbought";
                    rsiColor = "text-red-400";
                    rsiIcon = "arrow-up";
                    rsiBg = "bg-red-500/10";
                } else {
                    rsiStatus = "Neutral";
                    rsiColor = "text-gray-400";
                    rsiIcon = "equal";
                    rsiBg = "bg-gray-500/10";
                }
            }
            
            const card = document.createElement('div');
            card.className = 'glass rounded-xl p-3.5 card-hover border-l-4 w-full transition-all duration-300 hover:scale-[1.02] hover:shadow-xl hover:shadow-yellow-500/10 cursor-pointer';
            card.dataset.symbol = symbol;
            card.dataset.score = aiScore || 0;
            card.dataset.rsi = rsi || 0;
            card.dataset.profitPotential = profitPotential || 0;
            card.dataset.signal = overallSignal;
            card.dataset.meetsCriteria = meetsCriteria;
            // Note: Card click handling is done via event delegation on slider-track container
            // This prevents duplicate event listeners when cards are recreated
            
            // Set border color based on overall signal - matches score color system
            if (overallSignal === "excellent") {
                card.classList.add('border-emerald-500/60', 'shadow-lg', 'shadow-emerald-500/20');
            } else if (overallSignal === "strong") {
                card.classList.add('border-green-500/50');
                if (meetsCriteria) {
                    card.classList.add('shadow-md', 'shadow-green-500/15');
                }
            } else if (overallSignal === "good") {
                card.classList.add('border-lime-500/40');
            } else if (overallSignal === "moderate") {
                card.classList.add('border-yellow-500/40');
            } else if (overallSignal === "weak") {
                card.classList.add('border-orange-500/40');
            } else if (overallSignal === "poor") {
                card.classList.add('border-red-500/40');
            } else if (overallSignal === "avoid") {
                card.classList.add('border-red-600/60', 'shadow-md', 'shadow-red-500/20');
            } else {
                card.classList.add('border-gray-500/30');
            }
            
            let analysisSection = '';
            if (price && rsi !== undefined && trend) {
                analysisSection = `
                    <div class="grid grid-cols-3 gap-2 mb-2 pt-2 border-t border-gray-700/50">
                        <div class="text-center relative">
                            <div class="flex items-center justify-center gap-1 mb-1">
                                <div class="w-8 h-8 rounded-lg ${rsiBg} flex items-center justify-center">
                                    <i data-lucide="${rsiIcon}" class="${rsiColor} text-xs w-4 h-4"></i>
                                </div>
                                <button onclick="event.stopPropagation(); openMetricModal('rsi', ${JSON.stringify(symbol)}, ${JSON.stringify(rsi)}, ${JSON.stringify(rsiStatus)})" 
                                        class="info-icon text-blue-400 hover:text-blue-300 text-xs ml-1 transition-all">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="text-sm font-bold ${rsiColor} mb-1">${rsi ? rsi.toFixed(1) : 'N/A'}</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wider">RSI</div>
                            <div class="text-xs ${rsiColor} mt-0.5">${rsiStatus}</div>
                        </div>
                        <div class="text-center relative">
                            <div class="flex items-center justify-center gap-1 mb-1">
                                <div class="w-8 h-8 rounded-lg ${trendBg} flex items-center justify-center">
                                    <i data-lucide="${trendIcon}" class="${trendColor} text-xs w-4 h-4"></i>
                                </div>
                                <button onclick="event.stopPropagation(); openMetricModal('trend', ${JSON.stringify(symbol)}, ${JSON.stringify(trend)}, 'vs SMA-200')" 
                                        class="info-icon text-blue-400 hover:text-blue-300 text-xs ml-1 transition-all">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="text-sm font-bold ${trendColor} mb-1">${trend || 'N/A'}</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wider">Trend</div>
                            <div class="text-xs text-gray-500 mt-0.5">vs SMA-200</div>
                        </div>
                        <div class="text-center relative">
                            <div class="flex items-center justify-center gap-1 mb-1">
                                <div class="w-8 h-8 rounded-lg ${scoreBg} ${scoreBorder} border-2 flex items-center justify-center ${scoreGlow} transition-all">
                                    <i data-lucide="${scoreIcon}" class="${scoreColor} text-xs w-4 h-4"></i>
                                </div>
                                <button onclick="event.stopPropagation(); openMetricModal('ai-score', ${JSON.stringify(symbol)}, ${JSON.stringify(aiScore)}, ${JSON.stringify(aiScore >= 9 ? 'Excellent' : aiScore >= 8 ? 'Strong' : aiScore >= 7 ? 'Good' : aiScore >= 5 ? 'Moderate' : aiScore >= 3 ? 'Weak' : aiScore === 0 ? 'Avoid' : aiScore !== null ? 'Poor' : 'N/A')})" 
                                        class="info-icon text-blue-400 hover:text-blue-300 text-xs ml-1 transition-all"
                                        title="${aiScore === 0 ? 'AI recommends avoiding - high risk or negative signals' : 'Learn about AI scores'}">
                                    <i data-lucide="info" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="text-base font-bold ${scoreColor} mb-1 tracking-tight">${aiScore !== null && aiScore !== undefined ? aiScore + '/10' : 'N/A'}</div>
                            <div class="text-xs text-gray-500 uppercase tracking-wider">AI Score</div>
                            <div class="text-xs font-semibold ${scoreColor} mt-0.5">${aiScore >= 9 ? 'Excellent' : aiScore >= 8 ? 'Strong' : aiScore >= 7 ? 'Good' : aiScore >= 5 ? 'Moderate' : aiScore >= 3 ? 'Weak' : aiScore === 0 ? 'Avoid' : aiScore !== null ? 'Poor' : 'Scoring Failed'}</div>
                            ${meetsCriteria && aiScore >= 7 ? '<div class="text-[10px] text-green-400 mt-0.5 font-semibold">âœ“ Meets Criteria</div>' : ''}
                            ${aiScore === 0 ? '<div class="text-[10px] text-red-400 mt-0.5 font-semibold">âš ï¸ Consider Shorting</div>' : ''}
                            ${aiScore === null || aiScore === undefined ? '<div class="text-[10px] text-yellow-400 mt-0.5 font-semibold">âš ï¸ Retry for score</div>' : ''}
                        </div>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center flex-shrink-0 border border-blue-500/30">
                            <span class="font-bold text-white text-xs">${symbol}</span>
                        </div>
                        <div class="min-w-0 flex-1">
                            <div class="flex items-start gap-1.5 mb-0.5">
                                <p class="text-sm font-semibold text-white break-words leading-tight">${description}</p>
                                ${hasLimitedData ? '<i data-lucide="alert-circle" class="text-yellow-400 text-xs flex-shrink-0 mt-0.5 w-3.5 h-3.5" title="Limited data"></i>' : ''}
                            </div>
                            ${price ? `
                                <div class="flex items-center gap-1 text-xs mt-0.5">
                                    <span class="text-gray-400">Price:</span>
                                    <span class="font-bold text-white">$${price.toFixed(2)}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                        ${aiScore !== null && aiScore !== undefined ? `
                            <button onclick="event.stopPropagation(); openMetricModal('ai-score', ${JSON.stringify(symbol)}, ${JSON.stringify(aiScore)}, ${JSON.stringify(aiScore >= 9 ? 'Excellent' : aiScore >= 8 ? 'Strong' : aiScore >= 7 ? 'Good' : aiScore >= 5 ? 'Moderate' : aiScore >= 3 ? 'Weak' : aiScore === 0 ? 'Avoid' : 'Poor')})" 
                                    class="badge ${scoreBadge} ${scoreBg} ${scoreBorder} border-2 ${scoreGlow} transition-all hover:scale-105 cursor-pointer" 
                                    title="${aiScore === 0 ? 'AI analyzed and recommends avoiding this stock - high risk or negative signals detected' : ''}">
                                <span class="text-sm font-bold ${scoreColor}">${aiScore}</span><span class="text-xs ${scoreColor} opacity-75">/10</span>
                                ${confidenceBoost !== 0 ? `<span class="text-xs ml-1.5 font-semibold ${confidenceBoost > 0 ? 'text-green-400' : 'text-red-400'}">${confidenceBoost > 0 ? '+' : ''}${confidenceBoost.toFixed(1)}</span>` : ''}
                                ${aiScore === 0 ? '<i data-lucide="alert-triangle" class="text-red-400 text-xs w-3 h-3 ml-1"></i>' : ''}
                            </button>
                        ` : `
                            <div class="badge badge-info bg-yellow-500/20 border-yellow-500/50 border-2" title="Analysis available but scoring failed - click scan again to retry">
                                <i data-lucide="refresh-cw" class="text-yellow-400 text-xs w-3 h-3"></i>
                                <span class="text-xs text-yellow-400 ml-1 font-semibold">Retry</span>
                            </div>
                        `}
                        ${cacheHit ? `
                            <div class="badge badge-info" title="Cached analysis (fresh)">
                                <i data-lucide="database" class="text-xs w-3 h-3"></i>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ${analysisSection}
                
                ${aiReason && aiReason.trim() && aiReason !== description ? `
                    <div class="mt-2 pt-2 border-t border-gray-700/50">
                        <div class="glass rounded-lg p-2.5 bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-500/30">
                            <div class="flex items-start gap-2">
                                <div class="flex-shrink-0 mt-0.5">
                                    <i data-lucide="target" class="text-purple-400 text-sm w-4 h-4"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="text-[10px] text-purple-400 font-semibold uppercase tracking-wider mb-1">Insight</div>
                                    <p class="text-xs text-white leading-tight break-words font-medium">${aiReason}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${profitPotential !== null ? `
                    <div class="mt-2 pt-2 border-t border-gray-700/50">
                        <div class="glass rounded-lg p-2 bg-green-500/10 border border-green-500/30 transition-all duration-300 hover:bg-green-500/20 hover:border-green-500/50 hover:scale-105 cursor-pointer group">
                            <div class="text-[10px] text-gray-300 mb-0.5 font-medium flex items-center gap-1">
                                <i data-lucide="trending-up" class="text-green-400 group-hover:animate-bounce w-3 h-3"></i>
                                Profit Potential
                            </div>
                            <div class="text-base font-bold text-green-400 profit-highlight number-transition">+$${profitPotential.toFixed(2)}</div>
                            <div class="text-[10px] text-green-400 mt-0.5 font-semibold">+${profitPotentialPct.toFixed(1)}%</div>
                        </div>
                        ${stopLoss && takeProfit ? `
                            <div class="text-[10px] text-gray-400 mt-1.5 pt-1.5 border-t border-gray-700/30 space-y-0.5">
                                <div class="flex justify-between items-center">
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="shield" class="text-red-400 w-3 h-3"></i>
                                        Stop:
                                    </span>
                                    <span class="text-red-400 font-semibold text-xs">$${stopLoss.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="target" class="text-green-400 w-3 h-3"></i>
                                        Target:
                                    </span>
                                    <span class="text-green-400 font-semibold text-xs">$${takeProfit.toFixed(2)}</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                ${atr > 0 ? `
                    <div class="mt-1.5 pt-1.5 border-t border-gray-700/30">
                        <div class="flex items-center justify-between text-[10px]">
                            <span class="text-gray-400 flex items-center gap-1">
                                <i data-lucide="waves" class="text-purple-400 w-3 h-3"></i>
                                ATR:
                            </span>
                            <span class="text-white font-semibold">$${atr.toFixed(2)}</span>
                        </div>
                    </div>
                ` : ''}
                
                ${similarSignals.length > 0 || confidenceBoost !== 0 ? `
                    <div class="mt-2 pt-2 border-t border-gray-700/50">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-1.5 text-[10px] text-gray-400">
                                <i data-lucide="history" class="w-3 h-3"></i>
                                <span>History</span>
                            </div>
                            ${confidenceBoost !== 0 ? `
                                <div class="badge ${confidenceBoost > 0 ? 'badge-success' : 'badge-danger'} text-xs">
                                    ${confidenceBoost > 0 ? '+' : ''}${confidenceBoost.toFixed(2)} confidence boost
                                </div>
                            ` : ''}
                        </div>
                        ${similarSignals.length > 0 ? `
                            <div class="text-[10px] text-gray-500 mb-1">
                                ${similarCount} similar (${(winRate * 100).toFixed(0)}% win)
                            </div>
                            <div class="flex gap-1 flex-wrap">
                                ${similarSignals.slice(0, 5).map(s => `
                                    <div class="badge ${s.profitable === true ? 'badge-success' : s.profitable === false ? 'badge-danger' : 'badge-info'} text-[10px] px-1.5 py-0.5">
                                        ${s.profitable === true ? 'âœ“' : s.profitable === false ? 'âœ—' : '?'} ${s.score || 'N/A'}
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-[10px] text-gray-500">No similar signals</div>'}
                    </div>
                ` : ''}
                
                <!-- External Links Section -->
                <div class="mt-2 pt-2 border-t border-gray-700/30">
                    <div class="flex items-center justify-center gap-2 flex-wrap">
                        <a href="https://finance.yahoo.com/quote/${symbol}" target="_blank" rel="noopener noreferrer" 
                           onclick="event.stopPropagation()"
                           class="text-[10px] text-blue-400 hover:text-blue-300 transition flex items-center gap-0.5 hover:scale-110"
                           title="Yahoo Finance">
                            <i class="fab fa-yahoo text-xs"></i>
                            <span>Yahoo</span>
                        </a>
                        <span class="text-gray-600 text-[10px]">â€¢</span>
                        <a href="https://www.tradingview.com/symbols/${symbol}/" target="_blank" rel="noopener noreferrer"
                           onclick="event.stopPropagation()"
                           class="text-[10px] text-purple-400 hover:text-purple-300 transition flex items-center gap-0.5 hover:scale-110"
                           title="TradingView">
                            <i data-lucide="bar-chart-3" class="text-xs w-3 h-3"></i>
                            <span>Charts</span>
                        </a>
                        <span class="text-gray-600 text-[10px]">â€¢</span>
                        <a href="https://www.google.com/finance/quote/${symbol}" target="_blank" rel="noopener noreferrer"
                           onclick="event.stopPropagation()"
                           class="text-[10px] text-yellow-400 hover:text-yellow-300 transition flex items-center gap-0.5 hover:scale-110"
                           title="Google Finance">
                            <i class="fab fa-google text-xs"></i>
                            <span>Google</span>
                        </a>
                    </div>
                </div>
                <!-- Action Buttons Section - Only show Buy/Explain if analyzed -->
                ${aiScore !== null && aiScore !== undefined ? `
                    <div class="mt-2.5 pt-2.5 border-t border-gray-700/50">
                        <div class="flex gap-1.5">
                            ${aiScore >= 7 ? `
                                <!-- Buy button - only show for good scores -->
                                <button 
                                    onclick="event.stopPropagation(); openBuyModal('${symbol}')"
                                    class="flex-1 glass-strong py-2 rounded-lg text-xs font-bold text-white hover:bg-green-600/30 transition-all bg-green-500/30 flex items-center justify-center gap-1 border border-green-500/50">
                                    <i data-lucide="arrow-up" class="text-xs w-3.5 h-3.5"></i>
                                    <span>BUY</span>
                                </button>
                            ` : ''}
                            <!-- Explain button - show when analyzed -->
                            <button 
                                onclick="event.stopPropagation(); showExplanation('${symbol}', event)"
                                class="glass-strong py-2 px-2 rounded-lg text-xs font-semibold text-white hover:bg-purple-600/30 transition-all bg-purple-500/20 flex items-center justify-center border border-purple-500/30"
                                title="Explain analysis">
                                <i data-lucide="info" class="text-xs w-3.5 h-3.5"></i>
                            </button>
                        </div>
                        ${aiScore === 0 ? `
                            <div class="mt-2 text-xs text-red-400 italic text-center">
                                AI recommends avoiding - see explanation for details
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
            `;
            return card;
        }
        
        /**
         * Update Pagination Controls
         * 
         * Generates pagination buttons and updates their state.
         * Note: Server-side pagination_controls() helper exists but not yet integrated.
         * 
         * @param {number} totalItems - Total number of items to paginate
         */
        function updatePagination(totalItems) {
            const totalPages = Math.max(1, Math.ceil(totalItems / STOCKS_PER_PAGE));
            const paginationControls = document.getElementById('pagination-controls');
            const pageNumbersContainer = document.getElementById('page-numbers');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            if (!paginationControls) return;
            
            // Show pagination if we have more than STOCKS_PER_PAGE items and not in show-all mode
            if (totalItems > STOCKS_PER_PAGE && !showAllMode) {
                paginationControls.classList.remove('hidden');
            } else {
                paginationControls.classList.add('hidden');
            }
            
            // Generate page number buttons (show max 5 pages around current)
            if (pageNumbersContainer && totalPages > 1 && !showAllMode) {
                pageNumbersContainer.innerHTML = '';
                const maxVisible = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
                let endPage = Math.min(totalPages, startPage + maxVisible - 1);
                
                // Adjust if we're near the end
                if (endPage - startPage < maxVisible - 1) {
                    startPage = Math.max(1, endPage - maxVisible + 1);
                }
                
                // First page
                if (startPage > 1) {
                    const btn = createPageButton(1, 1 === currentPage);
                    pageNumbersContainer.appendChild(btn);
                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'text-gray-500 px-1';
                        ellipsis.textContent = '...';
                        pageNumbersContainer.appendChild(ellipsis);
                    }
                }
                
                // Page range
                for (let i = startPage; i <= endPage; i++) {
                    const btn = createPageButton(i, i === currentPage);
                    pageNumbersContainer.appendChild(btn);
                }
                
                // Last page
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'text-gray-500 px-1';
                        ellipsis.textContent = '...';
                        pageNumbersContainer.appendChild(ellipsis);
                    }
                    const btn = createPageButton(totalPages, totalPages === currentPage);
                    pageNumbersContainer.appendChild(btn);
                }
            } else if (pageNumbersContainer) {
                pageNumbersContainer.innerHTML = '';
            }
            
            // Update button states
            if (prevBtn) {
                prevBtn.disabled = currentPage === 1 || showAllMode;
            }
            if (nextBtn) {
                nextBtn.disabled = currentPage >= totalPages || showAllMode;
            }
        }
        
        /**
         * Create Page Button
         * 
         * Helper function to create a pagination button element.
         * 
         * @param {number} pageNum - Page number
         * @param {boolean} isActive - Whether this is the current page
         * @returns {HTMLElement} Button element
         */
        function createPageButton(pageNum, isActive) {
            const btn = document.createElement('button');
            btn.textContent = pageNum;
            btn.onclick = () => {
                if (pageNum !== currentPage) {
                    currentPage = pageNum;
                    applyFilterAndSort();
                    const slider = document.getElementById('trending-stocks-slider');
                    if (slider) {
                        slider.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            };
            btn.className = isActive
                ? 'glass-strong px-3 py-1.5 rounded-lg text-sm font-bold text-yellow-400 bg-yellow-500/20 border border-yellow-500/50 hover:bg-yellow-500/30 transition-all'
                : 'glass-strong px-3 py-1.5 rounded-lg text-sm text-white bg-gray-700/50 border border-gray-600/50 hover:border-yellow-500/50 hover:bg-yellow-500/10 transition-all';
            return btn;
        }
        
        /**
         * Change Page
         * 
         * Navigates to a different page in pagination.
         * 
         * @param {number} delta - Page change delta (+1 for next, -1 for previous)
         */
        function changePage(delta) {
            if (showAllMode) return;
            
            const totalPages = Math.max(1, Math.ceil(filteredStocks.length / STOCKS_PER_PAGE));
            const newPage = Math.max(1, Math.min(totalPages, currentPage + delta));
            
            if (newPage !== currentPage) {
                currentPage = newPage;
                applyFilterAndSort();
                
                // Smooth scroll to top of stock cards
                const slider = document.getElementById('trending-stocks-slider');
                if (slider) {
                    slider.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }
        
        /**
         * Toggle Show All Mode
         * 
         * Toggles between paginated view and show-all view.
         */
        function toggleShowAll() {
            const toggle = document.getElementById('show-all-toggle');
            if (!toggle) return;
            
            showAllMode = toggle.checked;
            currentPage = 1; // Reset to first page when toggling
            
            applyFilterAndSort();
            
            // Smooth scroll to top
            const slider = document.getElementById('trending-stocks-slider');
            if (slider) {
                slider.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        /**
         * Apply Filter and Sort
         * 
         * Applies current filter and sort settings to stock list,
         * updates pagination, and renders the filtered results.
         * 
         * @param {boolean} streaming - If true, skip fade animations for immediate rendering
         */
        function applyFilterAndSort(streaming = false) {
            const filterSelect = document.getElementById('filter-select');
            const sortSelect = document.getElementById('sort-select');
            const slider = document.getElementById('trending-stocks-slider');
            const stockCount = document.getElementById('stock-count');
            const emptyState = document.getElementById('empty-state');
            const scanningState = document.getElementById('scanning-state');
            
            if (!filterSelect || !sortSelect || !slider) return;
            
            // Add filtering class for transition
            slider.classList.add('filtering');
            
            let filtered = [...allStocksForFilter];
            
            // Apply filter
            const filterValue = filterSelect.value;
            if (filterValue === 'strong') {
                filtered = filtered.filter(s => (s.ai_score || 0) >= 8 && s.meets_criteria);
            } else if (filterValue === 'moderate') {
                filtered = filtered.filter(s => (s.ai_score || 0) >= 5 && (s.ai_score || 0) < 8);
            } else if (filterValue === 'oversold') {
                filtered = filtered.filter(s => (s.rsi || 50) < 35);
            } else if (filterValue === 'meets_criteria') {
                filtered = filtered.filter(s => s.meets_criteria === true);
            }
            
            // Apply sort
            const sortValue = sortSelect.value;
            filtered.sort((a, b) => {
                if (sortValue === 'score_desc') {
                    return (b.ai_score || 0) - (a.ai_score || 0);
                } else if (sortValue === 'score_asc') {
                    return (a.ai_score || 0) - (b.ai_score || 0);
                } else if (sortValue === 'profit_desc') {
                    const profitA = a.price && a.atr ? (a.price + (3 * a.atr)) - a.price : 0;
                    const profitB = b.price && b.atr ? (b.price + (3 * b.atr)) - b.price : 0;
                    return profitB - profitA;
                } else if (sortValue === 'profit_asc') {
                    const profitA = a.price && a.atr ? (a.price + (3 * a.atr)) - a.price : 0;
                    const profitB = b.price && b.atr ? (b.price + (3 * b.atr)) - b.price : 0;
                    return profitA - profitB;
                } else if (sortValue === 'rsi_asc') {
                    return (a.rsi || 50) - (b.rsi || 50);
                } else if (sortValue === 'rsi_desc') {
                    return (b.rsi || 50) - (a.rsi || 50);
                }
                return 0;
            });
            
            // Store filtered stocks for pagination
            filteredStocks = filtered;
            
            // Update pagination
            updatePagination(filtered.length);
            
            // Streaming mode: show ALL stocks as they arrive (no pagination limit)
            if (streaming) {
                // In streaming mode, show all filtered stocks immediately
                displayedStocks = filtered;
                
                // Update count immediately
                if (stockCount) {
                    stockCount.innerHTML = `<span>${filtered.length} stock${filtered.length !== 1 ? 's' : ''}</span>`;
                }
                
                const sliderTrack = document.getElementById('slider-track');
                if (!sliderTrack) return;
                
                // Get existing cards to avoid duplicates
                const existingSymbols = new Set();
                sliderTrack.querySelectorAll('[data-symbol]').forEach(card => {
                    existingSymbols.add(card.getAttribute('data-symbol'));
                });
                
                // Add new stocks immediately
                displayedStocks.forEach((stock) => {
                    if (!existingSymbols.has(stock.symbol)) {
                        const card = createStockCard(stock);
                        card.classList.add('stock-card-slider', 'card-slide-in');
                        card.setAttribute('data-symbol', stock.symbol);
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(10px)';
                        sliderTrack.appendChild(card);
                        // Refresh icons immediately
                        lucide.createIcons();
                        requestAnimationFrame(() => {
                            card.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        });
                    }
                });
                
                slider.classList.remove('filtering');
                return;
            }
            
            // Non-streaming mode: use pagination
            if (showAllMode) {
                displayedStocks = filtered;
            } else {
                const startIndex = (currentPage - 1) * STOCKS_PER_PAGE;
                const endIndex = startIndex + STOCKS_PER_PAGE;
                displayedStocks = filtered.slice(startIndex, endIndex);
            }
            
            // Update count
            if (stockCount) {
                const showing = showAllMode ? filtered.length : displayedStocks.length;
                const total = filtered.length;
                stockCount.innerHTML = `<span>${showing}${showAllMode ? '' : ` of ${total}`} stock${total !== 1 ? 's' : ''}</span>`;
            }
            
            // Rebuild cards with animation (non-streaming mode)
            setTimeout(() => {
                // Fade out existing cards
                const existingCards = slider.querySelectorAll('.stock-card');
                existingCards.forEach((card, idx) => {
                    card.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out';
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(-10px) scale(0.98)';
                });
                
                // Clear and rebuild after fade
                setTimeout(() => {
                    const sliderTrack = document.getElementById('slider-track');
                    if (!sliderTrack) return;
                    
                    if (displayedStocks.length > 0) {
                        sliderTrack.innerHTML = '';
                    }
                    
                    if (scanningState) scanningState.classList.add('hidden');
                    
                    if (displayedStocks.length === 0) {
                        if (emptyState) {
                            emptyState.classList.remove('hidden');
                            // Reload preview when empty state is shown
                            const appState = getAlpineState();
                            if (appState?.loadAnalysisPreview) {
                                appState.loadAnalysisPreview();
                            }
                        }
                        slider.classList.remove('filtering');
                        const paginationControls = document.getElementById('pagination-controls');
                        if (paginationControls) paginationControls.classList.add('hidden');
                        return;
                    }
                    
                    // Hide empty state if we have stocks
                    if (emptyState) emptyState.classList.add('hidden');
                    
                    // Add new cards with slide-in animation
                    displayedStocks.forEach((stock, index) => {
                        const card = createStockCard(stock);
                        card.classList.add('stock-card-slider', 'card-slide-in');
                        card.setAttribute('data-symbol', stock.symbol);
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(30px) scale(0.95)';
                        sliderTrack.appendChild(card);
                        // Process HTMX attributes on dynamically created elements
                        // Must be called after element is in DOM
                        if (typeof htmx !== 'undefined') {
                            try {
                                htmx.process(card);
                                // Verify buttons have HTMX attributes
                                const buyBtn = card.querySelector('button[hx-post="/api/quick-buy"]');
                                if (buyBtn) {
                                }
                            } catch (e) {
                                console.error(`[HTMX] Error processing card for ${stock.symbol}:`, e);
                            }
                        }
            // Tooltips now use pure CSS - no JS initialization needed
                        
                        // Stagger animation with spring effect
                        setTimeout(() => {
                            card.style.transition = 'opacity 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
                            card.style.opacity = '1';
                            card.style.transform = 'translateX(0) scale(1)';
                        }, index * 80);
                    });
                    
                    // Update slider navigation visibility
                    updateSliderNavigation();
                    
                    slider.classList.remove('filtering');
                    
                }, existingCards.length > 0 ? 200 : 0);
            }, 50);
        }
        
        // Setup filter/sort event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const filterSelect = document.getElementById('filter-select');
            const sortSelect = document.getElementById('sort-select');
            
            if (filterSelect) {
                filterSelect.addEventListener('change', () => {
                    currentPage = 1; // Reset to first page on filter change
                    applyFilterAndSort();
                });
            }
            if (sortSelect) {
                sortSelect.addEventListener('change', () => {
                    currentPage = 1; // Reset to first page on sort change
                    applyFilterAndSort();
                });
            }
            
            // Watchlist cards now use pure HTMX - no JavaScript setup needed
        });
        
        
        // Slider navigation functions
        function updateSliderNavigation() {
            const slider = document.getElementById('trending-stocks-slider');
            const prevBtn = document.getElementById('slider-prev');
            const nextBtn = document.getElementById('slider-next');
            
            if (!slider || !prevBtn || !nextBtn) return;
            
            // Show/hide arrows based on scroll position
            const updateArrows = () => {
                const canScrollLeft = slider.scrollLeft > 0;
                const canScrollRight = slider.scrollLeft < (slider.scrollWidth - slider.clientWidth - 10);
                
                if (canScrollLeft || canScrollRight) {
                    prevBtn.classList.remove('opacity-0', 'pointer-events-none');
                    nextBtn.classList.remove('opacity-0', 'pointer-events-none');
                    prevBtn.style.opacity = canScrollLeft ? '1' : '0.3';
                    nextBtn.style.opacity = canScrollRight ? '1' : '0.3';
                } else {
                    prevBtn.classList.add('opacity-0', 'pointer-events-none');
                    nextBtn.classList.add('opacity-0', 'pointer-events-none');
                }
            };
            
            updateArrows();
            slider.addEventListener('scroll', updateArrows);
        }
        
        // Slider navigation button handlers
        document.addEventListener('DOMContentLoaded', () => {
            const slider = document.getElementById('trending-stocks-slider');
            const prevBtn = document.getElementById('slider-prev');
            const nextBtn = document.getElementById('slider-next');
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (slider) {
                        const cardWidth = 380; // Match min-width of stock-card-slider
                        const gap = 16; // gap-4 = 16px
                        slider.scrollBy({ left: -(cardWidth + gap), behavior: 'smooth' });
                    }
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (slider) {
                        const cardWidth = 380; // Match min-width of stock-card-slider
                        const gap = 16; // gap-4 = 16px
                        slider.scrollBy({ left: cardWidth + gap, behavior: 'smooth' });
                    }
                });
            }
            
            // Show arrows on hover
            const sliderContainer = slider?.parentElement;
            if (sliderContainer) {
                sliderContainer.addEventListener('mouseenter', () => {
                    if (prevBtn) prevBtn.classList.remove('opacity-0', 'pointer-events-none');
                    if (nextBtn) nextBtn.classList.remove('opacity-0', 'pointer-events-none');
                });
            }
        });
        
        // Load latest scan from MongoDB on first load
        async function checkFirstLoad() {
            // Fetch latest scan from MongoDB
            const scanData = await loadLatestScan();
            if (scanData && scanData.stocks && scanData.stocks.length > 0) {
                console.log(`[MongoDB] Loading latest scan on first load`);
                if (scanData.timestamp) {
                    const scanTime = new Date(scanData.timestamp);
                    updateCacheIndicator(scanTime);
                }
                // Load stocks after a short delay to ensure DOM is ready
                setTimeout(() => {
                    if (typeof showWhatsNew === 'function') {
                        const cacheAge = scanData.timestamp ? Date.now() - new Date(scanData.timestamp).getTime() : 0;
                        showWhatsNew(scanData.stocks, { isStale: false, cacheAge: cacheAge });
                    }
                }, 500);
            }
        }
        
        // RADAR section is always visible - no close function needed
        
        
        // Buy modal functions
        /**
         * Add a ticker to watch list
         */
        async function addTicker() {
            const input = document.getElementById('add-ticker-input');
            if (!input) {
                console.error('Add ticker input not found');
                return;
            }
            
            const symbol = input.value.trim().toUpperCase();
            if (!symbol) {
                showWatchListToast('Please enter a symbol', 'error');
                return;
            }
            
            // Validate symbol format
            if (!/^[A-Z]{1,5}$/.test(symbol)) {
                showWatchListToast('Invalid symbol format (1-5 letters)', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/watch-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add', symbol })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear input
                    input.value = '';
                    
                    // Reload watchlist content (will trigger preview reload via HTMX)
                    const watchlistContent = document.getElementById('watchlist-content');
                    if (watchlistContent) {
                        htmx.trigger(watchlistContent, 'load');
                    }
                    
                    // Auto-refresh radar/eye section with new symbol
                    if (typeof loadTrendingStocksWithProgress === 'function') {
                        // Get updated symbols list
                        const updatedSymbols = data.symbols_list || [];
                        if (updatedSymbols.length > 0) {
                            // Trigger refresh with updated symbols (limit to 5 for performance)
                            loadTrendingStocksWithProgress(false, updatedSymbols.slice(0, 5));
                        }
                    }
                    
                    showWatchListToast(`${symbol} added to watch list`, 'success');
                } else {
                    showWatchListToast(data.error || 'Failed to add ticker', 'error');
                }
            } catch (error) {
                console.error('Error adding ticker:', error);
                showWatchListToast('Error adding ticker', 'error');
            }
        }
        
        /**
         * Remove a ticker from watch list
         */
        async function removeTicker(symbol) {
            if (!symbol) {
                console.error('Symbol is required');
                return;
            }
            
            if (!confirm(`Remove ${symbol} from watch list?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/watch-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'remove', symbol })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reload watchlist content (will trigger preview reload via HTMX)
                    const watchlistContent = document.getElementById('watchlist-content');
                    if (watchlistContent) {
                        htmx.trigger(watchlistContent, 'load');
                    }
                    
                    // Auto-refresh radar/eye section with updated symbols
                    if (typeof loadTrendingStocksWithProgress === 'function') {
                        // Get updated symbols list
                        const updatedSymbols = data.symbols_list || [];
                        if (updatedSymbols.length > 0) {
                            // Trigger refresh with updated symbols (limit to 5 for performance)
                            loadTrendingStocksWithProgress(false, updatedSymbols.slice(0, 5));
                        } else {
                            // If watchlist is empty, clear the radar section
                            const slider = document.getElementById('trending-stocks-slider');
                            if (slider) {
                                slider.innerHTML = '<div class="text-center py-8 text-gray-400"><p class="text-sm">Watch list is empty</p><p class="text-xs mt-2">Add symbols to see analysis</p></div>';
                            }
                        }
                    }
                    
                    showWatchListToast(`${symbol} removed from watch list`, 'success');
                } else {
                    showWatchListToast(data.error || 'Failed to remove ticker', 'error');
                }
            } catch (error) {
                console.error('Error removing ticker:', error);
                showWatchListToast('Error removing ticker', 'error');
            }
        }
        
        // Removed setupWatchlistCardClicks and handleWatchlistCardClick - now using pure HTMX
        
        /**
         * Save watch list (bulk update - comma-separated)
         */
        async function saveWatchListBulk() {
            const input = document.getElementById('watch-list-input');
            if (!input) {
                console.error('Watch list input not found');
                return;
            }
            
            const symbols = input.value.trim();
            if (!symbols) {
                showWatchListToast('Please enter at least one symbol', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/watch-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'bulk', symbols })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reload watch list section to show updated value
                    const watchListSection = document.getElementById('watch-list-section');
                    if (watchListSection) {
                        htmx.trigger(watchListSection, 'load');
                    }
                    
                    showWatchListToast('Watch list saved successfully!', 'success');
                    
                    // Reload analysis preview if available
                    if (window.app && typeof window.app.loadAnalysisPreview === 'function') {
                        window.app.loadAnalysisPreview();
                    }
                } else {
                    showWatchListToast(data.error || 'Failed to save watch list', 'error');
                }
            } catch (error) {
                console.error('Error saving watch list:', error);
                showWatchListToast('Error saving watch list', 'error');
            }
        }
        
        
        /**
         * Add ticker from preview section
         */
        async function addTickerFromPreview() {
            const input = document.getElementById('preview-add-ticker-input');
            if (!input) {
                console.error('Preview add ticker input not found');
                return;
            }
            
            const symbol = input.value.trim().toUpperCase();
            if (!symbol) {
                showWatchListToast('Please enter a symbol', 'error');
                return;
            }
            
            // Validate symbol format
            if (!/^[A-Z]{1,5}$/.test(symbol)) {
                showWatchListToast('Invalid symbol format (1-5 letters)', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/watch-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add', symbol })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Clear input
                    input.value = '';
                    const dropdown = document.getElementById('preview-ticker-dropdown');
                    if (dropdown) {
                        dropdown.classList.add('hidden');
                    }
                    
                    // Reload watchlist content (will trigger preview reload via HTMX)
                    const watchlistContent = document.getElementById('watchlist-content');
                    if (watchlistContent) {
                        htmx.trigger(watchlistContent, 'load');
                    }
                    
                    // Auto-refresh radar/eye section with new symbol
                    if (typeof loadTrendingStocksWithProgress === 'function') {
                        // Get updated symbols list
                        const updatedSymbols = data.symbols_list || [];
                        if (updatedSymbols.length > 0) {
                            // Trigger refresh with updated symbols (limit to 5 for performance)
                            loadTrendingStocksWithProgress(false, updatedSymbols.slice(0, 5));
                        }
                    }
                    
                    showWatchListToast(`${symbol} added to watch list`, 'success');
                } else {
                    showWatchListToast(data.error || 'Failed to add ticker', 'error');
                }
            } catch (error) {
                console.error('Error adding ticker from preview:', error);
                showWatchListToast('Error adding ticker', 'error');
            }
        }
        
        /**
         * Remove ticker from preview section
         */
        async function removeTickerFromPreview(symbol) {
            if (!symbol) {
                console.error('Symbol is required');
                return;
            }
            
            if (!confirm(`Remove ${symbol} from watch list?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/watch-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'remove', symbol })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reload watchlist content (will trigger preview reload via HTMX)
                    const watchlistContent = document.getElementById('watchlist-content');
                    if (watchlistContent) {
                        htmx.trigger(watchlistContent, 'load');
                    }
                    
                    // Auto-refresh radar/eye section with updated symbols
                    if (typeof loadTrendingStocksWithProgress === 'function') {
                        // Get updated symbols list
                        const updatedSymbols = data.symbols_list || [];
                        if (updatedSymbols.length > 0) {
                            // Trigger refresh with updated symbols (limit to 5 for performance)
                            loadTrendingStocksWithProgress(false, updatedSymbols.slice(0, 5));
                        } else {
                            // If watchlist is empty, clear the radar section
                            const slider = document.getElementById('trending-stocks-slider');
                            if (slider) {
                                slider.innerHTML = '<div class="text-center py-8 text-gray-400"><p class="text-sm">Watch list is empty</p><p class="text-xs mt-2">Add symbols to see analysis</p></div>';
                            }
                        }
                    }
                    
                    showWatchListToast(`${symbol} removed from watch list`, 'success');
                } else {
                    showWatchListToast(data.error || 'Failed to remove ticker', 'error');
                }
            } catch (error) {
                console.error('Error removing ticker from preview:', error);
                showWatchListToast('Error removing ticker', 'error');
            }
        }
        
        /**
         * Show toast notification for watch list operations
         */
        function showWatchListToast(message, type = 'info') {
            if (window.app && typeof window.app.showToast === 'function') {
                window.app.showToast(message, type, 3000);
            } else {
                const appState = getAlpineState();
                if (appState?.showToast) {
                    appState.showToast(message, type, 3000);
                } else {
                    alert(message);
                }
            }
        }
        
        function openBuyModal(symbol) {
            // Set symbol in modal
            document.getElementById('buy-modal-symbol').textContent = `Buy ${symbol}`;
            document.getElementById('buy-order-symbol').value = symbol;
            document.getElementById('buy-summary-symbol').textContent = symbol;
            
            // Reset slider to default
            const slider = document.getElementById('buy-qty-slider');
            if (slider) {
                slider.value = 10;
                updateBuyQtyDisplay(10);
            }
            
            // Open modal via Alpine.js
            if (typeof Alpine !== 'undefined') {
                const appState = Alpine.$data(document.body);
                if (appState && appState.openModal) {
                    appState.openModal('buy-order');
                    return;
                }
            }
            // Fallback: direct modal show
            const modal = document.getElementById('buy-order-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
        }

        function openMetricModal(metricType, symbol, value, status) {
            const modal = document.getElementById('metric-info-modal');
            if (!modal) {
                console.error('Metric modal not found');
                return;
            }
            
            const titleEl = document.getElementById('metric-title');
            const iconEl = document.getElementById('metric-icon');
            const contentEl = document.getElementById('metric-content');
            const modalContent = modal.querySelector('.modal-content');
            
            // Show modal
            if (modalContent) {
                modalContent.classList.remove('slide-out-3d');
                modalContent.classList.add('slide-in-3d');
            }
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            let title = '';
            let icon = 'trending-up';
            let content = '';
            
            if (metricType === 'rsi') {
                title = 'RSI (Relative Strength Index)';
                icon = 'waves';
                const rsiValue = parseFloat(value);
                const isOversold = rsiValue < 30;
                const isOverbought = rsiValue > 70;
                const isNeutral = !isOversold && !isOverbought;
                
                content = `
                    <div class="space-y-4">
                        <div class="glass rounded-lg p-4 border border-blue-500/30 bg-blue-500/10">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-bold text-white">Current Value</h3>
                                <div class="text-2xl font-bold ${isOversold ? 'text-green-400' : isOverbought ? 'text-red-400' : 'text-gray-400'}">${rsiValue.toFixed(1)}</div>
                            </div>
                            <div class="text-sm text-gray-300">Status: <span class="font-semibold ${isOversold ? 'text-green-400' : isOverbought ? 'text-red-400' : 'text-gray-400'}">${status}</span></div>
                        </div>
                        
                        <div class="glass rounded-lg p-4 border border-purple-500/30">
                            <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                                <i data-lucide="lightbulb" class="text-yellow-400 w-5 h-5"></i>
                                What is RSI?
                            </h3>
                            <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                The Relative Strength Index (RSI) measures how "on sale" a stock is. Think of it like shopping - when something is on sale, you might want to buy it!
                            </p>
                            <div class="space-y-2">
                                <div class="flex items-start gap-2 p-2 rounded bg-green-500/10 border border-green-500/30">
                                    <i data-lucide="check-circle-2" class="text-green-400 mt-0.5 w-4 h-4"></i>
                                    <div>
                                        <div class="text-sm font-semibold text-green-400">RSI &lt; 30 (Oversold)</div>
                                        <div class="text-xs text-gray-400">Stock is "on sale" - good low buy opportunity!</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-2 p-2 rounded bg-gray-500/10 border border-gray-500/30">
                                    <i data-lucide="equal" class="text-gray-400 mt-0.5 w-4 h-4"></i>
                                    <div>
                                        <div class="text-sm font-semibold text-gray-400">RSI 30-70 (Neutral)</div>
                                        <div class="text-xs text-gray-400">Stock is at fair price - not a great deal, but not overpriced</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-2 p-2 rounded bg-red-500/10 border border-red-500/30">
                                    <i data-lucide="alert-triangle" class="text-red-400 mt-0.5 w-4 h-4"></i>
                                    <div>
                                        <div class="text-sm font-semibold text-red-400">RSI &gt; 70 (Overbought)</div>
                                        <div class="text-xs text-gray-400">Stock may be overpriced - probably not a good time to buy</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-lg p-4 border border-yellow-500/30">
                            <h3 class="text-lg font-bold text-white mb-2">ðŸ’¡ Our Strategy</h3>
                            <p class="text-gray-300 text-sm">
                                We look for stocks with <strong class="text-green-400">RSI &lt; 35</strong> combined with an <strong class="text-green-400">uptrend</strong> and <strong class="text-green-400">strong AI score</strong>. This combination suggests the stock is at a low price with bounce-back potential!
                            </p>
                        </div>
                    </div>
                `;
            } else if (metricType === 'trend') {
                title = 'Price Trend vs 200-Day Average';
                icon = 'trending-up';
                const isUp = value === 'UP';
                const isDown = value === 'DOWN';
                
                content = `
                    <div class="space-y-4">
                        <div class="glass rounded-lg p-4 border border-blue-500/30 bg-blue-500/10">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-bold text-white">Current Trend</h3>
                                <div class="text-2xl font-bold ${isUp ? 'text-green-400' : isDown ? 'text-red-400' : 'text-gray-400'}">${value}</div>
                            </div>
                            <div class="text-sm text-gray-300">${status}</div>
                        </div>
                        
                        <div class="glass rounded-lg p-4 border border-purple-500/30">
                            <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                                <i data-lucide="lightbulb" class="text-yellow-400 w-5 h-5"></i>
                                What Does This Mean?
                            </h3>
                            <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                This compares the current stock price to its 200-day moving average. Think of it like comparing today's weather to the average weather over the past year.
                            </p>
                            <div class="space-y-2">
                                <div class="flex items-start gap-2 p-2 rounded bg-green-500/10 border border-green-500/30">
                                    <i data-lucide="trending-up" class="text-green-400 mt-0.5 w-4 h-4"></i>
                                    <div>
                                        <div class="text-sm font-semibold text-green-400">UP Trend</div>
                                        <div class="text-xs text-gray-400">Price is above 200-day average - stock is generally rising. This is good! âœ…</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-2 p-2 rounded bg-red-500/10 border border-red-500/30">
                                    <i data-lucide="trending-down" class="text-red-400 mt-0.5 w-4 h-4"></i>
                                    <div>
                                        <div class="text-sm font-semibold text-red-400">DOWN Trend</div>
                                        <div class="text-xs text-gray-400">Price is below 200-day average - stock is generally falling. We avoid these! âŒ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-lg p-4 border border-yellow-500/30">
                            <h3 class="text-lg font-bold text-white mb-2">ðŸ’¡ Our Strategy</h3>
                            <p class="text-gray-300 text-sm">
                                We <strong class="text-green-400">only buy stocks in uptrends</strong>. It's like buying a house in a neighborhood that's getting better, not worse. This increases our chances of success!
                            </p>
                        </div>
                    </div>
                `;
            } else if (metricType === 'ai-score') {
                title = 'AI Score - Bounce-back Confidence';
                icon = 'fa-brain';
                const score = parseFloat(value);
                const scoreLabel = status;
                
                content = `
                    <div class="space-y-4">
                        <div class="glass rounded-lg p-4 border border-blue-500/30 bg-blue-500/10">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-bold text-white">Current Score</h3>
                                <div class="text-3xl font-bold ${score >= 8 ? 'text-green-400' : score >= 7 ? 'text-lime-400' : score >= 5 ? 'text-yellow-400' : 'text-red-400'}">${score}/10</div>
                            </div>
                            <div class="text-sm text-gray-300">Rating: <span class="font-semibold ${score >= 8 ? 'text-green-400' : score >= 7 ? 'text-lime-400' : score >= 5 ? 'text-yellow-400' : 'text-red-400'}">${scoreLabel}</span></div>
                        </div>
                        
                        <div class="glass rounded-lg p-4 border border-purple-500/30">
                            <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                                <i data-lucide="lightbulb" class="text-yellow-400 w-5 h-5"></i>
                                What is the AI Score?
                            </h3>
                            <p class="text-gray-300 text-sm leading-relaxed mb-3">
                                FLUX analyzes news, technical indicators, and market sentiment to assess bounce-back potential. It's like having an expert trader review everything and give you a confidence score!
                            </p>
                            <div class="space-y-2">
                                <div class="flex items-start gap-2 p-2 rounded bg-green-500/10 border border-green-500/30">
                                    <div class="text-sm font-semibold text-green-400">9-10: Excellent</div>
                                    <div class="text-xs text-gray-400 ml-auto">Perfect opportunity! ðŸŽ¯</div>
                                </div>
                                <div class="flex items-start gap-2 p-2 rounded bg-green-500/10 border border-green-500/30">
                                    <div class="text-sm font-semibold text-green-400">8: Strong</div>
                                    <div class="text-xs text-gray-400 ml-auto">Very good opportunity! âœ…</div>
                                </div>
                                <div class="flex items-start gap-2 p-2 rounded bg-lime-500/10 border border-lime-500/30">
                                    <div class="text-sm font-semibold text-lime-400">7: Good</div>
                                    <div class="text-xs text-gray-400 ml-auto">Worth considering ðŸ‘</div>
                                </div>
                                <div class="flex items-start gap-2 p-2 rounded bg-yellow-500/10 border border-yellow-500/30">
                                    <div class="text-sm font-semibold text-yellow-400">5-6: Moderate</div>
                                    <div class="text-xs text-gray-400 ml-auto">Mixed signals âš ï¸</div>
                                </div>
                                <div class="flex items-start gap-2 p-2 rounded bg-red-500/10 border border-red-500/30">
                                    <div class="text-sm font-semibold text-red-400">0-4: Weak/Poor</div>
                                    <div class="text-xs text-gray-400 ml-auto">Not recommended âŒ</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="glass rounded-lg p-4 border border-yellow-500/30">
                            <h3 class="text-lg font-bold text-white mb-2">ðŸ’¡ How It Works</h3>
                            <p class="text-gray-300 text-sm mb-2">
                                The AI analyzes:
                            </p>
                            <ul class="text-gray-300 text-sm space-y-1 list-disc list-inside">
                                <li>Recent news sentiment (positive/negative)</li>
                                <li>Technical indicators (RSI, trend, volatility)</li>
                                <li>Historical patterns and similar signals</li>
                                <li>Market conditions and context</li>
                            </ul>
                            <p class="text-gray-300 text-sm mt-3">
                                <strong class="text-green-400">Score â‰¥ 7</strong> combined with <strong class="text-green-400">RSI &lt; 35</strong> and <strong class="text-green-400">uptrend</strong> = Low Buy Opportunity! ðŸŽ¯
                            </p>
                        </div>
                    </div>
                `;
            }
            
            titleEl.textContent = title;
            iconEl.className = `fas ${icon} text-blue-400`;
            contentEl.innerHTML = content;
        }

        function closeMetricModal() {
            const modal = document.getElementById('metric-info-modal');
            if (!modal) return;
            
            const modalContent = modal.querySelector('.modal-content');
            
            // Animate out
            if (modalContent) {
                modalContent.classList.remove('slide-in-3d');
                modalContent.classList.add('slide-out-3d');
            }
            
            // Hide modal after animation
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
            
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                if (modalContent) {
                    modalContent.classList.remove('slide-out-3d');
                    modalContent.classList.add('slide-in-3d');
                }
            }, 300);
        }

        function updateBuyQtyDisplay(value) {
            const qty = parseInt(value) || 10;
            const qtyDisplay = document.getElementById('buy-qty-display');
            const summaryQty = document.getElementById('buy-summary-qty');
            if (qtyDisplay) qtyDisplay.textContent = qty;
            if (summaryQty) summaryQty.textContent = qty;
        }

        // Handle buy form submission with HTMX
        document.addEventListener('DOMContentLoaded', () => {
            const buyForm = document.getElementById('buy-order-form');
            if (buyForm) {
                buyForm.addEventListener('htmx:afterRequest', function(event) {
                    if (event.detail.successful) {
                        // Close modal on success
                        closeModal('buy-order-modal');
                        // Refresh positions list (handled by hx-swap-oob in response)
                    }
                });
            }
            
            // Initialize slider display update
            const slider = document.getElementById('buy-qty-slider');
            if (slider) {
                slider.addEventListener('input', function() {
                    updateBuyQtyDisplay(this.value);
                });
            }
            
            // Tooltips now use pure CSS hover - no JS needed
        });

        // setupRejectionCardListeners and handleRejectionCardClick removed - watchlist cards now use HTMX directly
        
        // Helper function to open Alpine.js modals from global scope
        function openAlpineModal(modalId) {
            const appState = getAlpineState();
            if (appState) {
                if (typeof appState.openModal === 'function') {
                    appState.openModal(modalId);
                    return true;
                } else if (appState.modals) {
                    appState.modals[modalId] = true;
                    return true;
                }
            }
            return false;
        }
        
        // openAnalysisModal removed - modals now handled by HTMX directly

        // showExplanation - opens modal and loads content via htmx
        function showExplanation(symbol, event) {
            if (event) {
                event.stopPropagation();
            }
            const modal = document.getElementById('explanation-modal');
            const content = document.getElementById('explanation-content');
            const symbolTitle = document.getElementById('explanation-symbol');
            
            // Update title
            symbolTitle.textContent = `Detailed Explanation: ${symbol}`;
            
            // Show modal with loading state
            openAlpineModal('explanation');
            content.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i data-lucide="loader-2" class="text-2xl mb-2 w-8 h-8 lucide-spin"></i>
                    <p class="text-sm">Loading explanation...</p>
                </div>
            `;
            
            // Use htmx to load content
            if (typeof htmx !== 'undefined') {
                htmx.ajax('POST', '/api/explanation', {
                    target: '#explanation-content',
                    swap: 'innerHTML',
                    values: {symbol: symbol}
                }).then(() => {
                    // Refresh Lucide icons after content loads
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }).catch(err => {
                    console.error('HTMX request failed:', err);
                    content.innerHTML = `
                        <div class="glass rounded-lg p-4 border border-red-500/30">
                            <div class="flex items-center gap-2 text-red-400 mb-2">
                                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                <span class="font-semibold">Error</span>
                            </div>
                            <p class="text-sm text-gray-300">Failed to load explanation. Please try again.</p>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                });
            } else {
                // Fallback to fetch
                const formData = new FormData();
                formData.append('symbol', symbol);
                fetch('/api/explanation', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.text())
                .then(html => {
                    content.innerHTML = html;
                    // Refresh Lucide icons after content loads
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                })
                .catch(err => {
                    console.error('Fetch failed:', err);
                    content.innerHTML = `
                        <div class="glass rounded-lg p-4 border border-red-500/30">
                            <div class="flex items-center gap-2 text-red-400 mb-2">
                                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                <span class="font-semibold">Error</span>
                            </div>
                            <p class="text-sm text-gray-300">Failed to load explanation: ${err.message}</p>
                        </div>
                    `;
                });
            }
        }

        // All rejection modal functions removed - now handled by HTMX modal system in watchlist_card.html
        
        // Make updateFirecrawlQuery available globally for onclick handlers
        window.updateFirecrawlQuery = function() {
            const appState = getAlpineState();
            if (appState && typeof appState.updateFirecrawlQuery === 'function') {
                appState.updateFirecrawlQuery();
            }
        };
        
        // Expose appState globally for debugging and external access
        window.getAlpineState = getAlpineState;
        
        // Global function for backward compatibility during migration
        function refreshLucideIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // Make it globally available
        window.refreshLucideIcons = refreshLucideIcons;
        
        // Rejection modal functions removed - now handled by HTMX directly
        
        // Make explanation function globally available
        window.showExplanation = showExplanation;
        
        // Watchlist cards now use pure HTMX - no JavaScript functions needed
        
        /**
         * HTMX Event Handlers - Integrated with Alpine.js
         * 
         * These handlers integrate HTMX events with Alpine.js reactive state.
         * This ensures UI updates work seamlessly between HTMX and Alpine.js.
         */
        
        /**
         * Strategy Update Handler - Re-evaluate button appears when strategy changes
         * User must manually click the re-evaluate button to refresh watchlist
         * Watchlist only refreshes on page load or button click - never automatically
         */
        
        /**
         * STAFF ENGINEER LEVEL HTMX PATTERN: Centralized Event Handling
         * 
         * Instead of inline JavaScript in hx-on attributes, we use event delegation
         * on document.body to handle all HTMX events. This is:
         * - Safer: No quote escaping issues, no inline JS parsing errors
         * - More maintainable: All HTMX logic in one place
         * - More performant: Event delegation vs individual handlers
         * - More debuggable: Centralized logging and error handling
         */
        
        /**
         * STAFF ENGINEER LEVEL HTMX PATTERN: Centralized Modal Opening Handler
         * 
         * Pattern: Event delegation on document.body for all HTMX requests
         * 
         * Benefits:
         * - Zero inline JavaScript - no quote escaping issues, no parsing errors
         * - Single source of truth - all modal logic in one place
         * - Works for dynamically added content - event delegation handles new elements
         * - Easy to debug - centralized logging
         * - Type-safe - uses data attributes, no string interpolation in JS
         * 
         * How it works:
         * 1. Any element with data-analysis-title attribute triggers this handler
         * 2. Handler reads the title from data attribute (safely escaped by template)
         * 3. Opens modal before HTMX request starts
         * 4. HTMX request continues normally
         */
        /**
         * HTMX Pattern: Just-in-Time Modal Loading Indicator
         * 
         * Shows loading indicator in modal container while fetching modal HTML.
         * The server returns the full modal HTML, which replaces this indicator.
         */
        document.body.addEventListener('htmx:beforeRequest', function(event) {
            try {
                const element = event.detail.elt;
                const target = event.detail.target;
                
                // Check if this is targeting the modal container
                if (target && target.id === 'modal-container') {
                    // Clear any existing modals and show loading indicator
                    const container = document.getElementById('modal-container');
                    if (container) {
                        // Remove any existing dialogs first
                        container.querySelectorAll('dialog.htmx-modal').forEach(d => d.remove());
                        // Insert loading dialog (will be removed when real modal arrives)
                        container.insertAdjacentHTML('beforeend', `
                            <dialog class="htmx-modal" open id="loading-modal">
                                <div class="htmx-modal-content">
                                    <div class="htmx-modal-body flex items-center justify-center py-16">
                                        <i data-lucide="loader-2" class="w-8 h-8 lucide-spin text-blue-400"></i>
                                    </div>
                                </div>
                            </dialog>
                        `);
                        // Initialize Lucide icons for loading spinner
                        setTimeout(() => {
                            if (typeof lucide !== 'undefined') {
                                lucide.createIcons();
                            }
                        }, 10);
                    }
                }
            } catch (error) {
                console.error('Error showing modal loading indicator:', error);
            }
        }, true);
        
        // Handle HTMX swap errors to prevent insertBefore errors
        // Suppress TradingView script insertion errors
        document.body.addEventListener('htmx:beforeSwap', function(event) {
            // Check if swap target contains scripts that might cause issues
            if (event.detail.target && event.detail.target.innerHTML) {
                // Allow swap to proceed but catch script errors
                try {
                    // This will be handled by the swap
                } catch (e) {
                    if (e.message && e.message.includes('insertBefore')) {
                        console.warn('Caught insertBefore error from HTMX, suppressing to prevent page break:', e);
                        event.preventDefault();
                        return false;
                    }
                }
            }
        });
        
        // Also handle afterSwap to ensure scripts run correctly
        document.body.addEventListener('htmx:afterSwap', function(event) {
            try {
                // Check if target element exists before swap
                const target = event.detail.target;
                if (!target) {
                    console.warn('HTMX swap target is null, cancelling swap', event.detail);
                    event.detail.shouldSwap = false;
                    event.preventDefault();
                    return false;
                }
                
                // Check if target is still connected to DOM
                if (!target.isConnected && typeof target.isConnected !== 'undefined') {
                    console.warn('HTMX swap target not connected to DOM, cancelling swap', event.detail);
                    event.detail.shouldSwap = false;
                    event.preventDefault();
                    return false;
                }
                
                // For innerHTML swaps, ensure target has a parent
                if (event.detail.swapStyle === 'innerHTML') {
                    if (!target.parentNode) {
                        console.warn('HTMX swap target has no parent, cancelling swap', event.detail);
                        event.detail.shouldSwap = false;
                        event.preventDefault();
                        return false;
                    }
                    // Additional check: ensure parent is connected
                    if (!target.parentNode.isConnected && typeof target.parentNode.isConnected !== 'undefined') {
                        console.warn('HTMX swap target parent not connected, cancelling swap', event.detail);
                        event.detail.shouldSwap = false;
                        event.preventDefault();
                        return false;
                    }
                }
            } catch (e) {
                console.error('Error in htmx:beforeSwap handler:', e, event.detail);
                event.detail.shouldSwap = false;
                event.preventDefault();
                return false;
            }
        }, true); // Use capture phase to catch early
        
        /**
         * HTMX Event Delegation: Watchlist Remove Button
         * 
         * Pattern: Event delegation for remove button clicks
         * - Prevents event bubbling to parent card (which would trigger analysis)
         * - Zero inline JavaScript in templates
         * 
         * Triggered by: Elements with .remove-ticker-btn class
         */
        document.body.addEventListener('click', function(event) {
            const removeBtn = event.target.closest('.remove-ticker-btn');
            if (removeBtn) {
                // Stop propagation to prevent triggering parent card's analysis click
                event.stopPropagation();
            }
        }, true); // Use capture phase to handle before other handlers
        
        // Handle out-of-band swaps - validate target elements exist before HTMX processes them
        // This intercepts responses that contain hx-swap-oob elements
        document.body.addEventListener('htmx:beforeProcessNode', function(event) {
            try {
                const node = event.detail.node;
                
                // Check if this is an hx-swap-oob element
                if (node && node.nodeType === 1 && node.hasAttribute && node.hasAttribute('hx-swap-oob')) {
                    const elementId = node.id;
                    const swapStyle = node.getAttribute('hx-swap-oob');
                    
                    if (!elementId) {
                        console.warn('HTMX swap-oob element has no ID, skipping', node);
                        // Remove the node to prevent HTMX from processing it
                        if (node.parentNode) {
                            node.parentNode.removeChild(node);
                        }
                        return;
                    }
                    
                    // Find the target element
                    const target = document.getElementById(elementId);
                    
                    if (!target) {
                        console.warn(`HTMX swap-oob target element #${elementId} not found, skipping swap`, {
                            swapStyle: swapStyle
                        });
                        // Remove the node to prevent HTMX from processing it
                        if (node.parentNode) {
                            node.parentNode.removeChild(node);
                        }
                        return;
                    }
                    
                    // Check if target is connected to DOM
                    if (!target.isConnected && typeof target.isConnected !== 'undefined') {
                        console.warn(`HTMX swap-oob target #${elementId} not connected to DOM, skipping swap`, {
                            swapStyle: swapStyle
                        });
                        if (node.parentNode) {
                            node.parentNode.removeChild(node);
                        }
                        return;
                    }
                    
                    // For swaps that need a parent (innerHTML, beforeend, afterend, etc.)
                    if (swapStyle && (swapStyle.includes('innerHTML') || swapStyle.includes('beforeend') || swapStyle.includes('afterend'))) {
                        if (!target.parentNode) {
                            console.warn(`HTMX swap-oob target #${elementId} has no parent, skipping swap`, {
                                swapStyle: swapStyle
                            });
                            if (node.parentNode) {
                                node.parentNode.removeChild(node);
                            }
                            return;
                        }
                        
                        // Ensure parent is connected
                        if (!target.parentNode.isConnected && typeof target.parentNode.isConnected !== 'undefined') {
                            console.warn(`HTMX swap-oob target #${elementId} parent not connected, skipping swap`, {
                                swapStyle: swapStyle
                            });
                            if (node.parentNode) {
                                node.parentNode.removeChild(node);
                            }
                            return;
                        }
                    }
                }
            } catch (e) {
                console.error('Error in htmx:beforeProcessNode handler for swap-oob:', e, event.detail);
                // Don't break HTMX processing, just log the error
            }
        }, true);
        
        // HTMX Best Practice: Handle HX-Trigger events for watchlist refresh
        document.body.addEventListener('refreshWatchlist', function(event) {
            const watchlistContent = document.getElementById('watchlist-content');
            if (watchlistContent && typeof htmx !== 'undefined') {
                // Trigger refresh - watchlist-content has hx-get="/api/watch-list" with hx-trigger="load"
                htmx.trigger(watchlistContent, 'load');
            }
        });
        
        // HTMX Best Practice: Handle HX-Trigger events for positions refresh
        // Positions list refreshes automatically via hx-trigger attribute
        
        // HTMX Best Practice: Handle strategy activation events
        document.body.addEventListener('strategyActivated', function(event) {
            // Strategy selector is already updated via hx-swap-oob
            // This event can be used for additional side effects if needed
        });
        
        // Catch HTMX syntax errors specifically
        document.body.addEventListener('htmx:syntax:error', function(event) {
            console.error('HTMX syntax error detected:', event.detail);
            // Prevent error from breaking the page
            event.preventDefault();
            event.stopPropagation();
            // Try to continue with the response even if scripts failed
            return false;
        }, true);
        
        // Also catch swap errors after they happen
        document.body.addEventListener('htmx:swapError', function(event) {
            console.error('HTMX swap error caught:', event.detail);
            // Prevent error from propagating and breaking the page
            event.preventDefault();
            event.stopPropagation();
            return false;
        }, true);
        
        // Catch any unhandled HTMX errors, especially insertBefore errors
        window.addEventListener('error', function(event) {
            // Check if this is an insertBefore error (common HTMX issue)
            if (event.message && (
                event.message.includes('insertBefore') || 
                event.message.includes('Cannot read properties of null') ||
                (event.message.includes('reading') && event.message.includes('insertBefore'))
            )) {
                // Check if error originated from HTMX
                const errorSource = event.filename || '';
                const stack = event.error?.stack || '';
                if (errorSource.includes('htmx') || stack.includes('htmx') || event.target?.tagName === 'SCRIPT') {
                    console.warn('Caught insertBefore error from HTMX, suppressing to prevent page break:', {
                        message: event.message,
                        filename: errorSource,
                        lineno: event.lineno,
                        colno: event.colno
                    });
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                }
            }
        }, true);
        
        // Also catch unhandled promise rejections that might be HTMX-related
        window.addEventListener('unhandledrejection', function(event) {
            const reason = event.reason?.message || String(event.reason || '');
            if (reason.includes('insertBefore') || reason.includes('Cannot read properties of null')) {
                console.warn('Caught unhandled promise rejection related to insertBefore, suppressing:', reason);
                event.preventDefault();
                return false;
            }
        });
        
        // Refresh Lucide icons after HTMX swaps
        document.body.addEventListener('htmx:afterSwap', function(event) {
            refreshLucideIcons();
            
            // Get Alpine.js app state if available
            if (typeof Alpine !== 'undefined' && Alpine.$data) {
                try {
                    const appState = Alpine.$data(document.body);
                    if (appState && appState.refreshLucideIcons) {
                        appState.refreshLucideIcons();
                    }
                } catch (e) {
                    // Fallback to global function if Alpine state not ready
                    refreshLucideIcons();
                }
            }
        });
        
        /**
         * HTMX Security Best Practice: Initialize toast notifications from data attributes
         * 
         * Instead of inline scripts in HTMX responses, we:
         * 1. Use data attributes to pass toast data safely
         * 2. Listen for htmx:afterSwap events
         * 3. Initialize Alpine.js components from data attributes
         * 
         * This prevents XSS attacks from malicious script injection in responses.
         */
        document.body.addEventListener('htmx:afterSwap', function(event) {
            try {
                // Find all newly swapped toast elements
                const swappedElement = event.detail.target;
                if (!swappedElement) return;
                
                // Check if swapped content contains toast elements
                const toastElements = swappedElement.querySelectorAll ? 
                    swappedElement.querySelectorAll('[data-toast-message]') : [];
                
                // Also check if the swapped element itself is a toast
                if (swappedElement.hasAttribute && swappedElement.hasAttribute('data-toast-message')) {
                    toastElements.push(swappedElement);
                }
                
                // Initialize Lucide icons for new toasts
                toastElements.forEach(function(toast) {
                    if (typeof lucide !== 'undefined') {
                        // Lucide icons will be initialized by Alpine.js x-data init()
                        // This is just a fallback
                        setTimeout(function() {
                            lucide.createIcons();
                        }, 10);
                    }
                });
            } catch (e) {
                console.error('Error initializing toasts after HTMX swap:', e);
            }
        });
        
        // Handle HTMX after request events
        // Account Manager Modal
        window.showAccountManager = function() {
            let accountModal = document.getElementById('account-manager-modal');
            if (!accountModal) {
                // Create modal if it doesn't exist
                const modalHTML = `
                    <dialog id="account-manager-modal" class="htmx-modal">
                        <div class="glass-panel rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-bold text-white font-heading">Alpaca Account Management</h2>
                                <button onclick="this.closest('dialog').close()" class="text-muted hover:text-white">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div id="alpaca-accounts-container" 
                                 hx-get="/api/alpaca-accounts"
                                 hx-trigger="load"
                                 hx-swap="innerHTML">
                                <div class="flex items-center justify-center py-8">
                                    <i data-lucide="loader-2" class="w-6 h-6 animate-spin text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </dialog>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                if (typeof lucide !== 'undefined') lucide.createIcons();
                accountModal = document.getElementById('account-manager-modal');
            }
            if (accountModal) {
                accountModal.showModal();
                // Trigger load if container exists
                const container = document.getElementById('alpaca-accounts-container');
                if (container) htmx.trigger(container, 'load');
            }
        };
        
        document.body.addEventListener('htmx:afterRequest', function(event) {
            // Refresh Alpine.js state if needed after HTMX requests
            // State updates happen automatically via Alpine.js reactivity
            getAlpineState();
        });
        
        // Handle buy form completion - update toast and switch tab
        document.body.addEventListener('htmx:afterSwap', function(event) {
            const form = event.detail.elt;
            if (!form || form.tagName !== 'FORM' || !form.id || !form.id.startsWith('buy-form-')) return;
            
            const xhr = event.detail.xhr;
            const status = xhr ? xhr.status : (event.detail.successful !== false ? 200 : 0);
            const buyingToastId = form.getAttribute('data-buying-toast-id');
            if (!buyingToastId) return;
            
            const buyingToast = document.getElementById(buyingToastId);
            if (!buyingToast) return;
            
            if (status >= 200 && status < 300) {
                // Update toast to BOUGHT
                buyingToast.className = buyingToast.className.replace('border-blue-500/30 bg-blue-500/10', 'border-green-500/30 bg-green-500/10');
                const symbol = form.getAttribute('data-symbol') || '';
                buyingToast.innerHTML = '<div class="flex items-start gap-3"><div class="flex-shrink-0 w-5 h-5 text-green-400"><i data-lucide="check-circle-2" class="w-5 h-5"></i></div><div class="flex-1"><div class="text-sm font-semibold text-white">BOUGHT ' + symbol.toUpperCase() + '</div></div><button class="text-gray-400 hover:text-white toast-close-btn"><i data-lucide="x" class="w-4 h-4"></i></button></div>';
                const closeBtn = buyingToast.querySelector('.toast-close-btn');
                if (closeBtn) {
                    closeBtn.onclick = function() {
                        const toast = this.closest('.toast');
                        if (toast) {
                            toast.classList.add('fade-out');
                            setTimeout(function() { if (toast.parentNode) toast.remove(); }, 300);
                        }
                    };
                }
                if (typeof lucide !== 'undefined') setTimeout(function() { lucide.createIcons(); }, 50);
                setTimeout(function() {
                    if (buyingToast && buyingToast.parentNode) {
                        buyingToast.classList.add('fade-out');
                        setTimeout(function() { if (buyingToast.parentNode) buyingToast.remove(); }, 300);
                    }
                }, 5000);
                
                // Switch to positions tab (pending orders now show there)
                try {
                    let appState = null;
                    if (document.body._x_dataStack && document.body._x_dataStack[0]) {
                        appState = document.body._x_dataStack[0];
                    } else if (typeof Alpine !== 'undefined' && Alpine.$data) {
                        appState = Alpine.$data(document.body);
                    }
                    if (appState && typeof appState.switchTab === 'function') {
                        appState.switchTab('positions-tab');
                    } else {
                        const positionsBtn = document.getElementById('tab-positions-btn');
                        if (positionsBtn) positionsBtn.click();
                    }
                } catch (e) {
                    // Fallback: switch to positions tab
                    const positionsBtn = document.getElementById('tab-positions-btn');
                    if (positionsBtn) positionsBtn.click();
                }
            } else {
                // Error - update toast
                buyingToast.className = buyingToast.className.replace('border-blue-500/30 bg-blue-500/10', 'border-red-500/30 bg-red-500/10');
                const symbol = form.getAttribute('data-symbol') || '';
                buyingToast.innerHTML = '<div class="flex items-start gap-3"><div class="flex-shrink-0 w-5 h-5 text-red-400"><i data-lucide="x-circle" class="w-5 h-5"></i></div><div class="flex-1"><div class="text-sm font-semibold text-white">Buy order failed for ' + symbol.toUpperCase() + '</div></div><button class="text-gray-400 hover:text-white toast-close-btn"><i data-lucide="x" class="w-4 h-4"></i></button></div>';
                const closeBtn = buyingToast.querySelector('.toast-close-btn');
                if (closeBtn) {
                    closeBtn.onclick = function() {
                        const toast = this.closest('.toast');
                        if (toast) {
                            toast.classList.add('fade-out');
                            setTimeout(function() { if (toast.parentNode) toast.remove(); }, 300);
                        }
                    };
                }
                if (typeof lucide !== 'undefined') setTimeout(function() { lucide.createIcons(); }, 50);
            }
        });
        
        // Close buy confirmation modal when purchase completes and enhance UX
        document.body.addEventListener('buyOrderPlaced', function(event) {
            // Extract data from event detail (passed via HX-Trigger JSON)
            const symbol = event.detail?.symbol || null;
            const isPending = event.detail?.isPending || false;
            const orderId = event.detail?.orderId || null;
            
            // Find and close any open buy confirmation modals
            const openBuyModals = document.querySelectorAll('dialog.htmx-modal[open][id^="buy-modal-"]');
            openBuyModals.forEach(function(modal) {
                if (typeof window.closeHtmxModal === 'function') {
                    window.closeHtmxModal(modal);
                } else if (modal) {
                    // Fallback if closeHtmxModal not available
                    modal.close();
                    document.body.style.overflow = '';
                }
            });
            
            // Smart UX: Show positions tab and highlight order/position
            if (symbol) {
                try {
                    // Get Alpine.js app state using existing helper function
                    const appState = typeof getAlpineState === 'function' ? getAlpineState() : null;
                    
                    // Always switch to positions tab (pending orders now show there)
                    if (appState && typeof appState.switchTab === 'function') {
                        appState.switchTab('positions-tab');
                    } else {
                        const positionsBtn = document.getElementById('tab-positions-btn');
                        if (positionsBtn) positionsBtn.click();
                    }
                    
                    // Highlight pending order or position after positions settle
                    setTimeout(function() {
                        let targetElement = null;
                        
                        if (isPending) {
                            // Try to find pending order by order ID first (most accurate)
                            if (orderId) {
                                const pendingOrders = document.querySelectorAll('[data-pending-order-id]');
                                for (let i = 0; i < pendingOrders.length; i++) {
                                    const id = pendingOrders[i].getAttribute('data-pending-order-id');
                                    if (id && id.startsWith(orderId.substring(0, 8))) {
                                        targetElement = pendingOrders[i];
                                        break;
                                    }
                                }
                            }
                            
                            // Fallback: find pending order by symbol
                            if (!targetElement) {
                                const pendingOrders = document.querySelectorAll('[data-pending-symbol="' + symbol + '"]');
                                if (pendingOrders.length > 0) {
                                    targetElement = pendingOrders[0];
                                }
                            }
                        } else {
                            // Order is filled: find position by symbol
                            const positions = document.querySelectorAll('[data-position-symbol="' + symbol + '"]');
                            if (positions.length > 0) {
                                targetElement = positions[0];
                            }
                        }
                        
                        if (targetElement) {
                            // Add highlight animation
                            targetElement.classList.add('highlight-transaction');
                            
                            // Scroll into view smoothly
                            targetElement.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                            
                            // Remove highlight class after animation completes
                            setTimeout(function() {
                                targetElement.classList.remove('highlight-transaction');
                            }, 2000);
                        }
                    }, 300);
                } catch (e) {
                    console.error('Error enhancing UX after purchase:', e);
                }
            }
        });
        
        // Handle HTMX response errors
        document.body.addEventListener('htmx:responseError', function(event) {
            // Show error toast via Alpine.js if available
            const appState = getAlpineState();
            if (appState?.showToast) {
                appState.showToast('Request failed. Please try again.', 'error', 5000);
            }
        });
        
        // Handle HTMX swap errors
        document.body.addEventListener('htmx:swapError', function(event) {
            console.error('HTMX swap error:', event.detail);
            const appState = getAlpineState();
            if (appState?.showToast) {
                appState.showToast('Failed to update content. Please refresh the page.', 'error', 5000);
            }
        });
        
        // Handle HTMX timeout events - swap in timeout error template
        document.body.addEventListener('htmx:timeout', function(event) {
            const elt = event.detail.elt;
            const target = event.detail.target;
            
            // Only handle timeouts for elements marked with data-timeout-error
            if (elt && elt.hasAttribute && elt.hasAttribute('data-timeout-error') && target) {
                // Fetch timeout error template from server
                fetch('/api/timeout-error')
                    .then(response => response.text())
                    .then(html => {
                        // Swap in the timeout error template
                        target.innerHTML = html;
                        // Initialize Lucide icons
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    })
                    .catch(error => {
                        console.error('Failed to load timeout error template:', error);
                        // Fallback error message
                        target.innerHTML = '<div class="glass rounded-lg p-4 border border-red-500/30 bg-red-500/10"><div class="flex items-center gap-2 text-red-400 mb-2"><i data-lucide="alert-circle" class="w-5 h-5"></i><span class="font-semibold">Analysis Timed Out</span></div><p class="text-sm text-gray-300">The AI analysis took too long. Please try again.</p></div>';
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    });
            }
        });
        
        // Initialize Lucide Icons on page load
        // Set up on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshLucideIcons();
        });
        
        // Handle buy form submit - close modal and show BUYING toast
        window.handleBuySubmit = function(event, symbolLower, symbol) {
            // Find modal
            const modalId = 'buy-modal-' + symbolLower;
            let modal = document.getElementById(modalId);
            if (!modal) {
                const modalContainer = document.getElementById('modal-container');
                if (modalContainer) {
                    modal = modalContainer.querySelector('dialog.htmx-modal');
                }
            }
            
            // Clean up Alpine.js before closing modal to prevent transition errors
            if (modal && modal.tagName === 'DIALOG' && modal.open) {
                // Clean up Alpine.js components in modal before closing
                if (typeof window.cleanupAlpineElement === 'function') {
                    window.cleanupAlpineElement(modal);
                }
                
                // Close modal
                modal.close();
                document.body.style.overflow = '';
            }
            
            // Show BUYING toast
            const toastContainer = document.getElementById('toast-container');
            if (toastContainer) {
                const existingToast = toastContainer.querySelector('[data-buying-symbol="' + symbolLower + '"]');
                if (existingToast) existingToast.remove();
                
                const buyingToast = document.createElement('div');
                buyingToast.id = 'buying-toast-' + symbolLower + '-' + Date.now();
                buyingToast.setAttribute('data-buying-symbol', symbolLower);
                buyingToast.className = 'toast glass rounded-lg p-4 border pointer-events-auto shadow-lg min-w-[300px] max-w-[400px] border-blue-500/30 bg-blue-500/10 animate-fade-in';
                buyingToast.innerHTML = '<div class="flex items-start gap-3"><div class="flex-shrink-0 w-5 h-5 text-blue-400"><i data-lucide="loader-2" class="w-5 h-5 lucide-spin"></i></div><div class="flex-1"><div class="text-sm font-semibold text-white">BUYING ' + symbol + '....</div></div></div>';
                toastContainer.appendChild(buyingToast);
                
                if (typeof lucide !== 'undefined') {
                    setTimeout(function() { lucide.createIcons(); }, 50);
                }
                
                const form = event.target.closest('form');
                if (form) {
                    form.setAttribute('data-buying-toast-id', buyingToast.id);
                }
            }
        };
    </script>

    <!-- Premium Navigation with Mouse Tracking Micro-Interactions -->
    <script>
        (function() {
            'use strict';
            
            const nav = document.querySelector('nav');
            const navPanel = nav?.querySelector('.nav-glass-morph');
            if (!nav || !navPanel) return;
            
            let mouseX = 0;
            let mouseY = 0;
            let rafId = null;
            
            // Smooth mouse tracking with requestAnimationFrame
            function updateMousePosition() {
                const navRect = navPanel.getBoundingClientRect();
                const relativeX = ((mouseX - navRect.left) / navRect.width - 0.5) * 100;
                const relativeY = ((mouseY - navRect.top) / navRect.height - 0.5) * 100;
                
                navPanel.style.setProperty('--nav-mouse-x', relativeX + '%');
                navPanel.style.setProperty('--nav-mouse-y', relativeY + '%');
                
                rafId = null;
            }
            
            // Mouse move handler with throttling
            document.addEventListener('mousemove', function(e) {
                mouseX = e.clientX;
                mouseY = e.clientY;
                
                if (!rafId) {
                    rafId = requestAnimationFrame(updateMousePosition);
                }
            }, { passive: true });
            
            // Reset mouse position when leaving nav
            navPanel.addEventListener('mouseleave', function() {
                navPanel.style.setProperty('--nav-mouse-x', '0%');
                navPanel.style.setProperty('--nav-mouse-y', '0%');
            });
            
            // Add entrance animation
            navPanel.style.opacity = '0';
            navPanel.style.transform = 'translateY(-10px)';
            
            requestAnimationFrame(() => {
                navPanel.style.transition = 'opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                navPanel.style.opacity = '1';
                navPanel.style.transform = 'translateY(0)';
            });
            
        })();
    </script>

</body>
</html>

